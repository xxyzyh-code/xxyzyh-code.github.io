<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
    <div id="player-controls" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
        
        <div id="nav-main-group" style="display: flex; justify-content: center; align-items: center; gap: 15px;">
            <span id="prev-button" onclick="playPreviousTrack()" style="cursor: pointer; font-size: 1.2em;">
                âª ä¸Šä¸€æ›²
            </span>
            <span id="mode-button" onclick="togglePlayMode()" style="cursor: pointer;">
                [ æ¨¡å¼: é †åº ]
            </span>
            <span id="next-button" onclick="playNextTrack()" style="cursor: pointer; font-size: 1.2em;">
                ä¸‹ä¸€æ›² â©
            </span>
        </div>
        
        <div id="mode-switcher-group" style="display: flex; justify-content: center; margin-top: 5px;">
            <div id="data-mode-switcher">
                <button id="data-mode-toggle-btn" onclick="toggleDataMode()" style="cursor: pointer;">
                    æ•¸æ“šæ¨¡å¼: <span id="current-data-mode">[æœ¬åœ°çµ±è¨ˆ]</span>
                </button>
            </div>
        </div>

        <div id="aux-controls-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
            
            <div id="theme-switcher" style="position: relative;">
                <button id="theme-toggle-btn" style="cursor: pointer;">
                    ä¸»é¡Œï¼š<span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>
                </button>
                <div id="theme-menu" class="hidden-menu" style="position: absolute; z-index: 10; left: 0;">
                    <span class="theme-option" data-theme="light">ç™½è‰²</span>
                    <span class="theme-option" data-theme="dark">é»‘è‰²</span>
                    <span class="theme-option" data-theme="grey">ç°è‰²</span>
                    <span class="theme-option" data-theme="blue">è—è‰²</span>
                    <span class="theme-option" data-theme="green">ç¶ è‰²</span>
                    <span class="theme-option" data-theme="purple">ç´«è‰²</span>
                    <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
                    <span class="theme-option" data-theme="yellow">é»„è‰²</span>
                    <span class="theme-option" data-theme="red">ç´…è‰²</span>
                </div>
            </div>
            
            <div id="sleep-timer-area" style="position: relative;">
                <button id="timer-toggle-btn" onclick="toggleTimerMenu()" style="cursor: pointer;">
                    å®šæ™‚ (æœªè¨­å®š)
                </button>
                
                <div id="timer-menu" class="hidden-menu" style="position: absolute; z-index: 10; right: 0;">
                    <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
                    <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
                    <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
                    <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
                </div>
            </div>
        </div>
        
    </div> 
    <div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>
<ul id="playlist">
    {% for track in site.data.music %}
        <li onclick="loadTrack({{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
    
</div>
<script>
    // â­ï¸ é—œéµä¿®æ­£ 1: ä½¿ç”¨ Liquid å°‡æ•¸æ“šå‚³éçµ¦ JavaScript
// æ³¨æ„: `trackDataArray` ç¾åœ¨æ˜¯ä¸€å€‹å…¨å±€å¯ç”¨çš„ JS è®Šé‡
const trackDataArray = {{ site.data.music | jsonify }}; 
// ------------------------------------
// â­ï¸ é—œéµï¼šSupabase API é…ç½® (ä½¿ç”¨æ‚¨æä¾›çš„ Key)
// ------------------------------------
const SUPABASE_URL = 'https://dpflzangmwahuwyevegp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZmx6YW5nbXdhaHV3eWV2ZWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0Mjc0NDYsImV4cCI6MjA3ODAwMzQ0Nn0.bydLBJIGqHcEKDhmw4E7zEqxFxymieS7GlLjL9Zyr90';
const GLOBAL_STATS_TABLE = 'play_logs'; // æ‚¨çš„è¡¨å

// ------------------------------------
// ç²å– DOM å…ƒç´ 
// ------------------------------------
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
let playlistItems = document.querySelectorAll('#playlist li'); 
const modeButton = document.getElementById('mode-button'); 
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');
const playlistSearchInput = document.getElementById('playlist-search'); 
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const themeMenu = document.getElementById('theme-menu');
const currentThemeName = document.getElementById('current-theme-name');
const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
    
    
// ------------------------------------
// 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
// ------------------------------------
// â­ï¸ ä¿®æ­£ï¼šç¢ºä¿ MASTER_TRACK_LIST ä½¿ç”¨åœ¨ HTML é ‚éƒ¨å®šç¾©çš„ trackDataArray
const MASTER_TRACK_LIST = (function() {
    // æª¢æŸ¥ trackDataArray æ˜¯å¦å­˜åœ¨ (å®ƒæ‡‰è©²åœ¨ä¸Šé¢çš„ <script> å¡Šä¸­è¢« Liquid å®šç¾©)
    if (typeof trackDataArray === 'undefined' || trackDataArray.length === 0) {
        console.error("éŒ¯èª¤: trackDataArray (site.data.music) æ•¸æ“šæœªæ‰¾åˆ°æˆ–ç‚ºç©ºã€‚");
        return [];
    }
    return trackDataArray.map((track, index) => ({
        // ç¢ºä¿æ¯å€‹æ­Œæ›²ç‰©ä»¶éƒ½æœ‰ä¸€å€‹å”¯ä¸€çš„ 'id' æ¬„ä½ï¼Œèˆ‡ Supabase çš„ 'song id' å°æ‡‰
        // å¦‚æœæ‚¨çš„æ•¸æ“šä¸­æ²’æœ‰ï¼Œå‰‡é€™è£¡ä½¿ç”¨ 's' + index ä½œç‚º fallback ID
        id: track.id || `s${index}`, 
        title: track.title,
        artist: track.artist,
        url: track.url,
        originalIndex: index 
    }));
})(); 

let currentPlaylist = []; 
let currentTrackIndex = 0; 
let playMode = 0; 
let sleepTimerId = null; 
let sleepTime = 0; 
let endTime = 0; 
let countdownIntervalId = null; 
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; 

const PLAY_COUNT_STORAGE_KEY = 'audioTrackPlayCounts'; 
let trackPlayCounts = {}; 
let dataMode = 'local';
const DATA_MODE_STORAGE_KEY = 'audioPlayerDataMode';
// â­ï¸ é—œéµï¼šå„²å­˜å¾ API ç²å–çš„å…¨çƒæ’­æ”¾æ¬¡æ•¸
let globalTrackPlayCounts = {}; 

// --- *** Supabase/API ç›¸é—œå‡½æ•¸ *** ---

// 1. ç²å–æˆ–ç”Ÿæˆå”¯ä¸€çš„åŒ¿åç”¨æˆ¶ ID
function getUserId() {
  let id = localStorage.getItem('anon_user_id');
  if (!id) {
    id = crypto.randomUUID(); 
    localStorage.setItem('anon_user_id', id);
  }
  return id;
}

// 2. å‘ Serverless API ç™¼é€æ’­æ”¾æ—¥èªŒ
function trackPlayToDatabase(song_id) {
    if (typeof song_id === 'undefined' || song_id === null) {
        console.warn("trackPlayToDatabase: Song ID ç„¡æ•ˆï¼Œè·³éæ•¸æ“šåº«è¨˜éŒ„ã€‚");
        return;
    }
    
    const user_id = getUserId(); 
    
    // â­ï¸ æ ¸å¿ƒä¿®æ”¹ A: æ‰¾åˆ°ç•¶å‰æ’­æ”¾æ­Œæ›²çš„ title
    const currentTrack = currentPlaylist[currentTrackIndex];
    const song_title = currentTrack ? currentTrack.title : 'æœªçŸ¥æ­Œæ›²'; // ç²å– title
    
    // é€™è£¡ä½¿ç”¨ song_id æœ¬èº«ï¼ˆå³ MASTER_TRACK_LIST ä¸­çš„ track.id æˆ– sXï¼‰
    fetch('/api/track', { 
        method: 'POST',
        body: JSON.stringify({
            user_id: user_id,
            song_id: song_id,
            // â­ï¸ æ ¸å¿ƒä¿®æ”¹ B: å°‡ title å‚³éçµ¦ API
            title: song_title 
        }),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        if (!response.ok) {
            // æ‰“å°éŸ¿æ‡‰ç‹€æ…‹ï¼Œæœ‰åŠ©æ–¼èª¿è©¦
            console.error(`æ’­æ”¾è¨˜éŒ„ç™¼é€å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .catch(error => {
        console.error('æ’­æ”¾è¨˜éŒ„ç™¼é€å¤±æ•—:', error);
    });
}

// ------------------------------------
// â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šç²å–å…¨çƒæ’­æ”¾æ•¸æ“šçš„ç•°æ­¥å‡½æ•¸ (ç¾åœ¨æ˜¯èª¿ç”¨æ‚¨çš„ /api/stats.js)
// ------------------------------------
async function fetchGlobalPlayCounts() {
    // 1. UI é¡¯ç¤ºè¼‰å…¥ä¸­
    document.getElementById('current-data-mode').textContent = '[è¼‰å…¥ä¸­...]';

    const BASE_URL = window.location.origin;
    const apiEndpoint = `${BASE_URL}/api/stats`;
    
    try {
        const response = await fetch(apiEndpoint, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json' 
            }
        });
        
        // --- ä¿®æ­£å€åŸŸ START ---
        if (!response.ok) {
            // å˜—è©¦è§£æéŒ¯èª¤ä¿¡æ¯
            let errorMessage = `API éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}.`;
            try {
                const errorBody = await response.json();
                if (errorBody && errorBody.message) {
                    errorMessage += ` è©³æƒ…: ${errorBody.message}`;
                } else if (errorBody.error) {
                    errorMessage += ` è©³æƒ…: ${errorBody.error}`;
                }
            } catch (e) {
                // å¦‚æœç„¡æ³•è§£æ JSON (ä¾‹å¦‚ Vercel è¿”å›äº† HTML 404 é é¢)
                errorMessage += ` å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤æˆ–ç‚ºéœæ…‹é é¢ã€‚`;
            }
            
            // çµ±ä¸€æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ catch è™•ç†å½ˆçª—
            throw new Error(errorMessage);
        }
        // --- ä¿®æ­£å€åŸŸ END ---
        
        const globalStats = await response.json();
        return globalStats;
        
    } catch (error) {
        console.error('ç²å–å…¨çƒæ’­æ”¾æ¬¡æ•¸å¤±æ•—:', error);
        
        // å½ˆçª—é¡¯ç¤ºæ›´ç²¾ç¢ºçš„éŒ¯èª¤ä¿¡æ¯
        alert(`ç„¡æ³•è¼‰å…¥å…¨çƒçµ±è¨ˆæ•¸æ“šã€‚éŒ¯èª¤: ${error.message}ã€‚å·²è‡ªå‹•åˆ‡æ›åˆ°æœ¬åœ°æ¨¡å¼ã€‚`);
        
        // â­ï¸ é—œéµä¿®æ­£ï¼šåˆ‡æ›å›æœ¬åœ°æ¨¡å¼ä¸¦æ›´æ–° UI
        dataMode = 'local';
        updateDataModeUI(); 
        saveSettings();
        
        return {}; // å¤±æ•—æ™‚è¿”å›ç©ºå°è±¡
    }
}

// --- *** é˜²æŠ–è¼”åŠ©å‡½æ•¸ *** ---
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}

// --- *** æ­Œå–®é‡ç½®èˆ‡åˆå§‹åŒ– *** ---
function resetCurrentPlaylist() {
    currentPlaylist = [...MASTER_TRACK_LIST]; 
}

// --- è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š) ---
function playTrack(index) {
    // ... (ä¿æŒä¸è®Š) ...
    if (index >= 0 && index < currentPlaylist.length) { 
        currentTrackIndex = index;
        const track = currentPlaylist[index]; 
        audio.src = track.url;
        playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
        audio.play().catch(error => {
            console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
        });
        updatePlaylistHighlight();
    } else if (index === currentPlaylist.length) { 
        audio.pause(); 
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    }
}
// ... (getNextRandomIndex, playNextTrack, playPreviousTrack ä¿æŒä¸è®Š) ...
function getNextRandomIndex() {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * currentPlaylist.length); 
    } while (newIndex === currentTrackIndex && currentPlaylist.length > 1);
    
    return newIndex;
}
function playNextTrack() {
    if (currentPlaylist.length === 0) return;
    
    let nextIndex;
    
    if (playMode === 1) { 
        nextIndex = currentTrackIndex; 
    } else if (playMode === 2) { 
        nextIndex = getNextRandomIndex();
    } else { 
        if (currentTrackIndex < currentPlaylist.length - 1) {
            nextIndex = currentTrackIndex + 1;
        } else if (playMode === 4) { 
            nextIndex = 0; 
        } else { 
            audio.pause();
            playerTitle.textContent = "å·²åˆ°é”åˆ—è¡¨æœ«å°¾ã€‚";
            currentTrackIndex = currentPlaylist.length; 
            updatePlaylistHighlight();
            return;
        }
    }
    
    playTrack(nextIndex);
}
function playPreviousTrack() {
    if (currentPlaylist.length === 0) return;
    let prevIndex;
    
    if (playMode === 1) { 
        prevIndex = currentTrackIndex; 
    } else if (playMode === 2) { 
        prevIndex = getNextRandomIndex();
    } else { 
        if (currentTrackIndex > 0) {
            prevIndex = currentTrackIndex - 1;
        } else if (playMode === 4) { 
            prevIndex = currentPlaylist.length - 1; 
        } else { 
            audio.pause();
            playerTitle.textContent = "å·²åˆ°é”åˆ—è¡¨é–‹é ­ã€‚";
            currentTrackIndex = -1;
            updatePlaylistHighlight();
            return;
        }
    }
    
    playTrack(prevIndex);
}
function updatePlaylistHighlight(manualScroll = false) {
    const listItems = document.querySelectorAll('#playlist li');
    
    listItems.forEach(item => {
        item.classList.remove('playing');
    });
    
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        const playingTrackOriginalIndex = currentPlaylist[currentTrackIndex].originalIndex;
        
        const playingItem = Array.from(listItems).find(item => {
            const onclickAttr = item.getAttribute('onclick');
            const match = onclickAttr.match(/loadTrack\((\d+)\)/);
            return match && parseInt(match[1]) === playingTrackOriginalIndex;
        });
        if (playingItem) {
            playingItem.classList.add('playing');
            
            if (!manualScroll) {
                 playingItem.scrollIntoView({
                    behavior: 'smooth', 
                    block: 'nearest'    
                });
            }
        }
    }
}
// --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± (ä¿æŒä¸è®Š) ---
audio.addEventListener('ended', () => {
    incrementPlayCount(); 
    updatePlaylistDisplay(); 
    sortPlaylistByPlayCount(); 
    saveSettings(); 
    
    let nextIndex; 
    if (playMode === 1) { 
        audio.currentTime = 0; 
        audio.play();
        updatePlaylistHighlight(); 
        return; 
    } 
    
    if (playMode === 3) { 
        audio.pause();
        playerTitle.textContent = "è‡ªç”±æ¨¡å¼ä¸‹ï¼Œæ­Œæ›²æ’­æ”¾å®Œç•¢ã€‚";
        currentTrackIndex = -1; 
        updatePlaylistHighlight(); 
        window.location.hash = ''; 
        return; 
    } 
    
    if (playMode === 2) { 
        nextIndex = getNextRandomIndex();
    } else if (playMode === 4) { 
        nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
    } else { 
        if (currentTrackIndex < currentPlaylist.length - 1) { 
            nextIndex = currentTrackIndex + 1;
        } else {
            audio.pause();
            playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
            currentTrackIndex = -1; 
            updatePlaylistHighlight(); 
            window.location.hash = ''; 
            return; 
        }
    }
    if (nextIndex !== undefined && nextIndex !== -1) {
        playTrack(nextIndex);
        window.location.hash = `song-index-${currentPlaylist[nextIndex].originalIndex}`;
    }
});
// æ¨¡å¼åˆ‡æ›å‡½æ•¸ (ä¿æŒä¸è®Š)
function togglePlayMode() {
    playMode = (playMode + 1) % 5; 
    
    updateModeUI();
    
    playerTitle.textContent = `å·²åˆ‡æ›åˆ° ${modeButton.textContent.replace('[ æ¨¡å¼: ', '').replace(' ]', '')}`;
    saveSettings(); 
}
// â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šåˆ‡æ›æ•¸æ“šæ¨¡å¼å‡½æ•¸ (ç•°æ­¥è™•ç†æ•¸æ“šç²å–)
async function toggleDataMode() {
    dataMode = (dataMode === 'local') ? 'global' : 'local';
    
    updateDataModeUI();
    saveSettings(); 
    
    playerTitle.textContent = `æ•¸æ“šæ¨¡å¼å·²åˆ‡æ›ç‚ºï¼š${(dataMode === 'global' ? 'å…¨çƒçµ±è¨ˆ' : 'æœ¬åœ°çµ±è¨ˆ')}`;
    
    // é—œéµï¼šåœ¨æ‰‹å‹•åˆ‡æ›æ™‚ï¼Œå¼·åˆ¶ç•°æ­¥é‡æ–°åˆå§‹åŒ–æ’­æ”¾å™¨
    await initializePlayer(true); 
}
// â­ï¸ ä¿®æ­£ï¼šçµ±ä¸€æ›´æ–°æ•¸æ“šæ¨¡å¼ UI (åŒ…å«è¼‰å…¥ç‹€æ…‹)
function updateDataModeUI() {
    const modeSpan = document.getElementById('current-data-mode');
    if (dataMode === 'global') {
        modeSpan.textContent = "[å…¨çƒçµ±è¨ˆ]";
        modeSpan.style.color = 'red'; 
    } else {
        modeSpan.textContent = "[æœ¬åœ°çµ±è¨ˆ]";
        modeSpan.style.color = '';
    }
}
// çµ±ä¸€æ›´æ–°æ¨¡å¼ UI çš„å‡½æ•¸ (ä¿æŒä¸è®Š)
function updateModeUI() {
    let modeText;
    
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å–®æ›²å¾ªç’° ]";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
    } else if (playMode === 4) {
        modeText = "[ æ¨¡å¼: é †åºå¾ªç’° ]"; 
    } else {
        modeText = "[ æ¨¡å¼: é †åºåœæ­¢ ]"; 
    }
    
    modeButton.textContent = modeText;
}

// --- *** ä¸»é¡Œåˆ‡æ›é‚è¼¯ (ä¿æŒä¸è®Š) *** ---
const THEME_STORAGE_KEY = 'userThemePreference';
const LIGHT_THEME = 'light'; 
const DARK_THEME = 'dark';   
const GREY_THEME = 'grey';   
const BLUE_THEME = 'blue';
const GREEN_THEME = 'green';
const PURPLE_THEME = 'purple';
const PINK_THEME = 'pink';
const YELLOW_THEME = 'yellow';
const RED_THEME = 'red';
    
function applyTheme(desiredTheme, isManual = false) {
    const body = document.body;
    let displayName = '';
    
    // ... (ä¸»é¡Œé¡è‰²é‚è¼¯ä¿æŒä¸è®Š) ...
    body.classList.remove(
        DARK_THEME + '-theme', 
        GREY_THEME + '-theme',
        BLUE_THEME + '-theme',
        GREEN_THEME + '-theme',
        PURPLE_THEME + '-theme', 
        PINK_THEME + '-theme',  
        YELLOW_THEME + '-theme',
        RED_THEME + '-theme'     
    );
    let themeToApply = desiredTheme;
    let modeText = 'ã€æ‰‹å‹•ã€‘';
    if (isManual) {
        localStorage.setItem(THEME_STORAGE_KEY, desiredTheme);
    } 
    else if (desiredTheme === LIGHT_THEME) {
        themeToApply = getSystemThemeBasedOnTime();
        modeText = 'ã€è‡ªå‹•ã€‘';
    }
    if (themeToApply === DARK_THEME) {
        body.classList.add(DARK_THEME + '-theme');
        displayName = 'é»‘è‰²';
    } else if (themeToApply === GREY_THEME) {
        body.classList.add(GREY_THEME + '-theme');
        displayName = 'ç°è‰²';
    } else if (themeToApply === BLUE_THEME) {
        body.classList.add(BLUE_THEME + '-theme');
        displayName = 'è—è‰²';
    } else if (themeToApply === GREEN_THEME) {
        body.classList.add(GREEN_THEME + '-theme');
        displayName = 'ç¶ è‰²';
    } else if (themeToApply === PURPLE_THEME) { 
        body.classList.add(PURPLE_THEME + '-theme');
        displayName = 'ç´«è‰²';
    } else if (themeToApply === PINK_THEME) { 
        body.classList.add(PINK_THEME + '-theme');
        displayName = 'ç²‰è‰²';
    } else if (themeToApply === YELLOW_THEME) { 
        body.classList.add(YELLOW_THEME + '-theme');
        displayName = 'é»ƒè‰²';
    } else if (themeToApply === RED_THEME) { 
        body.classList.add(RED_THEME + '-theme');
        displayName = 'ç´…è‰²';
    } else { 
        displayName = 'ç™½è‰²';
    }
    
    currentThemeName.textContent = `${displayName} ${modeText}`;
}
function getSystemThemeBasedOnTime() {
    const hour = new Date().getHours();
    return (hour >= 19 || hour < 7) ? DARK_THEME : LIGHT_THEME;
}
function initializeTheme() {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme) {
        if (storedTheme === LIGHT_THEME) {
             applyTheme(LIGHT_THEME, false); 
        } else {
             applyTheme(storedTheme, true); 
        }
    } else {
        applyTheme(LIGHT_THEME, false);
    }
}
// --- ä¸»é¡Œ/å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ ---
// â­ï¸ ä¿®æ­£ Aï¼šç§»é™¤ stopPropagationï¼Œä¸¦åœ¨é»æ“Šä¸»é¡ŒæŒ‰éˆ•æ™‚é—œé–‰å®šæ™‚å™¨èœå–®
themeToggleBtn.addEventListener('click', () => {
    themeMenu.classList.toggle('hidden-menu');
    
    // ç¢ºä¿å®šæ™‚å™¨èœå–®é—œé–‰
    if (!timerMenu.classList.contains('hidden-menu')) {
        timerMenu.classList.add('hidden-menu');
    }
});
themeOptions.forEach(option => {
    option.addEventListener('click', (e) => {
        const selectedTheme = e.target.getAttribute('data-theme');
        applyTheme(selectedTheme, true); 
        themeMenu.classList.add('hidden-menu'); 
    });
});
// â­ï¸ ä¿®æ­£ Cï¼šç°¡åŒ–å’Œçµ±ä¸€å…¨å±€é»æ“Šç›£è½å™¨
document.addEventListener('click', (e) => {
    const target = e.target;

    // 1. è™•ç†ä¸»é¡Œèœå–®çš„å¤–éƒ¨é»æ“Šé—œé–‰
    // å¦‚æœé»æ“Šç›®æ¨™ä¸åœ¨ä¸»é¡Œèœå–®å…§ï¼Œä¹Ÿä¸åœ¨ä¸»é¡ŒæŒ‰éˆ•ä¸Šï¼Œå‰‡é—œé–‰èœå–®
    if (!themeMenu.contains(target) && !themeToggleBtn.contains(target)) {
        themeMenu.classList.add('hidden-menu');
    }

    // 2. è™•ç†å®šæ™‚å™¨èœå–®çš„å¤–éƒ¨é»æ“Šé—œé–‰
    // å¦‚æœé»æ“Šç›®æ¨™ä¸åœ¨å®šæ™‚å™¨èœå–®å…§ï¼Œä¹Ÿä¸åœ¨å®šæ™‚å™¨æŒ‰éˆ•ä¸Šï¼Œå‰‡é—œé–‰èœå–®
    if (!timerMenu.contains(target) && !timerToggleButton.contains(target)) {
        timerMenu.classList.add('hidden-menu');
    }
});
setInterval(() => {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme === LIGHT_THEME) {
        applyTheme(LIGHT_THEME, false); 
    }
}, 1000 * 60 * 60); 
    
// â­ï¸ ä¿®æ­£ Bï¼šåœ¨é»æ“Šå®šæ™‚å™¨æŒ‰éˆ•æ™‚æ˜ç¢ºé—œé–‰ä¸»é¡Œèœå–®
function toggleTimerMenu() {
    timerMenu.classList.toggle('hidden-menu');
    
    // ç¢ºä¿ä¸»é¡Œèœå–®é—œé–‰
    if (!themeMenu.classList.contains('hidden-menu')) {
        themeMenu.classList.add('hidden-menu');
    }
}
// â­ï¸ ä¿®æ­£ Dï¼š setSleepTimer å‡½æ•¸ (ç§»é™¤ setTimeout è£¡çš„ clearSleepTimer)
function setSleepTimer(minutes) {
    clearSleepTimer();
    toggleTimerMenu(); 
    
    const delayMilliseconds = minutes * 60 * 1000;
    
    sleepTime = minutes * 60;
    endTime = Date.now() + delayMilliseconds;
    
    // é—œéµä¿®æ­£ï¼šsetTimeout åªéœ€è¦åŸ·è¡Œ audio.pause() å’Œè¨Šæ¯æ›´æ–°
    sleepTimerId = setTimeout(() => {
        // åƒ…æš«åœï¼Œè®“ updateTimerCountdown è™•ç†æ¸…ç†é‚è¼¯
        audio.pause(); 
        playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾ (${minutes} åˆ†é˜)`;
    }, delayMilliseconds);
    
    countdownIntervalId = setInterval(updateTimerCountdown, 1000);
    timerToggleButton.textContent = `å®šæ™‚ (${minutes} åˆ†é˜)`;
    playerTitle.textContent = `å®šæ™‚å™¨å·²è¨­ç½®ï¼š${minutes} åˆ†é˜å¾Œè‡ªå‹•é—œé–‰`;
    if (audio.paused) {
        audio.play();
    }
}

function clearSleepTimer() {
    // ... (æ¸…é™¤å®šæ™‚å™¨é‚è¼¯ä¿æŒä¸è®Š) ...
    if (sleepTimerId !== null) {
        clearTimeout(sleepTimerId);
        sleepTimerId = null;
    }
    if (countdownIntervalId !== null) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
    }
    
    sleepTime = 0;
    endTime = 0;
    timerToggleButton.textContent = "å®šæ™‚ (æœªè¨­å®š)";
    remainingTimerSpan.textContent = "--:--";
    playerTitle.textContent = "å·²å–æ¶ˆå®šæ™‚å™¨";
}
// â­ï¸ ä¿®æ­£ Eï¼š updateTimerCountdown å‡½æ•¸ (åˆ°æœŸæ™‚åŸ·è¡Œ clearSleepTimer)
function updateTimerCountdown() {
    // ... (æ›´æ–°å®šæ™‚å™¨å€’æ•¸é‚è¼¯ä¿æŒä¸è®Š) ...
    if (endTime > 0) {
        const remainingMs = endTime - Date.now();
        const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
        
        const minutes = Math.floor(remainingS / 60);
        const seconds = remainingS % 60;
        
        remainingTimerSpan.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        if (remainingS === 0) {
            // çµ±ä¸€åœ¨é€™è£¡åŸ·è¡Œæ¸…ç†ï¼Œé˜²æ­¢é‡è¤‡
            clearSleepTimer(); 
            if (!audio.paused) {
                 audio.pause();
                 playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾`;
            }
        }
    }
}

let totalListenMinutes = 0;
let totalListenSeconds = 0; // ç¨‹å¼å¤¥ä¼´: æ–°å¢æ­¤è®Šæ•¸ä¾†è¿½è¹¤æœ¬æ¬¡æ’­æ”¾æ™‚é–“ (ç§’)
let listenIntervalId = null; 
    
audio.addEventListener('play', () => {
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
});
audio.addEventListener('pause', () => {
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
});
function updateTotalListenTime() {
    totalListenSeconds++;
    
    // ç¨‹å¼å¤¥ä¼´: æ ¸å¿ƒéŸ³æ¨‚è¨ˆåˆ†é‚è¼¯
    if (totalListenSeconds % 60 === 0) {
        // æ¯ 60 ç§’ (1 åˆ†é˜) å‘¼å«ä¸€æ¬¡è¨ˆåˆ†
        if (typeof window.addMusicScore === 'function') {
            window.addMusicScore();
        }
        totalListenMinutes++;
    }
    
    // ä¿®æ­£: ä¿æŒåŸå§‹é‚è¼¯ï¼Œåªé¡¯ç¤ºåˆ†é˜æ•¸ (ä¸å½±éŸ¿è¨ˆåˆ†)
    totalListenTimeSpan.textContent = 
        `${totalListenMinutes} åˆ†é˜ ${totalListenSeconds % 60} ç§’`;
}

// æ’­æ”¾æ¬¡æ•¸è¿½è¹¤å‡½æ•¸
function incrementPlayCount() {
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        const track = currentPlaylist[currentTrackIndex];
        const key = track.originalIndex; 
        
        trackPlayCounts[key] = (trackPlayCounts[key] || 0) + 1; 
        
        try {
            localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
        } catch (e) {
            console.warn('ç„¡æ³•å„²å­˜æ’­æ”¾æ¬¡æ•¸åˆ° LocalStorage.', e);
        }
        
        if (typeof gtag === 'function') {
            gtag('event', 'song_played', {
                'song_index': key,           
                'song_title': track.title    
            });
            console.log(`GA4 äº‹ä»¶ç™¼é€æˆåŠŸ: song_played, æ­Œæ›²ID: ${key}, æ¨™é¡Œ: ${track.title}`);
        } 
    }
}
    
// --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ä¾†è‡ªåˆ—è¡¨é»æ“Š) ---
// â­ï¸ ä¿®æ­£ Aï¼šå„ªåŒ– loadTrack å‡½æ•¸ (ç§»é™¤å¯èƒ½å°è‡´ç‹€æ…‹ä¸ä¸€è‡´çš„å‚™ç”¨é‚è¼¯)
/**
 * @param {number} originalIndex - æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
 */
function loadTrack(originalIndex) { 
    
    // 1. ç¢ºä¿æ’­æ”¾åˆ—è¡¨æ˜¯å®Œæ•´çš„ï¼ˆå¦‚æœç•¶å‰æ˜¯ç¯©é¸æ¨¡å¼ï¼Œå‰‡å…ˆé€€å‡ºç¯©é¸ï¼Œä¸¦é‡ç½® currentPlaylistï¼‰
    const isFiltered = playlistSearchInput.value.trim().length > 0;
    if (isFiltered) {
        // é»æ“Šåˆ—è¡¨æ‡‰è¢«è¦–ç‚ºé€€å‡ºç¯©é¸
        playlistSearchInput.value = ''; // æ¸…ç©ºæœç´¢æ¡†
        filterPlaylist(); // åŸ·è¡Œ filterPlaylistï¼Œå®ƒæœƒé‡ç½® currentPlaylist å’Œ currentTrackIndex=0
        
        // ç”±æ–¼ filterPlaylist() å·²ç¶“å°‡ currentPlaylist é‡è¨­ç‚ºå®Œæ•´åˆ—è¡¨ï¼Œæˆ‘å€‘ç¾åœ¨å¯ä»¥åœ¨å®Œæ•´åˆ—è¡¨è£¡æŸ¥æ‰¾
        // æ³¨æ„ï¼šfilterPlaylist() å·²ç¶“å‘¼å«äº† updatePlaylistHighlight() å’Œ sortPlaylistByPlayCount()
    }
    
    // 2. ç¢ºä¿é»æ“Šæ’­æ”¾åˆ—è¡¨æ™‚é€²å…¥è‡ªç”±æ¨¡å¼ï¼ˆå¯é¸ï¼‰
    if (playMode !== 3) {
        playMode = 3; 
        updateModeUI();
        saveSettings(); 
    }
    
    // 3. åœ¨ç•¶å‰åˆ—è¡¨ (å¯èƒ½å·²æ’åºæˆ–ç¯©é¸/é‡ç½®) ä¸­æŸ¥æ‰¾æ­Œæ›²
    const newIndex = currentPlaylist.findIndex(track => track.originalIndex === originalIndex);
    
    if (newIndex !== -1) {
        // 4. å¦‚æœæ‰¾åˆ°ï¼Œæ’­æ”¾å®ƒ (æ’­æ”¾é‚è¼¯å®Œå…¨ä¾è³´ currentPlaylist)
        playTrack(newIndex);
        
    } else {
        // 5. æ ¸å¿ƒä¿®æ­£ï¼šå¦‚æœæ­Œæ›²ä¸åœ¨ç•¶å‰æ­Œå–®ä¸­ (é€™ä¸æ‡‰è©²ç™¼ç”Ÿåœ¨æœªç¯©é¸ç‹€æ…‹)ï¼Œ
        // å‰‡ç™¼å‡ºè­¦å‘Šä¸¦é è¨­æ’­æ”¾ MASTER_TRACK_LIST çš„ç¬¬ä¸€é¦–æ­Œ
        console.error(`loadTrack éŒ¯èª¤: æ­Œæ›² (åŸå§‹ç´¢å¼•: ${originalIndex}) åœ¨ç•¶å‰æ­Œå–®ä¸­æ‰¾ä¸åˆ°ã€‚`);
        
        // ç‚ºé¿å…ç‹€æ…‹æ··äº‚ï¼Œé€™è£¡ä¸åŸ·è¡Œä»»ä½•æ’­æ”¾ï¼Œå› ç‚ºæˆ‘å€‘ä¸çŸ¥é“ä¸‹ä¸€æ›²è©²æ€éº¼è¾¦ã€‚
        // å¯ä»¥é¸æ“‡ï¼šå¼·åˆ¶é‡è¨­æ•´å€‹æ’­æ”¾å™¨åˆ° MASTER_TRACK_LIST çš„ç¬¬ä¸€é¦–ã€‚
        if (currentPlaylist.length === 0) {
            resetCurrentPlaylist();
            sortPlaylistByPlayCount(); // ç¢ºä¿æ’åº
        }
        
        playerTitle.textContent = `éŒ¯èª¤ï¼šæ­Œæ›²æ‰¾ä¸åˆ°ã€‚è«‹æ‰‹å‹•é»æ“Šæ­Œå–®ä¸­çš„å…¶ä»–æ­Œæ›²ã€‚`;
    }
    
    window.location.hash = `song-index-${originalIndex}`;
    updatePlaylistHighlight(); // ç¢ºä¿é«˜äº®é¡¯ç¤ºæ­£ç¢º
}


// --- *** æœå°‹/ç¯©é¸é‚è¼¯ (ä¿æŒä¸è®Š) *** ---
function filterPlaylist() {
    const searchText = playlistSearchInput.value.toLowerCase().trim(); 
    
    if (searchText.length > 0) {
        // ... (ç¯©é¸é‚è¼¯ä¿æŒä¸è®Š) ...
        currentPlaylist = MASTER_TRACK_LIST.filter(track => { 
            const itemText = (track.title + ' ' + track.artist).toLowerCase(); 
            return itemText.includes(searchText);
        });
        
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId); 
            listenIntervalId = null;
        }
        if (currentPlaylist.length === 0) {
            playerTitle.textContent = `æœªæ‰¾åˆ°èˆ‡ "${searchText}" ç›¸é—œçš„æ­Œæ›²ã€‚`;
            audio.pause(); 
            currentTrackIndex = -1;
            
        } else {
             playerTitle.textContent = `å·²æ ¹æ“šç¯©é¸å»ºç«‹æ–°æ­Œå–® (${currentPlaylist.length} é¦–)ã€‚è«‹é»æ“Šæ’­æ”¾ã€‚`;
             currentTrackIndex = 0; 
             
             const track = currentPlaylist[0]; 
             audio.src = track.url; 
             audio.pause(); 
        }
    } else {
        resetCurrentPlaylist(); 
        playerTitle.textContent = "æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨";
        
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId); 
            listenIntervalId = null;
        }
        
      // â­ï¸ é—œéµæ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦æœ‰æ­Œæ›²åœ¨æ’­æ”¾ï¼Œå¦‚æœæ²’æœ‰ï¼Œæ‰é è¨­è¨­ç½®ç‚º 0
    if (currentTrackIndex === -1 || currentPlaylist.length === 0) {
        currentTrackIndex = 0; 
    }
    
    // ç¢ºä¿ audio.src æŒ‡å‘æ­£ç¢ºçš„æ­Œæ›²
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        const track = currentPlaylist[currentTrackIndex]; 
        audio.src = track.url;
    } else {
        // å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œå‰‡è¨­ç‚º -1
        currentTrackIndex = -1;
    }

    audio.pause(); 
}
     // â­ï¸ é—œéµä¿®æ­£ï¼šç„¡è«–ç¯©é¸é‚„æ˜¯æ¸…ç©ºï¼Œéƒ½èª¿ç”¨ sortPlaylistByPlayCount
    // é€™æ¨£å¯ä»¥ç¢ºä¿åœ¨æœç´¢æ¡†æ¸…ç©ºæ™‚ï¼Œå¦‚æœ dataMode æ˜¯ globalï¼Œåˆ—è¡¨æœƒè¢«æ­£ç¢ºæ’åºã€‚
    sortPlaylistByPlayCount(); 
     // DOM å…ƒç´ çš„éš±è—/é¡¯ç¤º
    playlistItems.forEach(item => {
        const itemText = item.textContent.toLowerCase(); 
        if (itemText.includes(searchText) || searchText.length === 0) {
            item.style.display = ''; 
        } else {
            item.style.display = 'none';
        }
    });
    updatePlaylistHighlight(); 
}
// --- æ’­æ”¾åˆ—è¡¨é¡¯ç¤ºèˆ‡æ’åºé‚è¼¯ ---

/**
 * â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šä½¿ç”¨ track.originalIndex å’Œ dataMode é€²è¡Œæ•¸æ“šæŸ¥æ‰¾
 */
function updatePlaylistDisplay() {
    const currentListItems = document.querySelectorAll('#playlist li'); 
    
    currentListItems.forEach(item => {
        const onclickAttr = item.getAttribute('onclick');
        const match = onclickAttr.match(/loadTrack\((\d+)\)/);
        const index = match ? parseInt(match[1]) : -1;
        
        if (index === -1) return;
        
        const track = MASTER_TRACK_LIST[index];
        const originalText = track.title + ' - ' + track.artist;
        
        // â­ï¸ é—œéµï¼šæ ¹æ“šç•¶å‰æ¨¡å¼é¸æ“‡æ•¸æ“šæº
        let playCount = 0;
        if (dataMode === 'global') {
            // åœ¨å…¨çƒæ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ track.id æŸ¥æ‰¾å…¨çƒçµ±è¨ˆæ•¸æ“š
            playCount = globalTrackPlayCounts[track.id] || 0; 
        } else {
            // åœ¨æœ¬åœ°æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ track.originalIndex æŸ¥æ‰¾æœ¬åœ°çµ±è¨ˆæ•¸æ“š
            playCount = trackPlayCounts[index] || 0; 
        }
        
        item.innerHTML = '';
        
        const mainSpan = document.createElement('span');
        mainSpan.textContent = originalText;
        item.appendChild(mainSpan);
        
        if (playCount > 0) {
            const countSpan = document.createElement('small');
            countSpan.className = 'play-stats'; // æ·»åŠ é¡åæ–¹ä¾¿ç§»é™¤
            countSpan.textContent = ` (${playCount} æ¬¡æ’­æ”¾)`;
            
            countSpan.style.fontSize = '0.8em'; 
            countSpan.style.color = '#888'; 
            countSpan.style.marginLeft = '10px';
            
            item.appendChild(countSpan);
        }
    });
}

// â­ï¸ æœ€çµ‚ä¿®æ­£ï¼šsortPlaylistByPlayCount å‡½æ•¸
function sortPlaylistByPlayCount() {
    
    // å¦‚æœæ’­æ”¾åˆ—è¡¨ä¸æ˜¯å®Œæ•´çš„ï¼Œæˆ–è€…æˆ‘å€‘åœ¨æœç´¢æ¨¡å¼ï¼Œå‰‡ä¸é€²è¡Œæ’åºï¼Œåªæ›´æ–°é¡¯ç¤º
    if (currentPlaylist.length !== MASTER_TRACK_LIST.length) {
         updatePlaylistDisplay(); 
         updatePlaylistHighlight();
         return;
    }
    
    // 1. æº–å‚™ç”¨æ–¼æ’åºçš„å¢å¼·åˆ—è¡¨ (åŸºæ–¼ MASTER_TRACK_LIST)
    const sortableList = [...MASTER_TRACK_LIST].map(track => {
        const index = track.originalIndex;
        let count = 0;
        
        if (dataMode === 'global') {
            count = globalTrackPlayCounts[track.id] || 0; 
        } else {
            count = trackPlayCounts[index] || 0; 
        }
        return { ...track, playCount: count };
    });
    
    // 2. åŸ·è¡Œæ’åº (æŒ‰æ’­æ”¾æ¬¡æ•¸é™åºï¼Œç„¶å¾ŒæŒ‰åŸå§‹ç´¢å¼•å‡åº)
    sortableList.sort((a, b) => {
        if (b.playCount !== a.playCount) {
            return b.playCount - a.playCount;
        }
        return a.originalIndex - b.originalIndex; 
    });
    
    // 3. å„²å­˜ç•¶å‰æ’­æ”¾ç‹€æ…‹
    const currentlyPlayingOriginalIndex = currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length
        ? currentPlaylist[currentTrackIndex].originalIndex 
        : -1; 
        
    // 4. é—œéµï¼šæ›´æ–°å…§éƒ¨æ’­æ”¾åˆ—è¡¨ currentPlaylist æ•¸çµ„
    currentPlaylist = sortableList; 
    
    // 5. é‡æ–°å®šä½ç•¶å‰æ­Œæ›²åœ¨æ–°åˆ—è¡¨ä¸­çš„ç´¢å¼•
    if (currentlyPlayingOriginalIndex !== -1) {
        const newIndex = currentPlaylist.findIndex(track => track.originalIndex === currentlyPlayingOriginalIndex);
        currentTrackIndex = newIndex !== -1 ? newIndex : 0; // å¦‚æœæ‰¾ä¸åˆ°å‰‡è¨­ç‚ºç¬¬ä¸€é¦–
    } else {
        currentTrackIndex = 0;
    }

    // â­ï¸ æ ¸å¿ƒä¿®æ­£å€å¡Šï¼šç¢ºä¿ DOM å…ƒç´ å­˜åœ¨ä¸¦æ­£ç¢ºé€²è¡Œé‡æ’
    const playlistUl = document.getElementById('playlist');
    let originalLiElements = Array.from(playlistUl.querySelectorAll('li'));
    
    // ğŸ”´ æª¢æŸ¥ï¼šå¦‚æœåˆ—è¡¨ç‚ºç©ºï¼Œå¼·åˆ¶é‡å»º DOM å…ƒç´ 
    if (originalLiElements.length === 0) {
        console.warn("DOM åˆ—è¡¨ç‚ºç©ºï¼æ­£åœ¨å¼·åˆ¶é‡å»ºæ‰€æœ‰ LI å…ƒç´ ä»¥é¿å…ç©ºç™½åˆ—è¡¨ã€‚");
        const fragment = document.createDocumentFragment();
        MASTER_TRACK_LIST.forEach((track, index) => {
            const li = document.createElement('li');
            li.setAttribute('onclick', `loadTrack(${index})`);
            li.textContent = `${track.title} - ${track.artist}`;
            fragment.appendChild(li);
        });
        playlistUl.innerHTML = '';
        playlistUl.appendChild(fragment);
        // é‡æ–°ç²å–å…ƒç´ åˆ—è¡¨
        originalLiElements = Array.from(playlistUl.querySelectorAll('li'));
    }
    
    const fragment = document.createDocumentFragment();
    const liMap = new Map();
    originalLiElements.forEach(item => {
        const onclickAttr = item.getAttribute('onclick');
        const match = onclickAttr.match(/loadTrack\((\d+)\)/);
        if (match) {
            liMap.set(parseInt(match[1]), item);
        }
    });

    // æ ¹æ“šæ’åºå¾Œçš„åˆ—è¡¨ currentPlaylist é †åºï¼Œå°‡ li å…ƒç´ æ·»åŠ åˆ°ç‰‡æ®µä¸­
    currentPlaylist.forEach(track => { 
        const originalIndex = track.originalIndex;
        const liElement = liMap.get(originalIndex);
        if (liElement) {
            fragment.appendChild(liElement); // ç§»é™¤èˆŠä½ç½®ï¼Œæ·»åŠ åˆ°ç‰‡æ®µ
        }
    });
    
    // 6. æ¸…ç©ºèˆŠåˆ—è¡¨ä¸¦ä¸€æ¬¡æ€§æ·»åŠ æ–°é †åº
    playlistUl.innerHTML = '';
    playlistUl.appendChild(fragment);
    
    // 7. æ›´æ–°å…¨å±€å¼•ç”¨çš„ playlistItems
    playlistItems = document.querySelectorAll('#playlist li'); 
    updatePlaylistDisplay();
    
    // â­ï¸ ä¿®æ­£ï¼šå¼·åˆ¶é‡æ–°è¼‰å…¥ç•¶å‰æ­Œæ›²ï¼Œç¢ºä¿æ’­æ”¾å™¨åœ¨æ–°çš„åˆ—è¡¨é †åºä¸­
    if (currentTrackIndex !== -1 && currentTrackIndex < currentPlaylist.length) {
        const track = currentPlaylist[currentTrackIndex];
        // åªæœ‰åœ¨æ–°çš„æ›²ç›® URL èˆ‡ç•¶å‰éŸ³æºä¸ç¬¦æ™‚æ‰æ›´æ”¹ src
        if (audio.src !== track.url) {
             // é‡æ–°è¨­å®šéŸ³æº (é€šå¸¸ä¸éœ€è¦ï¼Œå› ç‚º URL ä¸è®Šï¼Œä½†é€™æ˜¯æœ€ä¿éšªçš„åšæ³•)
             audio.src = track.url; 
        }
        
        // â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šæ›´æ–°æ¨™é¡Œä»¥åæ˜ æ–°çš„æ’­æ”¾ä½ç½®ï¼ˆå¯é¸ï¼Œç”¨æ–¼èª¿è©¦ï¼‰
        if (!audio.paused) {
            playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title} (æ­Œå–®å·²æ’åº)`;
        } else {
            playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title} (æ­Œå–®å·²æ’åº)`;
        }
    }
    
    updatePlaylistHighlight();
}



// --- *** LocalStorage é‚è¼¯ *** ---
// â­ï¸ ä¿®æ­£ A: æ›´æ”¹éµåï¼Œå„²å­˜æ­Œæ›²çš„åŸå§‹ç´¢å¼•
const CURRENT_TRACK_INDEX_KEY = 'audioPlayerOriginalIndex';
const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

function saveSettings() {
    try {
        localStorage.setItem('audioPlayerVolume', audio.volume);
        localStorage.setItem('audioPlayerMuted', audio.muted);
        localStorage.setItem('audioPlayerMode', playMode);
        localStorage.setItem(DATA_MODE_STORAGE_KEY, dataMode);  
        
        // â­ï¸ ä¿®æ­£ A: å„²å­˜æ­Œæ›²åœ¨ MASTER_TRACK_LIST ä¸­çš„åŸå§‹ç´¢å¼•
        if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
            const track = currentPlaylist[currentTrackIndex];
            localStorage.setItem(CURRENT_TRACK_INDEX_KEY, track.originalIndex);
        } else {
            localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
        }
        
        if (audio.currentTime > 0) {
             localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
        } else {
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
        }
        
    } catch (e) {
        console.warn('LocalStorage is not available or blocked.', e);
    }
}

// â­ï¸ ä¿®æ­£å¾Œçš„ loadSavedSettings å‡½æ•¸
function loadSavedSettings() {
    try {
        const savedVolume = localStorage.getItem('audioPlayerVolume');
        if (savedVolume !== null) {
            audio.volume = Math.max(0, Math.min(1, parseFloat(savedVolume)));
        }
        const savedMuted = localStorage.getItem('audioPlayerMuted');
        if (savedMuted !== null) {
            audio.muted = (savedMuted === 'true');
        }
        const savedMode = localStorage.getItem('audioPlayerMode');
        if (savedMode !== null) {
            const mode = parseInt(savedMode);
            if (mode >= 0 && mode <= 4) { 
                playMode = mode;
                updateModeUI(); 
            }
        }
        
        const savedCounts = localStorage.getItem(PLAY_COUNT_STORAGE_KEY);
        if (savedCounts) {
            trackPlayCounts = JSON.parse(savedCounts);
        }
        
        const savedDataMode = localStorage.getItem(DATA_MODE_STORAGE_KEY);
        if (savedDataMode && (savedDataMode === 'local' || savedDataMode === 'global')) {
            dataMode = savedDataMode;
        }
        updateDataModeUI(); 

        
        // â­ï¸ ä¿®æ­£ B: è¼‰å…¥ä¸¦å®šä½åŸå§‹ç´¢å¼•
        const savedOriginalIndex = localStorage.getItem(CURRENT_TRACK_INDEX_KEY);
        
        if (savedOriginalIndex !== null) {
            const originalIndex = parseInt(savedOriginalIndex);
            
            // æª¢æŸ¥åŸå§‹ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ
            if (originalIndex >= 0 && originalIndex < MASTER_TRACK_LIST.length) { 
                
                const track = MASTER_TRACK_LIST[originalIndex]; 
                audio.src = track.url;
                playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
                
                // é—œéµï¼šè¨­å®šä¸€å€‹æ¨™è¨˜ï¼Œè®“ initializePlayer çŸ¥é“è¦æ’­æ”¾å“ªé¦–æ­Œ
                window.__LAST_PLAYED_ORIGINAL_INDEX = originalIndex;
                
            } else {
                currentTrackIndex = 0; 
                if (MASTER_TRACK_LIST.length > 0) {
                    const track = MASTER_TRACK_LIST[0]; 
                    audio.src = track.url;
                    playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾çš„æ­Œæ›²å·²æ›´æ–°ï¼Œç¾æ’­æ”¾ï¼š${track.title}`;
                } else {
                    currentTrackIndex = -1; 
                }
            }
        }
        
        const savedTime = localStorage.getItem(CURRENT_TRACK_TIME_KEY);
        if (savedTime !== null && currentTrackIndex >= 0) { 
             const time = parseFloat(savedTime);
             if (!isNaN(time) && time > 0) {
                 audio.currentTime = time;
             }
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY); 
        }

        const currentKeys = MASTER_TRACK_LIST.map(t => t.originalIndex.toString());
        let keysToDelete = [];
        for (const key in trackPlayCounts) {
            if (!currentKeys.includes(key)) {
                keysToDelete.push(key);
            }
        }
        keysToDelete.forEach(key => delete trackPlayCounts[key]);
        
        localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
        
    } catch (e) {
        console.warn('Failed to load settings from LocalStorage.', e);
    }
}

// --- *** URL éŒ¨é»è™•ç†é‚è¼¯ *** ---
function handleUrlAnchor(isInitialLoad = false) {
    const hash = window.location.hash;
    
    if (hash.startsWith('#song-index-')) {
        const parts = hash.split('-');
        const originalIndex = parseInt(parts[parts.length - 1]);
        
        if (!isNaN(originalIndex) && originalIndex >= 0 && originalIndex < MASTER_TRACK_LIST.length) {
            
            const trackTitle = MASTER_TRACK_LIST[originalIndex].title;
            
            loadTrack(originalIndex); 
            
            // â­ï¸ ä¿®æ­£ï¼šåªåœ¨åˆæ¬¡è¼‰å…¥æ™‚é‡ç½®æ¨¡å¼ï¼Œå› ç‚ºåˆ†äº«é€£çµé€šå¸¸éœ€è¦å¾é ­é–‹å§‹
            if (isInitialLoad) {
                playMode = 0; // é †åºåœæ­¢
                updateModeUI();
                saveSettings();
            }
            
            playerTitle.textContent = `å¾åˆ†äº«é€£çµè¼‰å…¥ï¼š${trackTitle} (æ­£åœ¨ç·©è¡...)`;
            const handlePlaying = () => {
                 if (playerTitle.textContent.includes(trackTitle)) { 
                     playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${trackTitle}`;
                     audio.removeEventListener('playing', handlePlaying);
                 }
            };
            audio.addEventListener('playing', handlePlaying);
            
            audio.play().catch(error => {
                 playerTitle.textContent = `å¾åˆ†äº«è¼‰å…¥ï¼š${trackTitle} (éœ€é»æ“Šæ’­æ”¾)`;
            });
        }
    }
}
// ------------------------------------
// --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---
audio.addEventListener('volumechange', saveSettings);
audio.addEventListener('ratechange', saveSettings); 
audio.addEventListener('loadedmetadata', saveSettings); 
audio.addEventListener('timeupdate', () => {
    if (!audio.paused && audio.currentTime % 5 < 1) {
         saveSettings();
    }
});
audio.addEventListener('play', () => {
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
    
    // â­ï¸ æ ¸å¿ƒæ–°å¢: ç™¼é€æ•¸æ“šåˆ°æ•¸æ“šåº«
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        // ä½¿ç”¨ track.id ä½œç‚º song_id å‚³å…¥
        const currentSongId = currentPlaylist[currentTrackIndex].id; 
        trackPlayToDatabase(currentSongId); 
    }
    
    saveSettings(); 
});
audio.addEventListener('pause', () => {
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
    saveSettings();
});

audio.addEventListener('ended', saveSettings);
playlistSearchInput.addEventListener('input', debounce(filterPlaylist, 300));

// --- *** ç•°æ­¥åˆå§‹åŒ–å‡½æ•¸ *** ---

async function initializePlayer(isManualToggle = false) {
    // 1. è¼‰å…¥æœ¬åœ°è¨­ç½® (åŒ…æ‹¬ dataMode, __LAST_PLAYED_ORIGINAL_INDEX, playMode ç­‰)
    loadSavedSettings(); 
    
    // 2. åªæœ‰åœ¨æ¨¡å¼è¨­å®šç‚º 'global' æ™‚æ‰ç™¼èµ· API è«‹æ±‚
    if (dataMode === 'global') {
         // UI é¡¯ç¤ºæ­£åœ¨è¼‰å…¥
         document.getElementById('current-data-mode').textContent = '[è¼‰å…¥ä¸­...]'; 
         const counts = await fetchGlobalPlayCounts();
         globalTrackPlayCounts = counts; 
         // API è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºæ­£å¸¸ç‹€æ…‹
         document.getElementById('current-data-mode').textContent = '[å…¨çƒçµ±è¨ˆ]'; 
    } else {
         globalTrackPlayCounts = {}; 
         document.getElementById('current-data-mode').textContent = '[æœ¬åœ°çµ±è¨ˆ]';
    }

    // 3. â­ï¸ æ ¸å¿ƒä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦åœ¨ç¯©é¸ç‹€æ…‹
    if (playlistSearchInput.value.trim().length > 0) {
        // å¦‚æœæœ‰æœç´¢æ–‡æœ¬ï¼Œæˆ‘å€‘åªéœ€è¦é‡æ–°åŸ·è¡Œç¯©é¸ã€‚
        // filterPlaylist() æœƒè‡ªè¡Œè¨­ç½® currentPlaylist ç‚ºç¯©é¸çµæœã€‚
        filterPlaylist(); 
    } else {
        // å¦‚æœæ²’æœ‰æœç´¢æ–‡æœ¬ï¼Œå‰‡é‡ç½® currentPlaylist ç‚ºå®Œæ•´æ­Œå–®
        resetCurrentPlaylist(); 
    }
    
    // 4. è™•ç† UI 
    updateModeUI(); // ç¢ºä¿ UI åæ˜  loadSavedSettings ä¸­è¼‰å…¥çš„ playMode
    
    // 5. æ’åº
    sortPlaylistByPlayCount(); 
    
    // â­ï¸ ä¿®æ­£ C: åœ¨æ’åºå¾Œï¼Œæ ¹æ“šå„²å­˜çš„ originalIndex é‡æ–°å®šä½ currentTrackIndex
    if (window.__LAST_PLAYED_ORIGINAL_INDEX !== undefined) {
        const lastPlayedOriginalIndex = window.__LAST_PLAYED_ORIGINAL_INDEX;
        
        // åœ¨æ–°æ’åº/ç¯©é¸å¾Œçš„ currentPlaylist ä¸­æŸ¥æ‰¾æ­Œæ›²
        const newIndex = currentPlaylist.findIndex(track => track.originalIndex === lastPlayedOriginalIndex);
        
        if (newIndex !== -1) {
            currentTrackIndex = newIndex; // è¨­ç½®æ­£ç¢ºçš„ç´¢å¼•ï¼
        } else {
            // å¦‚æœæ­Œæ›²åœ¨ç•¶å‰åˆ—è¡¨ä¸­æ‰¾ä¸åˆ°ï¼ˆä¾‹å¦‚è¢«ç¯©é¸æ‰äº†ï¼‰ï¼Œé è¨­ç‚ºç¬¬ä¸€é¦–
            currentTrackIndex = 0;
        }
        
        // æ¸…é™¤æ¨™è¨˜
        delete window.__LAST_PLAYED_ORIGINAL_INDEX; 
        
        // ç¢ºä¿ audio.src å’Œæ¨™é¡Œæ­£ç¢º
        const track = currentPlaylist[currentTrackIndex];
        audio.src = track.url; 
        playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
        updatePlaylistHighlight();
    }
    
    initializeTheme();
}

// â­ï¸ é—œéµä¿®æ­£ 2: ä¿®æ­£ DOMContentLoaded é–‰åˆ 
document.addEventListener('DOMContentLoaded', () => {
    // 1. åœ¨ DOM æº–å‚™å°±ç·’å¾Œï¼Œç¢ºä¿å…¨å±€ playlistItems è®Šé‡è¢«æ­£ç¢ºè³¦å€¼
    playlistItems = document.querySelectorAll('#playlist li'); 

    // 2. æª¢æŸ¥åˆ—è¡¨æ˜¯å¦ç‚ºç©º
    if (playlistItems.length === 0 && MASTER_TRACK_LIST.length > 0) {
        console.error("åš´é‡è­¦å‘Š: DOMContentLoaded æ™‚ playlist å…ƒç´ ç‚ºç©ºã€‚");
    }

    // 3. å•Ÿå‹•æ’­æ”¾å™¨ (è¼‰å…¥è¨­ç½®ã€æ•¸æ“šã€æ’åº)
    initializePlayer(); 
    
    // 4. è™•ç† URL éŒ¨é» (åªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œæ¨¡å¼é‡ç½®)
    handleUrlAnchor(true);
});
</script>
