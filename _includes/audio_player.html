<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
<div id="player-controls">
    <span id="mode-button" onclick="togglePlayMode()">
        [ æ¨¡å¼: é †åº ]
    </span>
    
<div id="theme-switcher">
    <button id="theme-toggle-btn">
        ä¸»é¡Œï¼š<span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>
    </button>
<div id="theme-menu" class="hidden-menu">
    <span class="theme-option" data-theme="light">ç™½è‰²</span>
    <span class="theme-option" data-theme="dark">é»‘è‰²</span>
    <span class="theme-option" data-theme="grey">ç°è‰²</span>
    <span class="theme-option" data-theme="blue">è—è‰²</span>
    <span class="theme-option" data-theme="green">ç¶ è‰²</span>
    <span class="theme-option" data-theme="purple">ç´«è‰²</span>
    <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
    <span class="theme-option" data-theme="red">ç´…è‰²</span>
</div>
</div>

    <div id="sleep-timer-area">
        <button id="timer-toggle-btn" onclick="toggleTimerMenu()">
            å®šæ™‚ (æœªè¨­å®š)
        </button>
        
        <div id="timer-menu" class="hidden-menu">
            <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
        </div>
    </div>
</div> 

<div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>

<ul id="playlist">

    {% for track in site.data.music %}
        <li onclick="loadTrack({{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
    
</div>
<script>
// ç²å– DOM å…ƒç´ 
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
let playlistItems = document.querySelectorAll('#playlist li'); 
const modeButton = document.getElementById('mode-button'); 

// æ–°å¢ DOM å…ƒç´ 
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');
const playlistSearchInput = document.getElementById('playlist-search'); 

// *** ä¸»é¡Œåˆ‡æ›ç›¸é—œ DOM å…ƒç´  ***
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const themeMenu = document.getElementById('theme-menu');
const currentThemeName = document.getElementById('current-theme-name');
const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
    
    
// 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
const MASTER_TRACK_LIST = [ 

    // å¢åŠ ä¸€å€‹åŸå§‹ç´¢å¼• (originalIndex)ï¼Œç”¨æ–¼å°‡ä¾†å›æº¯æˆ–å»ç¯©é¸æ™‚å®šä½
    { title: "Alive in the summer time", artist: "AI", url: "https://raw.githubusercontent.com/xxyzyh-code/music/main/Alive in the summer time.m4a", originalIndex: 0 },

    // å¢åŠ ä¸€å€‹åŸå§‹ç´¢å¼• (originalIndex)ï¼Œç”¨æ–¼å°‡ä¾†å›æº¯æˆ–å»ç¯©é¸æ™‚å®šä½
    { title: "Breakbeat background", artist: "AI", url: "https://raw.githubusercontent.com/xxyzyh-code/music/main/Breakbeat background.m4a", originalIndex: 1 },

    // å¢åŠ ä¸€å€‹åŸå§‹ç´¢å¼• (originalIndex)ï¼Œç”¨æ–¼å°‡ä¾†å›æº¯æˆ–å»ç¯©é¸æ™‚å®šä½
    { title: "The best moments in life", artist: "AI", url: "https://raw.githubusercontent.com/xxyzyh-code/music/main/The best moments in life.m4a", originalIndex: 2 },

];

let currentPlaylist = []; 
let currentTrackIndex = 0; 
// æ’­æ”¾æ¨¡å¼ï¼š0=é †åºåœæ­¢, 1=å–®æ›²å¾ªç’°, 2=éš¨æ©Ÿæ’­æ”¾, 3=è‡ªç”±æ¨¡å¼, 4=é †åºå¾ªç’°
let playMode = 0; 

// å®šæ™‚å™¨ç‹€æ…‹è®Šæ•¸
let sleepTimerId = null; 
let sleepTime = 0; 
let endTime = 0; 
let countdownIntervalId = null; 

// ç¸½æ™‚é•·è¿½è¹¤è®Šæ•¸
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; 

// æ’­æ”¾æ¬¡æ•¸è¿½è¹¤è®Šæ•¸
const PLAY_COUNT_STORAGE_KEY = 'audioTrackPlayCounts'; 
let trackPlayCounts = {}; 


// --- *** é˜²æŠ–è¼”åŠ©å‡½æ•¸ *** ---
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}


// --- *** æ­Œå–®é‡ç½®èˆ‡åˆå§‹åŒ– *** ---

function resetCurrentPlaylist() {
    currentPlaylist = [...MASTER_TRACK_LIST]; 
}


// --- è¼”åŠ©å‡½æ•¸ ---

// è¼‰å…¥ä¸¦æ’­æ”¾æŒ‡å®šç´¢å¼•çš„æ­Œæ›²
function playTrack(index) {
    // ç¢ºä¿ç´¢å¼•åœ¨ç•¶å‰æ­Œå–®çš„ç¯„åœå…§
    if (index >= 0 && index < currentPlaylist.length) { 
        currentTrackIndex = index;
        const track = currentPlaylist[index]; 
        audio.src = track.url;
        playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
        audio.play().catch(error => {
            console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
        });
        updatePlaylistHighlight();
    } else if (index === currentPlaylist.length) { 
        audio.pause(); 
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    }
}

// ç²å–éš¨æ©Ÿç´¢å¼•
function getNextRandomIndex() {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * currentPlaylist.length); 
    } while (newIndex === currentTrackIndex && currentPlaylist.length > 1);
    
    return newIndex;
}

// æ›´æ–°æ’­æ”¾åˆ—è¡¨çš„é«˜äº®ç‹€æ…‹ï¼Œä¸¦å¢åŠ ã€Œè‡ªå‹•æ»¾å‹•ã€åŠŸèƒ½
function updatePlaylistHighlight(manualScroll = false) {
    const listItems = document.querySelectorAll('#playlist li');
    
    // 1. ç§»é™¤æ‰€æœ‰é …ç›®çš„é«˜äº®ç‹€æ…‹
    listItems.forEach(item => {
        item.classList.remove('playing');
    });

    // 2. ç‚ºç•¶å‰æ’­æ”¾çš„æ­Œæ›²æ·»åŠ é«˜äº®ç‹€æ…‹
    if (currentTrackIndex >= 0 && currentTrackIndex < listItems.length) {
        const playingItem = listItems[currentTrackIndex];
        playingItem.classList.add('playing');
        
        // 3. === æ–°å¢é‚è¼¯ï¼šè‡ªå‹•æ»¾å‹•åˆ°æ­£åœ¨æ’­æ”¾çš„æ­Œæ›² ===
        
        // åªæœ‰åœ¨æ­Œæ›²åˆ‡æ›æ™‚ï¼ˆéæ‰‹å‹•æœç´¢æˆ–æ’åºæ™‚ï¼‰ï¼Œæ‰åŸ·è¡Œè‡ªå‹•æ»¾å‹•ã€‚
        // ç•¶å‰çš„ CSS æ»¾å‹• (overflow-y: auto) å·²ç¶“ç”Ÿæ•ˆï¼Œ
        // é€™è£¡ç¢ºä¿ç•¶æ­Œæ›²åˆ‡æ›åˆ°è¦–åœ–å¤–æ™‚ï¼Œåˆ—è¡¨æœƒè‡ªå‹•èª¿æ•´ä½ç½®ã€‚
        if (!manualScroll) {
             playingItem.scrollIntoView({
                behavior: 'smooth', // ä½¿ç”¨å¹³æ»‘æ•ˆæœ
                block: 'nearest'    // ç¢ºä¿å…ƒç´ ç›¡é‡åœ¨å¯è¦‹ç¯„åœå…§ï¼Œå¦‚æœå·²ç¶“å¯è¦‹å‰‡ä¸æ»¾å‹•
            });
        }
    }
}

// --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± ---

audio.addEventListener('ended', () => {
    // è¨˜éŒ„ç•¶å‰æ­Œæ›²æ’­æ”¾å®Œæˆï¼Œç”¨æ–¼ GA4 å’Œæœ¬åœ°è¨ˆæ•¸
    incrementPlayCount(); 
    updatePlaylistDisplay(); 
    sortPlaylistByPlayCount(); 

    // ã€åˆ†äº«é€£çµã€‘åœ¨åˆ‡æ›ä¸‹ä¸€é¦–å‰ï¼Œæ›´æ–° URL éŒ¨é»
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        window.location.hash = `song-index-${currentPlaylist[currentTrackIndex].originalIndex}`;
    }

    // è™•ç†æ’­æ”¾æ¨¡å¼
    switch (playMode) {
        case 1: // å–®æ›²å¾ªç’°
            audio.currentTime = 0; 
            audio.play();
            break;

        case 2: // éš¨æ©Ÿæ’­æ”¾
            const nextIndex = getNextRandomIndex();
            playTrack(nextIndex);
            break;

        case 3: // è‡ªç”±æ¨¡å¼ (æ’­å®Œå³åœ)
            audio.pause();
            playerTitle.textContent = "è‡ªç”±æ¨¡å¼ä¸‹ï¼Œç•¶å‰æ­Œæ›²æ’­æ”¾å®Œç•¢ã€‚";
            currentTrackIndex = -1; 
            updatePlaylistHighlight();
            break;

        case 4: // é †åºå¾ªç’°
            if (currentTrackIndex < currentPlaylist.length - 1) { 
                playTrack(currentTrackIndex + 1); // æ’­æ”¾ä¸‹ä¸€é¦–
            } else {
                playTrack(0); // å¾é ­é–‹å§‹
            }
            break;
            
        case 0: // é †åºåœæ­¢ (æ’­å®Œæ­Œå–®å³åœ)
        default:
            if (currentTrackIndex < currentPlaylist.length - 1) { 
                playTrack(currentTrackIndex + 1); // æ’­æ”¾ä¸‹ä¸€é¦–
            } else {
                // æ­Œå–®å·²æ’­å®Œï¼Œåœæ­¢æ’­æ”¾
                audio.pause();
                playerTitle.textContent = "é †åºæ’­æ”¾å®Œæˆï¼Œå·²åœæ­¢ã€‚";
                currentTrackIndex = -1; // æ¨™è¨˜ç‚ºæœªæ’­æ”¾ç‹€æ…‹
                updatePlaylistHighlight();
                window.location.hash = ''; // æ­Œå–®çµæŸæ™‚æ¸…é™¤éŒ¨é»
            }
            break;
    }
});


// æ¨¡å¼åˆ‡æ›å‡½æ•¸
function togglePlayMode() {
    playMode = (playMode + 1) % 5; 
    
    updateModeUI();
    
    playerTitle.textContent = `å·²åˆ‡æ›åˆ° ${modeButton.textContent.replace('[ æ¨¡å¼: ', '').replace(' ]', '')}`;

    saveSettings(); 
}

// çµ±ä¸€æ›´æ–°æ¨¡å¼ UI çš„å‡½æ•¸
function updateModeUI() {
    let modeText;
    
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å–®æ›²å¾ªç’° ]";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
    } else if (playMode === 4) {
        modeText = "[ æ¨¡å¼: é †åºå¾ªç’° ]"; 
    } else {
        modeText = "[ æ¨¡å¼: é †åºåœæ­¢ ]"; 
    }
    
    modeButton.textContent = modeText;
}


// --- *** ä¸»é¡Œåˆ‡æ›é‚è¼¯ *** ---
const THEME_STORAGE_KEY = 'userThemePreference';
const LIGHT_THEME = 'light'; 
const DARK_THEME = 'dark';   
const GREY_THEME = 'grey';   
const BLUE_THEME = 'blue';
const GREEN_THEME = 'green';
const PURPLE_THEME = 'purple';
const PINK_THEME = 'pink';
const RED_THEME = 'red';
    
function applyTheme(desiredTheme, isManual = false) {
    const body = document.body;
    let displayName = '';
    
    body.classList.remove(
        DARK_THEME + '-theme', 
        GREY_THEME + '-theme',
        BLUE_THEME + '-theme',
        GREEN_THEME + '-theme',
        PURPLE_THEME + '-theme', 
        PINK_THEME + '-theme',   
        RED_THEME + '-theme'     
    );

    let themeToApply = desiredTheme;
    let modeText = 'ã€æ‰‹å‹•ã€‘';

    if (isManual) {
        localStorage.setItem(THEME_STORAGE_KEY, desiredTheme);
    } 
    else if (desiredTheme === LIGHT_THEME) {
        themeToApply = getSystemThemeBasedOnTime();
        modeText = 'ã€è‡ªå‹•ã€‘';
    }

    if (themeToApply === DARK_THEME) {
        body.classList.add(DARK_THEME + '-theme');
        displayName = 'é»‘è‰²';
    } else if (themeToApply === GREY_THEME) {
        body.classList.add(GREY_THEME + '-theme');
        displayName = 'ç°è‰²';
    } else if (themeToApply === BLUE_THEME) {
        body.classList.add(BLUE_THEME + '-theme');
        displayName = 'è—è‰²';
    } else if (themeToApply === GREEN_THEME) {
        body.classList.add(GREEN_THEME + '-theme');
        displayName = 'ç¶ è‰²';
    } else if (themeToApply === PURPLE_THEME) { 
        body.classList.add(PURPLE_THEME + '-theme');
        displayName = 'ç´«è‰²';
    } else if (themeToApply === PINK_THEME) { 
        body.classList.add(PINK_THEME + '-theme');
        displayName = 'ç²‰è‰²';
    } else if (themeToApply === RED_THEME) { 
        body.classList.add(RED_THEME + '-theme');
        displayName = 'ç´…è‰²';
    } else { 
        displayName = 'ç™½è‰²';
    }
    
    currentThemeName.textContent = `${displayName} ${modeText}`;
}

function getSystemThemeBasedOnTime() {
    const hour = new Date().getHours();
    return (hour >= 19 || hour < 7) ? DARK_THEME : LIGHT_THEME;
}

function initializeTheme() {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme) {
        if (storedTheme === LIGHT_THEME) {
             applyTheme(LIGHT_THEME, false); 
        } else {
             applyTheme(storedTheme, true); 
        }
    } else {
        applyTheme(LIGHT_THEME, false);
    }
}

// --- ä¸»é¡Œ/å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ ---

themeToggleBtn.addEventListener('click', (event) => {
    event.stopPropagation(); 
    themeMenu.classList.toggle('hidden-menu');
});

themeOptions.forEach(option => {
    option.addEventListener('click', (e) => {
        const selectedTheme = e.target.getAttribute('data-theme');
        applyTheme(selectedTheme, true); 
        themeMenu.classList.add('hidden-menu'); 
    });
});

document.addEventListener('click', (e) => {
    if (!themeMenu.contains(e.target) && !themeToggleBtn.contains(e.target)) {
        themeMenu.classList.add('hidden-menu');
    }
    if (!timerMenu.contains(e.target) && !timerToggleButton.contains(e.target)) {
        if (!timerMenu.classList.contains('hidden-menu')) {
            timerMenu.classList.add('hidden-menu');
        }
    }
});

setInterval(() => {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme === LIGHT_THEME) {
        applyTheme(LIGHT_THEME, false); 
    }
}, 1000 * 60 * 60); 
    
function toggleTimerMenu() {
    timerMenu.classList.toggle('hidden-menu');
}

function setSleepTimer(minutes) {
    clearSleepTimer();
    toggleTimerMenu(); 

    const delayMilliseconds = minutes * 60 * 1000;
    
    sleepTime = minutes * 60;
    endTime = Date.now() + delayMilliseconds;

    sleepTimerId = setTimeout(() => {
        audio.pause(); 
        playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾ (${minutes} åˆ†é˜)`;
        clearSleepTimer(); 
    }, delayMilliseconds);
    
    countdownIntervalId = setInterval(updateTimerCountdown, 1000);

    timerToggleButton.textContent = `å®šæ™‚ (${minutes} åˆ†é˜)`;
    playerTitle.textContent = `å®šæ™‚å™¨å·²è¨­ç½®ï¼š${minutes} åˆ†é˜å¾Œè‡ªå‹•é—œé–‰`;

    if (audio.paused) {
        audio.play();
    }
}

function clearSleepTimer() {
    if (sleepTimerId !== null) {
        clearTimeout(sleepTimerId);
        sleepTimerId = null;
    }
    if (countdownIntervalId !== null) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
    }
    
    sleepTime = 0;
    endTime = 0;
    timerToggleButton.textContent = "å®šæ™‚ (æœªè¨­å®š)";
    remainingTimerSpan.textContent = "--:--";
    playerTitle.textContent = "å·²å–æ¶ˆå®šæ™‚å™¨";
}

function updateTimerCountdown() {
    if (endTime > 0) {
        const remainingMs = endTime - Date.now();
        const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
        
        const minutes = Math.floor(remainingS / 60);
        const seconds = remainingS % 60;
        
        remainingTimerSpan.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        if (remainingS === 0) {
            clearSleepTimer(); 
            if (!audio.paused) {
                 audio.pause();
                 playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾`;
            }
        }
    }
}

audio.addEventListener('play', () => {
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
});

audio.addEventListener('pause', () => {
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
});

function updateTotalListenTime() {
    totalListenSeconds++;
    if (totalListenSeconds >= 60) {
        totalListenMinutes++;
        totalListenSeconds = 0;
    }
    
    totalListenTimeSpan.textContent = 
        `${totalListenMinutes} åˆ†é˜ ${totalListenSeconds} ç§’`;
}

// æ’­æ”¾æ¬¡æ•¸è¿½è¹¤å‡½æ•¸
function incrementPlayCount() {
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        const track = currentPlaylist[currentTrackIndex];
        const key = track.originalIndex; 
        
        trackPlayCounts[key] = (trackPlayCounts[key] || 0) + 1; 
        
        try {
            localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
        } catch (e) {
            console.warn('ç„¡æ³•å„²å­˜æ’­æ”¾æ¬¡æ•¸åˆ° LocalStorage.', e);
        }
        
        if (typeof gtag === 'function') {
            gtag('event', 'song_played', {
                'song_index': key,           
                'song_title': track.title    
            });
            console.log(`GA4 äº‹ä»¶ç™¼é€æˆåŠŸ: song_played, æ­Œæ›²ID: ${key}, æ¨™é¡Œ: ${track.title}`);
        } 
    }
}

// --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ä¾†è‡ªåˆ—è¡¨é»æ“Š) ---

/**
 * @param {number} originalIndex - æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
 */
function loadTrack(originalIndex) { 
    // é»æ“Šæ­Œæ›²æ™‚åˆ‡æ›åˆ°ã€Œè‡ªç”±æ¨¡å¼ (3)ã€
    if (playMode !== 3) {
        playMode = 3; 
        updateModeUI();
        saveSettings(); 
    }
    
    const newIndex = currentPlaylist.findIndex(track => track.originalIndex === originalIndex);

    if (newIndex !== -1) {
        playTrack(newIndex);
    } else {
        resetCurrentPlaylist();
        
        const masterIndex = MASTER_TRACK_LIST.findIndex(track => track.originalIndex === originalIndex);
        if (masterIndex !== -1) {
            playerTitle.textContent = "å·²æ¸…é™¤ç¯©é¸ï¼Œä¸¦æ’­æ”¾æ‚¨é»é¸çš„æ­Œæ›²";
            playTrack(masterIndex); 
        }
    }
    
    // é»æ“Šå¾Œæ›´æ–° URL éŒ¨é»ï¼Œä¾›åˆ†äº«ä½¿ç”¨
    window.location.hash = `song-index-${originalIndex}`;
}

// --- *** æœå°‹/ç¯©é¸é‚è¼¯ *** ---

function filterPlaylist() {
    const searchText = playlistSearchInput.value.toLowerCase().trim(); 
    
    if (searchText.length > 0) {
        currentPlaylist = MASTER_TRACK_LIST.filter(track => { 
            const itemText = (track.title + ' ' + track.artist).toLowerCase(); 
            return itemText.includes(searchText);
        });
        
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId); 
            listenIntervalId = null;
        }

        if (currentPlaylist.length === 0) {
            playerTitle.textContent = `æœªæ‰¾åˆ°èˆ‡ "${searchText}" ç›¸é—œçš„æ­Œæ›²ã€‚`;
            audio.pause(); 
            currentTrackIndex = -1;
            
        } else {
             playerTitle.textContent = `å·²æ ¹æ“šç¯©é¸å»ºç«‹æ–°æ­Œå–® (${currentPlaylist.length} é¦–)ã€‚è«‹é»æ“Šæ’­æ”¾ã€‚`;
             currentTrackIndex = 0; 
             const track = currentPlaylist[currentTrackIndex]; 
             audio.src = track.url; 
             audio.pause(); 
        }

    } else {
        resetCurrentPlaylist(); 
        playerTitle.textContent = "æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨";
        
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId); 
            listenIntervalId = null;
        }
        
        currentTrackIndex = 0; 
        const track = currentPlaylist[currentTrackIndex]; 
        audio.src = track.url;
        audio.pause(); 
    }

    playlistItems.forEach(item => {
        const itemText = item.textContent.toLowerCase(); 
        if (itemText.includes(searchText) || searchText.length === 0) {
            item.style.display = ''; 
        } else {
            item.style.display = 'none';
        }
    });

    updatePlaylistHighlight(); 
}

// --- æ’­æ”¾åˆ—è¡¨é¡¯ç¤ºèˆ‡æ’åºé‚è¼¯ ---

function updatePlaylistDisplay() {
    const currentListItems = document.querySelectorAll('#playlist li'); 
    
    currentListItems.forEach(item => {
        const onclickAttr = item.getAttribute('onclick');
        const match = onclickAttr.match(/loadTrack\((\d+)\)/);
        const index = match ? parseInt(match[1]) : -1;
        
        if (index === -1) return;
        
        const track = MASTER_TRACK_LIST[index];
        const originalText = track.title + ' - ' + track.artist;
        const playCount = trackPlayCounts[index] || 0;
        
        item.innerHTML = '';
        
        const mainSpan = document.createElement('span');
        mainSpan.textContent = originalText;
        item.appendChild(mainSpan);
        
        if (playCount > 0) {
            const countSpan = document.createElement('small');
            countSpan.textContent = ` (${playCount} æ¬¡æ’­æ”¾)`;
            
            countSpan.style.fontSize = '0.8em'; 
            countSpan.style.color = '#888'; 
            countSpan.style.marginLeft = '10px';
            
            item.appendChild(countSpan);
        }
    });
}

function sortPlaylistByPlayCount() {
    const sortableList = [...MASTER_TRACK_LIST].map(track => {
        const count = trackPlayCounts[track.originalIndex] || 0;
        return { ...track, playCount: count };
    });

    sortableList.sort((a, b) => {
        if (b.playCount !== a.playCount) {
            return b.playCount - a.playCount;
        }
        return a.originalIndex - b.originalIndex; 
    });

    const playlistUl = document.getElementById('playlist');
    const originalLiElements = Array.from(playlistUl.querySelectorAll('li'));

    playlistUl.innerHTML = '';

    sortableList.forEach(track => {
        const originalIndex = track.originalIndex;
        const liElement = originalLiElements.find(item => {
            const onclickAttr = item.getAttribute('onclick');
            const match = onclickAttr.match(/loadTrack\((\d+)\)/);
            return match && parseInt(match[1]) === originalIndex;
        });

        if (liElement) {
            playlistUl.appendChild(liElement);
        }
    });
    
    playlistItems = document.querySelectorAll('#playlist li'); 

    updatePlaylistDisplay();
    updatePlaylistHighlight();
}


// --- *** LocalStorage é‚è¼¯ *** ---

const CURRENT_TRACK_INDEX_KEY = 'audioPlayerIndex';
const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

function saveSettings() {
    try {
        localStorage.setItem('audioPlayerVolume', audio.volume);
        localStorage.setItem('audioPlayerMuted', audio.muted);
        localStorage.setItem('audioPlayerMode', playMode); 

        if (currentTrackIndex >= 0) {
            localStorage.setItem(CURRENT_TRACK_INDEX_KEY, currentTrackIndex);
        } else {
            localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
        }

        if (audio.currentTime > 0) {
             localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
        } else {
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
        }
        
    } catch (e) {
        console.warn('LocalStorage is not available or blocked.', e);
    }
}

function loadSavedSettings() {
    try {
        const savedVolume = localStorage.getItem('audioPlayerVolume');
        if (savedVolume !== null) {
            audio.volume = Math.max(0, Math.min(1, parseFloat(savedVolume)));
        }
        const savedMuted = localStorage.getItem('audioPlayerMuted');
        if (savedMuted !== null) {
            audio.muted = (savedMuted === 'true');
        }

        const savedMode = localStorage.getItem('audioPlayerMode');
        if (savedMode !== null) {
            const mode = parseInt(savedMode);
            if (mode >= 0 && mode <= 4) { 
                playMode = mode;
                updateModeUI(); 
            }
        }
        
        const savedIndex = localStorage.getItem(CURRENT_TRACK_INDEX_KEY);
        if (savedIndex !== null) {
            const index = parseInt(savedIndex);
            if (index >= 0 && index < MASTER_TRACK_LIST.length) { 
                currentTrackIndex = index;
                const track = MASTER_TRACK_LIST[index]; 
                audio.src = track.url;
                playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
            }
        }

        const savedTime = localStorage.getItem(CURRENT_TRACK_TIME_KEY);
        if (savedTime !== null && currentTrackIndex >= 0) { 
             const time = parseFloat(savedTime);
             if (!isNaN(time) && time > 0) {
                 audio.currentTime = time;
             }
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY); 
        }
        
        const savedCounts = localStorage.getItem(PLAY_COUNT_STORAGE_KEY);
        if (savedCounts) {
            trackPlayCounts = JSON.parse(savedCounts);
        }
        
    } catch (e) {
        console.warn('Failed to load settings from LocalStorage.', e);
    }
}


// --- *** URL éŒ¨é»è™•ç†é‚è¼¯ (å„ªåŒ–è¼‰å…¥é€Ÿåº¦çš„æœ€çµ‚ä¿®è¨‚ç‰ˆ) *** ---
function handleUrlAnchor() {
    const hash = window.location.hash;

    if (hash.startsWith('#song-index-')) {
        const parts = hash.split('-');
        const originalIndex = parseInt(parts[parts.length - 1]);

        if (!isNaN(originalIndex) && originalIndex >= 0 && originalIndex < MASTER_TRACK_LIST.length) {
            
            const trackTitle = MASTER_TRACK_LIST[originalIndex].title;
            
            // 1. è¼‰å…¥æ­Œæ›²ã€‚é€™æœƒè§¸ç™¼ loadTrackï¼ŒloadTrack æœƒå°‡æ¨¡å¼è¨­ç‚º 3 ä¸¦ç«‹å³å˜—è©¦æ’­æ”¾ã€‚
            loadTrack(originalIndex); 
            
            // 2. ç«‹å³å°‡æ¨¡å¼è¨­å› 0 (åˆ†äº«é€£çµçš„é æœŸæ¨¡å¼)ï¼Œä¸¦æ›´æ–° UI å’Œå„²å­˜
            playMode = 0; 
            updateModeUI();
            saveSettings();
            
            // 3. è¨­ç½®å‹å¥½çš„ç·©è¡æç¤º
            playerTitle.textContent = `å¾åˆ†äº«é€£çµè¼‰å…¥ï¼š${trackTitle} (æ­£åœ¨ç·©è¡...)`;

            // 4. ç›£è½ã€ŒçœŸæ­£é–‹å§‹æ’­æ”¾ã€äº‹ä»¶ï¼Œä»¥æ¸…é™¤ç·©è¡æç¤º
            const handlePlaying = () => {
                 // ç¢ºä¿åªè™•ç†ç•¶å‰æ­Œæ›²
                 if (playerTitle.textContent.includes(trackTitle)) { 
                     playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${trackTitle}`;
                     audio.removeEventListener('playing', handlePlaying);
                 }
            };
            audio.addEventListener('playing', handlePlaying);
            
            // 5. å¦‚æœç€è¦½å™¨é˜»æ­¢äº†è‡ªå‹•æ’­æ”¾ï¼Œé€šé play() çš„ Promise catch è™•ç†
            audio.play().catch(error => {
                 playerTitle.textContent = `å¾åˆ†äº«è¼‰å…¥ï¼š${trackTitle} (éœ€é»æ“Šæ’­æ”¾)`;
            });
        }
    }
}
// ------------------------------------

// --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---

audio.addEventListener('volumechange', saveSettings);
audio.addEventListener('ratechange', saveSettings); 
audio.addEventListener('loadedmetadata', saveSettings); 

audio.addEventListener('timeupdate', () => {
    if (!audio.paused && audio.currentTime % 5 < 1) {
         saveSettings();
    }
});

audio.addEventListener('play', saveSettings);
audio.addEventListener('pause', saveSettings);
audio.addEventListener('ended', saveSettings);

playlistSearchInput.addEventListener('input', debounce(filterPlaylist, 300));


// --- åˆå§‹åŒ– ---

resetCurrentPlaylist(); 

loadSavedSettings();

if(playMode === 0 && !localStorage.getItem('audioPlayerMode')) {
    updateModeUI();
}

// åœ¨è¼‰å…¥å„²å­˜è¨­ç½®å¾Œï¼Œç«‹å³æª¢æŸ¥ URL éŒ¨é»
handleUrlAnchor();

sortPlaylistByPlayCount(); 

initializeTheme();
</script>
