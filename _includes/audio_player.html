<div id="custom-audio-player">
    <h3>我的音樂播放器</h3>
    
<audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        您的瀏覽器不支持 HTML5 音頻。
    </audio>
    
<div id="player-controls">
        <span id="mode-button" onclick="togglePlayMode()">
            [ 模式: 順序 ]
        </span>
        
        <div id="sleep-timer-area">
            <button id="timer-toggle-btn" onclick="toggleTimerMenu()">
                定時 (未設定)
            </button>
            
            <div id="timer-menu" class="hidden-menu">
                <span class="menu-item" onclick="setSleepTimer(10)">10 分鐘後關閉</span>
                <span class="menu-item" onclick="setSleepTimer(30)">30 分鐘後關閉</span>
                <span class="menu-item" onclick="setSleepTimer(60)">60 分鐘後關閉</span>
                <span class="menu-item" onclick="clearSleepTimer()">取消定時</span>
            </div>
        </div>
        </div>
    
    <div id="stats-bar">
        <span>總時長: <span id="total-listen-time">0 分鐘</span></span>
        <span>剩餘: <span id="remaining-timer">--:--</span></span>
    </div>
    
    <ul id="playlist">


    {% for track in site.data.music %}
        <li data-url="{{ track.url }}" onclick="loadTrack('{{ track.url }}', '{{ track.title }}', {{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
</div>


<script>
// 獲取 DOM 元素
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
const playlistItems = document.querySelectorAll('#playlist li'); 
const modeButton = document.getElementById('mode-button'); 

// 新增 DOM 元素
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');


// 1. 準備數據和狀態追蹤
const trackList = [
{% for track in site.data.music %}
    { title: "{{ track.title | escape }}", url: "{{ track.url | escape }}" },
{% endfor %}
];

let currentTrackIndex = 0; 
let playMode = 0; 

// 定時器狀態變數
let sleepTimerId = null; // 用於 clearTimeout 的 ID
let sleepTime = 0; // 設置的總定時長度 (秒)
let endTime = 0; // 定時器結束的時間戳 (毫秒)
let countdownIntervalId = null; // 用於每秒更新倒數的 Interval ID

// 總時長追蹤變數
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; // 用於每秒更新總時長的 Interval ID


// --- 輔助函數 (playTrack, getNextRandomIndex, updatePlaylistHighlight 保持不變) ---

// ... (playTrack, getNextRandomIndex, updatePlaylistHighlight 函數保持不變) ...

// 載入並播放指定索引的歌曲
function playTrack(index) {
    if (index >= 0 && index < trackList.length) {
        currentTrackIndex = index;
        const track = trackList[index];
        audio.src = track.url;
        playerTitle.textContent = `正在播放：${track.title}`;
        audio.play().catch(error => {
            console.error("自動播放失敗，可能是瀏覽器限制：", error);
        });
        updatePlaylistHighlight();
    } else if (index === trackList.length) {
        // 播放到列表結束
        audio.pause(); 
        playerTitle.textContent = "播放列表已結束";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    }
}

// 新增隨機播放邏輯 (保持不變)
function getNextRandomIndex() {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * trackList.length);
    } while (newIndex === currentTrackIndex && trackList.length > 1);
    
    return newIndex;
}

// 更新播放列表的高亮狀態 (保持不變)
function updatePlaylistHighlight() {
    playlistItems.forEach((item, index) => {
        item.classList.remove('playing');
        if (index === currentTrackIndex) {
            item.classList.add('playing');
        }
    });
}


// --- 核心邏輯：控制播放順序/循環/隨機 (保持不變) ---
audio.addEventListener('ended', () => { /* ... 邏輯保持不變 ... */ });
function togglePlayMode() { /* ... 邏輯保持不變 ... */ }


// --- *** 新增 UI/定時器/統計邏輯 *** ---

// 展開/收縮定時器菜單
function toggleTimerMenu() {
    timerMenu.classList.toggle('hidden-menu');
}

// 設置定時器 (Sleep Timer)
function setSleepTimer(minutes) {
    // 1. 清除舊的計時器和 Interval
    clearSleepTimer();
    toggleTimerMenu(); // 設置後收起菜單

    const delayMilliseconds = minutes * 60 * 1000;
    
    // 設置狀態變數
    sleepTime = minutes * 60;
    endTime = Date.now() + delayMilliseconds;

    // 2. 設置定時暫停
    sleepTimerId = setTimeout(() => {
        audio.pause(); 
        playerTitle.textContent = `定時器到期，已暫停播放 (${minutes} 分鐘)`;
        clearSleepTimer(); // 清除自身
    }, delayMilliseconds);
    
    // 3. 設置每秒倒數更新
    countdownIntervalId = setInterval(updateTimerCountdown, 1000);

    // 4. 更新 UI 提示
    timerToggleButton.textContent = `定時 (${minutes} 分鐘)`;
    playerTitle.textContent = `定時器已設置：${minutes} 分鐘後自動關閉`;

    if (audio.paused) {
        audio.play();
    }
}

// 取消定時器
function clearSleepTimer() {
    if (sleepTimerId !== null) {
        clearTimeout(sleepTimerId);
        sleepTimerId = null;
    }
    if (countdownIntervalId !== null) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
    }
    
    sleepTime = 0;
    endTime = 0;
    timerToggleButton.textContent = "定時 (未設定)";
    remainingTimerSpan.textContent = "--:--";
    playerTitle.textContent = "已取消定時器";
}


// 更新剩餘時間倒數
function updateTimerCountdown() {
    if (endTime > 0) {
        const remainingMs = endTime - Date.now();
        const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
        
        const minutes = Math.floor(remainingS / 60);
        const seconds = remainingS % 60;
        
        remainingTimerSpan.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        if (remainingS === 0) {
            clearSleepTimer(); // 時間到，UI 重設
        }
    }
}

// 播放/暫停事件：控制總時長統計
audio.addEventListener('play', () => {
    // 開始計時
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
});

audio.addEventListener('pause', () => {
    // 暫停計時
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
});

// 更新總聽歌時長
function updateTotalListenTime() {
    totalListenSeconds++;
    if (totalListenSeconds >= 60) {
        totalListenMinutes++;
        totalListenSeconds = 0;
    }
    
    totalListenTimeSpan.textContent = 
        `${totalListenMinutes} 分鐘 ${totalListenSeconds} 秒`;
}


// --- 外部呼叫函數 (保持不變) ---
function loadTrack(url, title, index) { /* ... 邏輯保持不變 ... */ }


// 初始化
updatePlaylistHighlight();

</script>
