<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
<div id="player-controls">
    <span id="mode-button" onclick="togglePlayMode()">
        [ æ¨¡å¼: é †åº ]
    </span>
    
    <div id="theme-switcher">
    <button id="theme-toggle-btn">
        ä¸»é¡Œ (ç•¶å‰: <span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>)
    </button>
<div id="theme-menu" class="hidden-menu">
    <span class="theme-option" data-theme="light">ç™½è‰²</span>
    <span class="theme-option" data-theme="dark">é»‘è‰²</span>
    <span class="theme-option" data-theme="grey">ç°è‰²</span>
    <span class="theme-option" data-theme="blue">è—è‰²</span>
    <span class="theme-option" data-theme="green">ç¶ è‰²</span>
    <span class="theme-option" data-theme="purple">ç´«è‰²</span>
    <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
    <span class="theme-option" data-theme="red">ç´…è‰²</span>
</div>
</div>

    <div id="sleep-timer-area">
        <button id="timer-toggle-btn" onclick="toggleTimerMenu()">
            å®šæ™‚ (æœªè¨­å®š)
        </button>
        
        <div id="timer-menu" class="hidden-menu">
            <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
        </div>
    </div>
</div> 

<div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>
    
<ul id="playlist">

    {% for track in site.data.music %}
        <li data-url="{{ track.url }}" onclick="loadTrack('{{ track.url }}', '{{ track.title }}', {{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
</div>


<script>
// ç²å– DOM å…ƒç´ 
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
const playlistItems = document.querySelectorAll('#playlist li'); 
const modeButton = document.getElementById('mode-button'); 

// æ–°å¢ DOM å…ƒç´ 
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');
const playlistSearchInput = document.getElementById('playlist-search'); 

// *** ä¸»é¡Œåˆ‡æ›ç›¸é—œ DOM å…ƒç´  (é ‚å±¤å®šç¾©) ***
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const themeMenu = document.getElementById('theme-menu');
const currentThemeName = document.getElementById('current-theme-name');
const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
    
    
// 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
const MASTER_TRACK_LIST = [ 
{% for track in site.data.music %}
    // å¢åŠ ä¸€å€‹åŸå§‹ç´¢å¼• (originalIndex)ï¼Œç”¨æ–¼å°‡ä¾†å›æº¯æˆ–å»ç¯©é¸æ™‚å®šä½
    { title: "{{ track.title | escape }}", artist: "{{ track.artist | escape }}", url: "{{ track.url | escape }}", originalIndex: {{ forloop.index0 }} },
{% endfor %}
];

let currentPlaylist = []; 
let currentTrackIndex = 0; 
// æ’­æ”¾æ¨¡å¼ï¼š0=é †åº, 1=å¾ªç’°, 2=éš¨æ©Ÿ, 3=è‡ªç”±(æ’­å®Œå³åœ)
let playMode = 0; 

// å®šæ™‚å™¨ç‹€æ…‹è®Šæ•¸
let sleepTimerId = null; 
let sleepTime = 0; 
let endTime = 0; 
let countdownIntervalId = null; 

// ç¸½æ™‚é•·è¿½è¹¤è®Šæ•¸
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; 


// --- *** é˜²æŠ–è¼”åŠ©å‡½æ•¸ *** ---
/**
 * é˜²æŠ–å‡½æ•¸ï¼šé™åˆ¶ä¸€å€‹å‡½æ•¸åœ¨ç‰¹å®šæ™‚é–“å…§åªèƒ½åŸ·è¡Œä¸€æ¬¡
 */
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}


// --- *** æ­Œå–®é‡ç½®èˆ‡åˆå§‹åŒ– *** ---

/**
 * å°‡ç•¶å‰æ’­æ”¾æ­Œå–®é‡è¨­ç‚ºæ•´å€‹ä¸»æ­Œå–® (åœ¨æ¸…é™¤æœå°‹æ™‚ä½¿ç”¨)
 */
function resetCurrentPlaylist() {
    currentPlaylist = [...MASTER_TRACK_LIST]; 
}


// --- è¼”åŠ©å‡½æ•¸ ---

// è¼‰å…¥ä¸¦æ’­æ”¾æŒ‡å®šç´¢å¼•çš„æ­Œæ›²
function playTrack(index) {
    // ç¢ºä¿ç´¢å¼•åœ¨ç•¶å‰æ­Œå–®çš„ç¯„åœå…§
    if (index >= 0 && index < currentPlaylist.length) { 
        currentTrackIndex = index;
        const track = currentPlaylist[index]; 
        audio.src = track.url;
        playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
        audio.play().catch(error => {
            console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
        });
        updatePlaylistHighlight();
    } else if (index === currentPlaylist.length) { 
        audio.pause(); 
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    }
}

// ç²å–éš¨æ©Ÿç´¢å¼•
function getNextRandomIndex() {
    let newIndex;
    do {
        // éš¨æ©Ÿæ•¸åŸºæ–¼ currentPlaylist çš„é•·åº¦
        newIndex = Math.floor(Math.random() * currentPlaylist.length); 
    } while (newIndex === currentTrackIndex && currentPlaylist.length > 1);
    
    return newIndex;
}

// æ›´æ–°æ’­æ”¾åˆ—è¡¨çš„é«˜äº®ç‹€æ…‹
function updatePlaylistHighlight() {
    // ç²å–ç•¶å‰æ’­æ”¾æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
    const playingOriginalIndex = currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length 
        ? currentPlaylist[currentTrackIndex].originalIndex 
        : -1;

    playlistItems.forEach((item, index) => {
        item.classList.remove('playing');
        // æ¯”è¼ƒç•¶å‰åˆ—è¡¨é …çš„ç´¢å¼•å’Œæ­£åœ¨æ’­æ”¾æ­Œæ›²çš„åŸå§‹ç´¢å¼•
        if (index === playingOriginalIndex) { 
            item.classList.add('playing');
        }
    });
}


// --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± ---

audio.addEventListener('ended', () => {
    if (playMode === 1) {
        audio.currentTime = 0; 
        audio.play();
    } else if (playMode === 2) {
        const nextIndex = getNextRandomIndex();
        playTrack(nextIndex);
    } else if (playMode === 3) {
        audio.pause();
        playerTitle.textContent = "è‡ªç”±æ¨¡å¼ä¸‹ï¼Œç•¶å‰æ­Œæ›²æ’­æ”¾å®Œç•¢ã€‚";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    } 
    else {
        if (currentTrackIndex < currentPlaylist.length - 1) { 
            playTrack(currentTrackIndex + 1); 
        } else {
            playTrack(currentPlaylist.length); 
        }
    }
});


// æ¨¡å¼åˆ‡æ›å‡½æ•¸
function togglePlayMode() {
    playMode = (playMode + 1) % 4; 
    
    let modeText;
    let titleMessage;
    
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å¾ªç’° ]";
        titleMessage = "å·²åˆ‡æ›åˆ°å–®æ›²å¾ªç’°æ¨¡å¼";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
        titleMessage = "å·²åˆ‡æ›åˆ°éš¨æ©Ÿæ’­æ”¾æ¨¡å¼";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
        titleMessage = "å·²åˆ‡æ›åˆ°è‡ªç”±æ’­æ”¾æ¨¡å¼ (æ’­å®Œå³åœ)";
    } else {
        modeText = "[ æ¨¡å¼: é †åº ]";
        titleMessage = "å·²åˆ‡æ›åˆ°é †åºæ’­æ”¾æ¨¡å¼";
    }
    
    modeButton.textContent = modeText;
    playerTitle.textContent = titleMessage;

    // å„²å­˜æ’­æ”¾æ¨¡å¼åˆ° localStorage
    saveSettings(); 
}


// --- *** ä¸»é¡Œåˆ‡æ›é‚è¼¯ (ä¿æŒä¸è®Š) *** ---

const THEME_STORAGE_KEY = 'userThemePreference';
const LIGHT_THEME = 'light'; 
const DARK_THEME = 'dark';   
const GREY_THEME = 'grey';   
const BLUE_THEME = 'blue';
const GREEN_THEME = 'green';
const PURPLE_THEME = 'purple';
const PINK_THEME = 'pink';
const RED_THEME = 'red';
    
/**
 * è¨­ç½®ä¸»é¡Œé¡åä¸¦æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
 */
function applyTheme(desiredTheme, isManual = false) {
    const body = document.body;
    let displayName = '';
    
    // 1. æ¸…é™¤æ‰€æœ‰ä¸»é¡Œé¡å (ç¢ºä¿åªæ‡‰ç”¨ä¸€å€‹ä¸»é¡Œ)
    body.classList.remove(
        DARK_THEME + '-theme', 
        GREY_THEME + '-theme',
        BLUE_THEME + '-theme',
        GREEN_THEME + '-theme',
        PURPLE_THEME + '-theme', 
        PINK_THEME + '-theme',   
        RED_THEME + '-theme'     
    );

    let themeToApply = desiredTheme;
    let modeText = '(æ‰‹å‹•)'; 

    // 2. è™•ç†å„²å­˜/è‡ªå‹•æ¨¡å¼ (ä¿æŒä¸è®Š)
    if (isManual) {
        localStorage.setItem(THEME_STORAGE_KEY, desiredTheme);
    } 
    else if (desiredTheme === LIGHT_THEME) {
        themeToApply = getSystemThemeBasedOnTime();
        modeText = '(è‡ªå‹•)';
    }

    // 3. æ ¹æ“šæœ€çµ‚ç¢ºå®šçš„ä¸»é¡Œ themeToApply æ‡‰ç”¨é¡å
    if (themeToApply === DARK_THEME) {
        body.classList.add(DARK_THEME + '-theme');
        displayName = 'é»‘è‰²';
    } else if (themeToApply === GREY_THEME) {
        body.classList.add(GREY_THEME + '-theme');
        displayName = 'ç°è‰²';
    } else if (themeToApply === BLUE_THEME) {
        body.classList.add(BLUE_THEME + '-theme');
        displayName = 'è—è‰²';
    } else if (themeToApply === GREEN_THEME) {
        body.classList.add(GREEN_THEME + '-theme');
        displayName = 'ç¶ è‰²';
    } else if (themeToApply === PURPLE_THEME) { 
        body.classList.add(PURPLE_THEME + '-theme');
        displayName = 'ç´«è‰²';
    } else if (themeToApply === PINK_THEME) { 
        body.classList.add(PINK_THEME + '-theme');
        displayName = 'ç²‰è‰²';
    } else if (themeToApply === RED_THEME) { 
        body.classList.add(RED_THEME + '-theme');
        displayName = 'ç´…è‰²';
    } else { 
        displayName = 'ç™½è‰²';
    }
    
    // 4. æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
    currentThemeName.textContent = `${displayName} ${modeText}`;
}


/**
 * æ ¹æ“šç•¶åœ°æ™‚é–“åˆ¤æ–·æ‡‰è©²ä½¿ç”¨æ·ºè‰²é‚„æ˜¯æ·±è‰²
 */
function getSystemThemeBasedOnTime() {
    const hour = new Date().getHours();
    return (hour >= 19 || hour < 7) ? DARK_THEME : LIGHT_THEME;
}

/**
 * åˆå§‹åŒ–ä¸»é¡Œï¼šå¾ localStorage è®€å–æˆ–æ ¹æ“šæ™‚é–“è‡ªå‹•åˆ¤æ–·
 */
function initializeTheme() {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme) {
        if (storedTheme === LIGHT_THEME) {
             applyTheme(LIGHT_THEME, false); 
        } else {
             applyTheme(storedTheme, true); 
        }
    } else {
        applyTheme(LIGHT_THEME, false);
    }
}

// --- ä¸»é¡Œ/å®šæ™‚å™¨äº‹ä»¶ç›£è½å™¨ (ä¿æŒä¸è®Š) ---

themeToggleBtn.addEventListener('click', (event) => {
    event.stopPropagation(); 
    themeMenu.classList.toggle('hidden-menu');
});

themeOptions.forEach(option => {
    option.addEventListener('click', (e) => {
        const selectedTheme = e.target.getAttribute('data-theme');
        applyTheme(selectedTheme, true); 
        themeMenu.classList.add('hidden-menu'); 
    });
});

document.addEventListener('click', (e) => {
    if (!themeMenu.contains(e.target) && !themeToggleBtn.contains(e.target)) {
        themeMenu.classList.add('hidden-menu');
    }
    if (!timerMenu.contains(e.target) && !timerToggleButton.contains(e.target)) {
        if (!timerMenu.classList.contains('hidden-menu')) {
            timerMenu.classList.add('hidden-menu');
        }
    }
});

setInterval(() => {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme === LIGHT_THEME) {
        applyTheme(LIGHT_THEME, false); 
    }
}, 1000 * 60 * 60); 
    
// --- å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ (ä¿æŒä¸è®Š) ---

function toggleTimerMenu() {
    timerMenu.classList.toggle('hidden-menu');
}

function setSleepTimer(minutes) {
    clearSleepTimer();
    toggleTimerMenu(); 

    const delayMilliseconds = minutes * 60 * 1000;
    
    sleepTime = minutes * 60;
    endTime = Date.now() + delayMilliseconds;

    sleepTimerId = setTimeout(() => {
        audio.pause(); 
        playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾ (${minutes} åˆ†é˜)`;
        clearSleepTimer(); 
    }, delayMilliseconds);
    
    countdownIntervalId = setInterval(updateTimerCountdown, 1000);

    timerToggleButton.textContent = `å®šæ™‚ (${minutes} åˆ†é˜)`;
    playerTitle.textContent = `å®šæ™‚å™¨å·²è¨­ç½®ï¼š${minutes} åˆ†é˜å¾Œè‡ªå‹•é—œé–‰`;

    if (audio.paused) {
        audio.play();
    }
}

function clearSleepTimer() {
    if (sleepTimerId !== null) {
        clearTimeout(sleepTimerId);
        sleepTimerId = null;
    }
    if (countdownIntervalId !== null) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
    }
    
    sleepTime = 0;
    endTime = 0;
    timerToggleButton.textContent = "å®šæ™‚ (æœªè¨­å®š)";
    remainingTimerSpan.textContent = "--:--";
    playerTitle.textContent = "å·²å–æ¶ˆå®šæ™‚å™¨";
}

function updateTimerCountdown() {
    if (endTime > 0) {
        const remainingMs = endTime - Date.now();
        const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
        
        const minutes = Math.floor(remainingS / 60);
        const seconds = remainingS % 60;
        
        remainingTimerSpan.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        if (remainingS === 0) {
            clearSleepTimer(); 
            if (!audio.paused) {
                 audio.pause();
                 playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾`;
            }
        }
    }
}


audio.addEventListener('play', () => {
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
});

audio.addEventListener('pause', () => {
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
});

function updateTotalListenTime() {
    totalListenSeconds++;
    if (totalListenSeconds >= 60) {
        totalListenMinutes++;
        totalListenSeconds = 0;
    }
    
    totalListenTimeSpan.textContent = 
        `${totalListenMinutes} åˆ†é˜ ${totalListenSeconds} ç§’`;
}


// --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ä¾†è‡ªåˆ—è¡¨é»æ“Š) ---

function loadTrack(url, title, originalIndex) { 
    if (playMode !== 3) {
        playMode = 3;
        modeButton.textContent = "[ æ¨¡å¼: è‡ªç”± ]";
        playerTitle.textContent = "å·²åˆ‡æ›åˆ°è‡ªç”±æ’­æ”¾æ¨¡å¼ (é»æ“Šåˆ—è¡¨)";
        saveSettings(); 
    }
    
    const newIndex = currentPlaylist.findIndex(track => track.originalIndex === originalIndex);

    if (newIndex !== -1) {
        playTrack(newIndex);
    } else {
        resetCurrentPlaylist();
        playTrack(originalIndex);
    }
}


// --- *** æœå°‹/ç¯©é¸é‚è¼¯ (é‡æ§‹ç‚ºå‹•æ…‹æ­Œå–®) *** ---
/**
 * æ ¹æ“šæœå°‹æ¡†çš„è¼¸å…¥å…§å®¹ï¼Œç¯©é¸ä¸¦é¡¯ç¤º/éš±è—æ’­æ”¾åˆ—è¡¨é …ç›®ï¼ŒåŒæ™‚é‡å»º currentPlaylist
 */
function filterPlaylist() {
    const searchText = playlistSearchInput.value.toLowerCase().trim(); 
    
    // 1. ç¯©é¸ Master Listï¼Œé‡å»º currentPlaylist
    if (searchText.length > 0) {
        currentPlaylist = MASTER_TRACK_LIST.filter(track => { 
            const itemText = (track.title + ' ' + track.artist).toLowerCase(); 
            return itemText.includes(searchText);
        });
        
        if (currentPlaylist.length === 0) {
            playerTitle.textContent = `æœªæ‰¾åˆ°èˆ‡ "${searchText}" ç›¸é—œçš„æ­Œæ›²ã€‚`;
            audio.pause(); 
            currentTrackIndex = -1;
        } else {
             // âœ… ä¿®æ­£ï¼šåªè¼‰å…¥ç¬¬ä¸€é¦–æ­Œæ›²ï¼Œä¸è‡ªå‹•æ’­æ”¾ï¼
             playerTitle.textContent = `å·²æ ¹æ“šç¯©é¸å»ºç«‹æ–°æ­Œå–® (${currentPlaylist.length} é¦–)ã€‚è«‹é»æ“Šæ’­æ”¾ã€‚`;
             currentTrackIndex = 0; 
             const track = currentPlaylist[currentTrackIndex]; 
             audio.src = track.url; // åªè¼‰å…¥ï¼Œä¸æ’­æ”¾
             audio.pause(); // ç¢ºä¿åœæ­¢æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²
        }

    } else {
        // æœå°‹æ¡†ç‚ºç©ºï¼Œé‡è¨­ç‚ºå®Œæ•´æ­Œå–®
        resetCurrentPlaylist(); 
        playerTitle.textContent = "æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨";
        
        // ç•¶æ¸…é™¤æœå°‹æ™‚ï¼Œå¦‚æœæ’­æ”¾å™¨è™•æ–¼æš«åœç‹€æ…‹ï¼Œå‰‡ç¹¼çºŒæš«åœï¼Œä¸¦è¼‰å…¥ç¬¬ä¸€é¦–
        currentTrackIndex = 0; 
        const track = currentPlaylist[currentTrackIndex]; 
        audio.src = track.url;
        audio.pause(); // ä¿æŒæš«åœç‹€æ…‹
    }

    // 2. æ›´æ–° HTML åˆ—è¡¨çš„é¡¯ç¤º/éš±è—ç‹€æ…‹
    playlistItems.forEach(item => {
        const itemText = item.textContent.toLowerCase(); 
        if (itemText.includes(searchText) || searchText.length === 0) {
            item.style.display = ''; 
        } else {
            item.style.display = 'none';
        }
    });

    // 3. ç¢ºä¿é«˜äº®ç‹€æ…‹æ­£ç¢º (å› ç‚º currentPlaylist å·²è®Šï¼Œå¿…é ˆæ›´æ–°)
    updatePlaylistHighlight(); 
}


// --- *** LocalStorage é‚è¼¯ (æŒä¹…åŒ–ï¼šæ¨¡å¼/ä¸»é¡Œ/éŸ³é‡/éœéŸ³/é€²åº¦) *** ---

const CURRENT_TRACK_INDEX_KEY = 'audioPlayerIndex';
const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

function saveSettings() {
    try {
        localStorage.setItem('audioPlayerVolume', audio.volume);
        localStorage.setItem('audioPlayerMuted', audio.muted);
        localStorage.setItem('audioPlayerMode', playMode);

        if (currentTrackIndex >= 0) {
            localStorage.setItem(CURRENT_TRACK_INDEX_KEY, currentTrackIndex);
        } else {
            localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
        }

        if (audio.currentTime > 0) {
             localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
        } else {
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
        }
        
    } catch (e) {
        console.warn('LocalStorage is not available or blocked.', e);
    }
}

function loadSavedSettings() {
    try {
        const savedVolume = localStorage.getItem('audioPlayerVolume');
        if (savedVolume !== null) {
            audio.volume = Math.max(0, Math.min(1, parseFloat(savedVolume)));
        }
        const savedMuted = localStorage.getItem('audioPlayerMuted');
        if (savedMuted !== null) {
            audio.muted = (savedMuted === 'true');
        }

        const savedMode = localStorage.getItem('audioPlayerMode');
        if (savedMode !== null) {
            const mode = parseInt(savedMode);
            if (mode >= 0 && mode <= 3) {
                playMode = mode;
                updateModeUI(); 
            }
        }
        
        const savedIndex = localStorage.getItem(CURRENT_TRACK_INDEX_KEY);
        if (savedIndex !== null) {
            const index = parseInt(savedIndex);
            if (index >= 0 && index < MASTER_TRACK_LIST.length) { 
                currentTrackIndex = index;
                const track = MASTER_TRACK_LIST[index]; 
                audio.src = track.url;
                playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
            }
        }

        const savedTime = localStorage.getItem(CURRENT_TRACK_TIME_KEY);
        if (savedTime !== null && currentTrackIndex >= 0) { 
             const time = parseFloat(savedTime);
             if (!isNaN(time) && time > 0) {
                 audio.currentTime = time;
             }
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY); 
        }
        
    } catch (e) {
        console.warn('Failed to load settings from LocalStorage.', e);
    }
}

function updateModeUI() {
    let modeText;
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å¾ªç’° ]";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
    } else {
        modeText = "[ æ¨¡å¼: é †åº ]";
    }
    modeButton.textContent = modeText;
}


// --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---

audio.addEventListener('volumechange', saveSettings);
audio.addEventListener('ratechange', saveSettings); 
audio.addEventListener('loadedmetadata', saveSettings); 

audio.addEventListener('timeupdate', () => {
    if (!audio.paused && audio.currentTime % 5 < 1) {
         saveSettings();
    }
});

audio.addEventListener('play', saveSettings);
audio.addEventListener('pause', saveSettings);
audio.addEventListener('ended', saveSettings);

// âœ… ä¿®æ­£ï¼šä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬ä¾†ç›£è½è¼¸å…¥äº‹ä»¶ï¼Œé˜²æ­¢åœ¨æ‰“å­—æ™‚æ­Œæ›²è‡ªå‹•æ’­æ”¾
playlistSearchInput.addEventListener('input', debounce(filterPlaylist, 300));


// --- åˆå§‹åŒ– ---

// é—œéµï¼šåœ¨è¼‰å…¥ä»»ä½•æ±è¥¿ä¹‹å‰ï¼Œå…ˆå»ºç«‹ä¸»æ­Œå–®
resetCurrentPlaylist(); 

// 1. è¼‰å…¥å„²å­˜çš„è¨­å®š
loadSavedSettings();

// 2. åˆå§‹åŒ–ä¸»é¡Œè¨­å®š (è‡ªå‹•æˆ–æ‰‹å‹•)
initializeTheme();

// 3. è¼‰å…¥ä¸¦é«˜äº®ç¬¬ä¸€é¦–æ­Œ
updatePlaylistHighlight(); 

</script>
