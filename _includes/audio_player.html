<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
<div id="player-controls">
    <div id="nav-buttons-group">
        <span id="prev-button" onclick="playPreviousTrack()">
            âª ä¸Šä¸€æ›²
        </span>

        <span id="mode-button" onclick="togglePlayMode()">
            [ æ¨¡å¼: é †åº ]
        </span>
        
        <span id="next-button" onclick="playNextTrack()">
            ä¸‹ä¸€æ›² â©
        </span>
    </div>

    <div id="theme-switcher">
        <button id="theme-toggle-btn">
            ä¸»é¡Œï¼š<span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>
        </button>
        <div id="theme-menu" class="hidden-menu">
            <span class="theme-option" data-theme="light">ç™½è‰²</span>
            <span class="theme-option" data-theme="dark">é»‘è‰²</span>
            <span class="theme-option" data-theme="grey">ç°è‰²</span>
            <span class="theme-option" data-theme="blue">è—è‰²</span>
            <span class="theme-option" data-theme="green">ç¶ è‰²</span>
            <span class="theme-option" data-theme="purple">ç´«è‰²</span>
            <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
            <span class="theme-option" data-theme="red">ç´…è‰²</span>
        </div>
    </div>

    <div id="sleep-timer-area">
        <button id="timer-toggle-btn" onclick="toggleTimerMenu()">
            å®šæ™‚ (æœªè¨­å®š)
        </button>
        
        <div id="timer-menu" class="hidden-menu">
            <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
        </div>
    </div>
</div> 


<div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>

<ul id="playlist">

    {% for track in site.data.music %}
        <li onclick="loadTrack({{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
    
</div>
<script>
// ç²å– DOM å…ƒç´ 
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
let playlistItems = document.querySelectorAll('#playlist li'); 
const modeButton = document.getElementById('mode-button'); 

// æ–°å¢ DOM å…ƒç´ 
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');
const playlistSearchInput = document.getElementById('playlist-search'); 

// *** ä¸»é¡Œåˆ‡æ›ç›¸é—œ DOM å…ƒç´  ***
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const themeMenu = document.getElementById('theme-menu');
const currentThemeName = document.getElementById('current-theme-name');
const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
    
    
// 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
const MASTER_TRACK_LIST = [ 
    // å‡è¨­æ‚¨çš„ Jekyll æ•¸æ“šå·²ç¶“åœ¨é€™å€‹ä½ç½®è¢«æ¸²æŸ“ï¼Œé€™è£¡åƒ…ç‚ºçµæ§‹ä¿æŒã€‚
    // { title: "Alive in the summer time", artist: "AI", url: "...", originalIndex: 0 },
    // ...
    // è«‹æ³¨æ„ï¼šæ­¤è™•çš„ MASTER_TRACK_LIST åœ¨å¯¦éš› Jekyll ç¶²ç«™ä¸­æ˜¯é€šé for å¾ªç’°å¡«å……çš„ï¼Œ
    // ä½†åœ¨æ‚¨æä¾›çš„å–®ç¨ JS å¡Šä¸­ï¼Œæˆ‘å€‘å°‡ä½¿ç”¨æ‚¨ä¹‹å‰çµ¦å‡ºçš„ç¡¬ç·¨ç¢¼æ•¸æ“šä½œç‚ºç¤ºä¾‹ã€‚

    { title: "Alive in the summer time", artist: "AI", url: "https://raw.githubusercontent.com/xxyzyh-code/music/main/Alive in the summer time.m4a", originalIndex: 0 },
    { title: "Breakbeat background", artist: "AI", url: "https://raw.githubusercontent.com/xxyzyh-code/music/main/Breakbeat background.m4a", originalIndex: 1 },
    { title: "The best moments in life", artist: "AI", url: "https://raw.githubusercontent.com/xxyzyh-code/music/main/The best moments in life.m4a", originalIndex: 2 },
];

let currentPlaylist = []; 
let currentTrackIndex = 0; 
// æ’­æ”¾æ¨¡å¼ï¼š0=é †åºåœæ­¢, 1=å–®æ›²å¾ªç’°, 2=éš¨æ©Ÿæ’­æ”¾, 3=è‡ªç”±æ¨¡å¼, 4=é †åºå¾ªç’°
let playMode = 0; 

// å®šæ™‚å™¨ç‹€æ…‹è®Šæ•¸ (çœç•¥åˆå§‹åŒ–ï¼Œè¦‹æ‚¨ä»£ç¢¼)
let sleepTimerId = null; 
let sleepTime = 0; 
let endTime = 0; 
let countdownIntervalId = null; 

// ç¸½æ™‚é•·è¿½è¹¤è®Šæ•¸ (çœç•¥åˆå§‹åŒ–ï¼Œè¦‹æ‚¨ä»£ç¢¼)
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; 

// æ’­æ”¾æ¬¡æ•¸è¿½è¹¤è®Šæ•¸
const PLAY_COUNT_STORAGE_KEY = 'audioTrackPlayCounts'; 
let trackPlayCounts = {}; 


// --- *** é˜²æŠ–è¼”åŠ©å‡½æ•¸ *** ---
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}


// --- *** æ­Œå–®é‡ç½®èˆ‡åˆå§‹åŒ– *** ---

function resetCurrentPlaylist() {
    currentPlaylist = [...MASTER_TRACK_LIST]; 
}


// --- è¼”åŠ©å‡½æ•¸ ---

// è¼‰å…¥ä¸¦æ’­æ”¾æŒ‡å®šç´¢å¼•çš„æ­Œæ›² (çµ±ä¸€å…¥å£)
function playTrack(index) {
    // ç¢ºä¿ç´¢å¼•åœ¨ç•¶å‰æ­Œå–®çš„ç¯„åœå…§
    if (index >= 0 && index < currentPlaylist.length) { 
        currentTrackIndex = index; // â­ï¸ é—œéµ 1: æ›´æ–°ç•¶å‰ç´¢å¼•
        const track = currentPlaylist[index]; 
        audio.src = track.url;
        playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
        audio.play().catch(error => {
            console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
        });
        updatePlaylistHighlight(); // â­ï¸ é—œéµ 2: æ›´æ–°é«˜å…‰
    } else if (index === currentPlaylist.length) { 
        audio.pause(); 
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1; 
        updatePlaylistHighlight(); // â­ï¸ é—œéµ 3: åˆ—è¡¨çµæŸæ™‚æ¸…é™¤é«˜å…‰
    }
}

// ç²å–éš¨æ©Ÿç´¢å¼•
function getNextRandomIndex() {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * currentPlaylist.length); 
    } while (newIndex === currentTrackIndex && currentPlaylist.length > 1);
    
    return newIndex;
}

// *** æ’­æ”¾ä¸‹ä¸€æ›²åŠŸèƒ½ (æ‰‹å‹•åˆ‡æ­Œ) ***
function playNextTrack() {
    if (currentPlaylist.length === 0) return;
    
    let nextIndex;
    
    if (playMode === 2) { // éš¨æ©Ÿæ¨¡å¼
        nextIndex = getNextRandomIndex();
    } else { // é †åºæ¨¡å¼ (åŒ…æ‹¬ 0, 1, 3, 4)
        if (currentTrackIndex < currentPlaylist.length - 1) {
            nextIndex = currentTrackIndex + 1;
        } else if (playMode === 4 || playMode === 1) { // é †åºå¾ªç’° æˆ– å–®æ›²å¾ªç’°
            nextIndex = 0; // å›åˆ°ç¬¬ä¸€é¦–
        } else { // é †åºåœæ­¢ (0) æˆ– è‡ªç”±æ¨¡å¼ (3) - æ’­å®Œå³åœ
            audio.pause();
            playerTitle.textContent = "å·²åˆ°é”åˆ—è¡¨æœ«å°¾ã€‚";
            currentTrackIndex = currentPlaylist.length; 
            updatePlaylistHighlight();
            return;
        }
    }
    
    // çµ±ä¸€èª¿ç”¨ playTrack()
    playTrack(nextIndex);
}

// *** æ’­æ”¾ä¸Šä¸€æ›²åŠŸèƒ½ (æ‰‹å‹•åˆ‡æ­Œ) ***
function playPreviousTrack() {
    if (currentPlaylist.length === 0) return;

    let prevIndex;
    
    if (playMode === 2) { // éš¨æ©Ÿæ¨¡å¼
        prevIndex = getNextRandomIndex();
    } else { // é †åºæ¨¡å¼ (åŒ…æ‹¬ 0, 1, 3, 4)
        if (currentTrackIndex > 0) {
            prevIndex = currentTrackIndex - 1;
        } else if (playMode === 4 || playMode === 1) { // é †åºå¾ªç’° æˆ– å–®æ›²å¾ªç’°
            prevIndex = currentPlaylist.length - 1; // å›åˆ°æœ€å¾Œä¸€é¦–
        } else { // é †åºåœæ­¢ (0) æˆ– è‡ªç”±æ¨¡å¼ (3) - æ’­å®Œå³åœ
            audio.pause();
            playerTitle.textContent = "å·²åˆ°é”åˆ—è¡¨é–‹é ­ã€‚";
            currentTrackIndex = -1; 
            updatePlaylistHighlight();
            return;
        }
    }
    
    // çµ±ä¸€èª¿ç”¨ playTrack()
    playTrack(prevIndex);
}
  
// æ›´æ–°æ’­æ”¾åˆ—è¡¨çš„é«˜äº®ç‹€æ…‹ï¼Œä¸¦å¢åŠ ã€Œè‡ªå‹•æ»¾å‹•ã€åŠŸèƒ½
function updatePlaylistHighlight(manualScroll = false) {
    const listItems = document.querySelectorAll('#playlist li');
    
    listItems.forEach(item => {
        item.classList.remove('playing');
    });

    if (currentTrackIndex >= 0 && currentTrackIndex < listItems.length) {
        // å¿…é ˆæ‰¾åˆ°åˆ—è¡¨é …ä¸­èˆ‡ currentTrackIndex å°æ‡‰çš„å…ƒç´ 
        // ç”±æ–¼ currentPlaylist å¯èƒ½è¢«ç¯©é¸æˆ–æ’åºï¼Œæˆ‘å€‘å¿…é ˆä¾è³´ loadTrack å‚³å…¥çš„ originalIndex
        
        // æ‰¾åˆ°ç•¶å‰æ’­æ”¾æ­Œæ›²çš„ originalIndex
        const playingTrackOriginalIndex = currentPlaylist[currentTrackIndex].originalIndex;
        
        // æ‰¾åˆ° DOM åˆ—è¡¨ä¸­åŒ¹é… originalIndex çš„å…ƒç´ 
        const playingItem = Array.from(listItems).find(item => {
            const onclickAttr = item.getAttribute('onclick');
            const match = onclickAttr.match(/loadTrack\((\d+)\)/);
            return match && parseInt(match[1]) === playingTrackOriginalIndex;
        });


        if (playingItem) {
            playingItem.classList.add('playing');
            
            if (!manualScroll) {
                 playingItem.scrollIntoView({
                    behavior: 'smooth', 
                    block: 'nearest'    
                });
            }
        }
    }
}


// --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± (çµ±ä¸€è™•ç† ended äº‹ä»¶) ---

// â­ï¸ é—œéµï¼šé€™å€‹å€å¡Šå¿…é ˆæ˜¯æ–‡ä»¶ä¸­å”¯ä¸€çš„ ended ç›£è½å™¨ä¾†è™•ç†åˆ‡æ­Œé‚è¼¯ã€‚
audio.addEventListener('ended', () => {
    // 1. åŸ·è¡Œè¨˜éŒ„ã€æ’åºã€å„²å­˜ç­‰æ“ä½œ
    incrementPlayCount(); 
    updatePlaylistDisplay(); 
    sortPlaylistByPlayCount(); 
    saveSettings(); 

    // 2. è™•ç†æ’­æ”¾æ¨¡å¼ (å¿…é ˆåœ¨ playTrack ä¹‹å‰å®Œæˆ)
    let nextIndex;
    
    if (playMode === 1) { // å–®æ›²å¾ªç’°ï¼šä¸æ”¹è®Šç´¢å¼•ï¼Œç›´æ¥é‡æ’­
        audio.currentTime = 0;
        audio.play();
        window.location.hash = `song-index-${currentPlaylist[currentTrackIndex].originalIndex}`;
        return;
    } else if (playMode === 2) { // éš¨æ©Ÿæ’­æ”¾
        nextIndex = getNextRandomIndex();
    } else if (playMode === 4) { // é †åºå¾ªç’°
        nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
    } else { // é †åºåœæ­¢ (0) åŠè‡ªç”±æ¨¡å¼ (3)
        nextIndex = currentTrackIndex + 1;
    }

    // 3. å‘¼å« playTrack æˆ–åœæ­¢
    if (nextIndex < currentPlaylist.length) {
        playTrack(nextIndex); 
        // ç«‹å³æ›´æ–°éŒ¨é»ï¼Œä½¿ç”¨æ–°æ­Œæ›²çš„ originalIndex
        window.location.hash = `song-index-${currentPlaylist[nextIndex].originalIndex}`;
    } else {
        // åˆ—è¡¨é †åºæ’­æ”¾çµæŸ
        audio.pause();
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1;
        updatePlaylistHighlight();
        window.location.hash = ''; // æ¸…é™¤éŒ¨é»
    }
});


// æ¨¡å¼åˆ‡æ›å‡½æ•¸ (ç•¥ - ä¿æŒä¸è®Š)
function togglePlayMode() {
    playMode = (playMode + 1) % 5; 
    updateModeUI();
    playerTitle.textContent = `å·²åˆ‡æ›åˆ° ${modeButton.textContent.replace('[ æ¨¡å¼: ', '').replace(' ]', '')}`;
    saveSettings(); 
}

// çµ±ä¸€æ›´æ–°æ¨¡å¼ UI çš„å‡½æ•¸ (ç•¥ - ä¿æŒä¸è®Š)
function updateModeUI() {
    let modeText;
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å–®æ›²å¾ªç’° ]";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
    } else if (playMode === 4) {
        modeText = "[ æ¨¡å¼: é †åºå¾ªç’° ]"; 
    } else {
        modeText = "[ æ¨¡å¼: é †åºåœæ­¢ ]"; 
    }
    modeButton.textContent = modeText;
}


// --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ (ç•¥ - ä¿æŒä¸è®Š) ---
const THEME_STORAGE_KEY = 'userThemePreference';
const LIGHT_THEME = 'light'; 
const DARK_THEME = 'dark';   
// ... (applyTheme, getSystemThemeBasedOnTime, initializeTheme å‡½æ•¸ç•¥) ...
function applyTheme(desiredTheme, isManual = false) {/* ... */}
function getSystemThemeBasedOnTime() {/* ... */}
function initializeTheme() {/* ... */}

themeToggleBtn.addEventListener('click', (event) => {
    event.stopPropagation(); 
    themeMenu.classList.toggle('hidden-menu');
});

themeOptions.forEach(option => {
    option.addEventListener('click', (e) => {
        const selectedTheme = e.target.getAttribute('data-theme');
        applyTheme(selectedTheme, true); 
        themeMenu.classList.add('hidden-menu'); 
    });
});

document.addEventListener('click', (e) => {
    if (!themeMenu.contains(e.target) && !themeToggleBtn.contains(e.target)) {
        themeMenu.classList.add('hidden-menu');
    }
    if (!timerMenu.contains(e.target) && !timerToggleButton.contains(e.target)) {
        if (!timerMenu.classList.contains('hidden-menu')) {
            timerMenu.classList.add('hidden-menu');
        }
    }
});

setInterval(() => {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    if (storedTheme === LIGHT_THEME) {
        applyTheme(LIGHT_THEME, false); 
    }
}, 1000 * 60 * 60); 
    
// --- å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ (ç•¥ - ä¿æŒä¸è®Š) ---

function toggleTimerMenu() {/* ... */}
function setSleepTimer(minutes) {/* ... */}
function clearSleepTimer() {/* ... */}
function updateTimerCountdown() {/* ... */}
function updateTotalListenTime() {/* ... */}
function incrementPlayCount() {/* ... */}


// --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ä¾†è‡ªåˆ—è¡¨é»æ“Š) ---

/**
 * @param {number} originalIndex - æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
 */
function loadTrack(originalIndex) { 
    // é»æ“Šæ­Œæ›²æ™‚åˆ‡æ›åˆ°ã€Œè‡ªç”±æ¨¡å¼ (3)ã€
    if (playMode !== 3) {
        playMode = 3; 
        updateModeUI();
        saveSettings(); 
    }
    
    const newIndex = currentPlaylist.findIndex(track => track.originalIndex === originalIndex);

    if (newIndex !== -1) {
        playTrack(newIndex); // çµ±ä¸€å…¥å£
    } else {
        resetCurrentPlaylist();
        
        const masterIndex = MASTER_TRACK_LIST.findIndex(track => track.originalIndex === originalIndex);
        if (masterIndex !== -1) {
            playerTitle.textContent = "å·²æ¸…é™¤ç¯©é¸ï¼Œä¸¦æ’­æ”¾æ‚¨é»é¸çš„æ­Œæ›²";
            playTrack(masterIndex); // çµ±ä¸€å…¥å£
        }
    }
    
    // é»æ“Šå¾Œæ›´æ–° URL éŒ¨é»ï¼Œä¾›åˆ†äº«ä½¿ç”¨
    window.location.hash = `song-index-${originalIndex}`;
}

// --- æœå°‹/ç¯©é¸é‚è¼¯ (ç•¥ - ä¿æŒä¸è®Š) ---
function filterPlaylist() {/* ... */}

// --- æ’­æ”¾åˆ—è¡¨é¡¯ç¤ºèˆ‡æ’åºé‚è¼¯ (ç•¥ - ä¿æŒä¸è®Š) ---
function updatePlaylistDisplay() {/* ... */}
function sortPlaylistByPlayCount() {/* ... */}


// --- LocalStorage é‚è¼¯ (ç•¥ - ä¿æŒä¸è®Š) ---

const CURRENT_TRACK_INDEX_KEY = 'audioPlayerIndex';
const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

function saveSettings() {
    try {
        localStorage.setItem('audioPlayerVolume', audio.volume);
        localStorage.setItem('audioPlayerMuted', audio.muted);
        localStorage.setItem('audioPlayerMode', playMode); 

        if (currentTrackIndex >= 0) {
            localStorage.setItem(CURRENT_TRACK_INDEX_KEY, currentTrackIndex);
        } else {
            localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
        }

        if (audio.currentTime > 0) {
             localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
        } else {
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
        }
        
    } catch (e) {
        console.warn('LocalStorage is not available or blocked.', e);
    }
}

function loadSavedSettings() {/* ... */}
function handleUrlAnchor() {/* ... */}


// --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---

audio.addEventListener('volumechange', saveSettings);
audio.addEventListener('ratechange', saveSettings); 
audio.addEventListener('loadedmetadata', saveSettings); 

audio.addEventListener('timeupdate', () => {
    if (!audio.paused && audio.currentTime % 5 < 1) {
         saveSettings();
    }
});

audio.addEventListener('play', saveSettings);
audio.addEventListener('pause', saveSettings);
// âš ï¸ æ³¨æ„ï¼šæ­¤è™•ä¸å†ç›£è½ 'ended' äº‹ä»¶ä¾†å„²å­˜ï¼Œå› ç‚ºå®ƒå·²æ•´åˆåˆ°ä¸Šé¢çš„æ ¸å¿ƒé‚è¼¯ä¸­ï¼Œä»¥ç¢ºä¿é †åºã€‚
// audio.addEventListener('ended', saveSettings); // <-- åˆªé™¤ï¼Œé¿å…é‡è¤‡å„²å­˜å’Œé †åºéŒ¯äº‚

playlistSearchInput.addEventListener('input', debounce(filterPlaylist, 300));


// --- åˆå§‹åŒ– ---

resetCurrentPlaylist(); 

loadSavedSettings();

if(playMode === 0 && !localStorage.getItem('audioPlayerMode')) {
    updateModeUI();
}

// åœ¨è¼‰å…¥å„²å­˜è¨­ç½®å¾Œï¼Œç«‹å³æª¢æŸ¥ URL éŒ¨é»
handleUrlAnchor();

sortPlaylistByPlayCount(); 

initializeTheme();
</script>
