<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
<div id="player-controls">
    <span id="mode-button" onclick="togglePlayMode()">
        [ æ¨¡å¼: é †åº ]
    </span>
    
    <div id="theme-switcher">
    <button id="theme-toggle-btn">
        ä¸»é¡Œ (ç•¶å‰: <span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>)
    </button>
<div id="theme-menu" class="hidden-menu">
    <span class="theme-option" data-theme="light">ç™½è‰²</span>
    <span class="theme-option" data-theme="dark">é»‘è‰²</span>
    <span class="theme-option" data-theme="grey">ç°è‰²</span>
    <span class="theme-option" data-theme="blue">è—è‰²</span>
    <span class="theme-option" data-theme="green">ç¶ è‰²</span>
    <span class="theme-option" data-theme="purple">ç´«è‰²</span>
    <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
    <span class="theme-option" data-theme="red">ç´…è‰²</span>
</div>
</div>

    <div id="sleep-timer-area">
        <button id="timer-toggle-btn" onclick="toggleTimerMenu()">
            å®šæ™‚ (æœªè¨­å®š)
        </button>
        
        <div id="timer-menu" class="hidden-menu">
            <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
        </div>
    </div>
</div> 

<div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>

<ul id="playlist">

    {% for track in site.data.music %}
        <li onclick="loadTrack({{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
    
</div>


<script>
// ç²å– DOM å…ƒç´ 
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
let playlistItems = document.querySelectorAll('#playlist li'); // ã€ä¿®æ”¹ã€‘ä½¿ç”¨ let è®“æ’åºå¾Œå¯ä»¥é‡æ–°è³¦å€¼
const modeButton = document.getElementById('mode-button'); 

// æ–°å¢ DOM å…ƒç´ 
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');
const playlistSearchInput = document.getElementById('playlist-search'); 

// *** ä¸»é¡Œåˆ‡æ›ç›¸é—œ DOM å…ƒç´  (é ‚å±¤å®šç¾©) ***
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const themeMenu = document.getElementById('theme-menu');
const currentThemeName = document.getElementById('current-theme-name');
const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
    
    
// 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
const MASTER_TRACK_LIST = [ 
{% for track in site.data.music %}
    // å¢åŠ ä¸€å€‹åŸå§‹ç´¢å¼• (originalIndex)ï¼Œç”¨æ–¼å°‡ä¾†å›æº¯æˆ–å»ç¯©é¸æ™‚å®šä½
    { title: "{{ track.title | escape }}", artist: "{{ track.artist | escape }}", url: "{{ track.url | escape }}", originalIndex: {{ forloop.index0 }} },
{% endfor %}
];

let currentPlaylist = []; 
let currentTrackIndex = 0; 
// æ’­æ”¾æ¨¡å¼ï¼š0=é †åº, 1=å¾ªç’°, 2=éš¨æ©Ÿ, 3=è‡ªç”±(æ’­å®Œå³åœ)
let playMode = 0; 

// å®šæ™‚å™¨ç‹€æ…‹è®Šæ•¸
let sleepTimerId = null; 
let sleepTime = 0; 
let endTime = 0; 
let countdownIntervalId = null; 

// ç¸½æ™‚é•·è¿½è¹¤è®Šæ•¸
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; 

// ã€æ–°å¢ã€‘æ’­æ”¾æ¬¡æ•¸è¿½è¹¤è®Šæ•¸
const PLAY_COUNT_STORAGE_KEY = 'audioTrackPlayCounts'; 
let trackPlayCounts = {}; 


// --- *** é˜²æŠ–è¼”åŠ©å‡½æ•¸ *** ---
/**
 * é˜²æŠ–å‡½æ•¸ï¼šé™åˆ¶ä¸€å€‹å‡½æ•¸åœ¨ç‰¹å®šæ™‚é–“å…§åªèƒ½åŸ·è¡Œä¸€æ¬¡
 */
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}


// --- *** æ­Œå–®é‡ç½®èˆ‡åˆå§‹åŒ– *** ---

/**
 * å°‡ç•¶å‰æ’­æ”¾æ­Œå–®é‡è¨­ç‚ºæ•´å€‹ä¸»æ­Œå–® (åœ¨æ¸…é™¤æœå°‹æ™‚ä½¿ç”¨)
 */
function resetCurrentPlaylist() {
    currentPlaylist = [...MASTER_TRACK_LIST]; 
}


// --- è¼”åŠ©å‡½æ•¸ ---

// è¼‰å…¥ä¸¦æ’­æ”¾æŒ‡å®šç´¢å¼•çš„æ­Œæ›²
function playTrack(index) {
    // ç¢ºä¿ç´¢å¼•åœ¨ç•¶å‰æ­Œå–®çš„ç¯„åœå…§
    if (index >= 0 && index < currentPlaylist.length) { 
        currentTrackIndex = index;
        const track = currentPlaylist[index]; 
        audio.src = track.url;
        playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
        audio.play().catch(error => {
            console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
        });
        updatePlaylistHighlight();
    } else if (index === currentPlaylist.length) { 
        audio.pause(); 
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    }
}

// ç²å–éš¨æ©Ÿç´¢å¼•
function getNextRandomIndex() {
    let newIndex;
    do {
        // éš¨æ©Ÿæ•¸åŸºæ–¼ currentPlaylist çš„é•·åº¦
        newIndex = Math.floor(Math.random() * currentPlaylist.length); 
    } while (newIndex === currentTrackIndex && currentPlaylist.length > 1);
    
    return newIndex;
}

// æ›´æ–°æ’­æ”¾åˆ—è¡¨çš„é«˜äº®ç‹€æ…‹
function updatePlaylistHighlight() {
    // ç²å–ç•¶å‰æ’­æ”¾æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
    const playingOriginalIndex = currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length 
        ? currentPlaylist[currentTrackIndex].originalIndex 
        : -1;
    
    // ã€ä¿®æ”¹ã€‘ç”±æ–¼ playlistItems å¯èƒ½è¢«æ’åºï¼Œé€™è£¡çš„ index å·²ç¶“ä¸æ˜¯ originalIndex
    playlistItems.forEach(item => {
        item.classList.remove('playing');
        
        // å¾ li å…ƒç´ çš„ onclick å±¬æ€§ä¸­æå– originalIndex
        const onclickAttr = item.getAttribute('onclick');
        const match = onclickAttr.match(/loadTrack\((\d+)\)/);
        const itemOriginalIndex = match ? parseInt(match[1]) : -2;

        if (itemOriginalIndex === playingOriginalIndex) { 
            item.classList.add('playing');
        }
    });
}


// --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± ---

audio.addEventListener('ended', () => {
    // ã€ä¿®æ”¹é»ã€‘åœ¨åˆ‡æ›ä¸‹ä¸€é¦–æ­Œä¹‹å‰ï¼Œå…ˆè¨˜éŒ„ç•¶å‰æ­Œæ›²æ’­æ”¾å®Œæˆ
    incrementPlayCount(); 
    updatePlaylistDisplay(); // æ¯æ¬¡è¨ˆæ•¸æ›´æ–°å¾Œï¼Œé‡æ–°æ¸²æŸ“æ’­æ”¾æ¬¡æ•¸
    sortPlaylistByPlayCount(); //å¯¦æ™‚åŸ·è¡Œæ’åºï¼šä¸‹ä¸€é¦–æ­Œæ›²æ’­æ”¾æ™‚ï¼Œåˆ—è¡¨å·²ç¶“æ˜¯æœ€æ–°çš„é«˜äººæ°£æ’åºäº†ï¼

    
    if (playMode === 1) {
        audio.currentTime = 0; 
        audio.play();
    } else if (playMode === 2) {
        const nextIndex = getNextRandomIndex();
        playTrack(nextIndex);
    } else if (playMode === 3) {
        audio.pause();
        playerTitle.textContent = "è‡ªç”±æ¨¡å¼ä¸‹ï¼Œç•¶å‰æ­Œæ›²æ’­æ”¾å®Œç•¢ã€‚";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    } 
    else {
        if (currentTrackIndex < currentPlaylist.length - 1) { 
            playTrack(currentTrackIndex + 1); 
        } else {
            playTrack(currentPlaylist.length); 
        }
    }
});


// æ¨¡å¼åˆ‡æ›å‡½æ•¸
function togglePlayMode() {
    playMode = (playMode + 1) % 4; 
    
    let modeText;
    let titleMessage;
    
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å¾ªç’° ]";
        titleMessage = "å·²åˆ‡æ›åˆ°å–®æ›²å¾ªç’°æ¨¡å¼";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
        titleMessage = "å·²åˆ‡æ›åˆ°éš¨æ©Ÿæ’­æ”¾æ¨¡å¼";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
        titleMessage = "å·²åˆ‡æ›åˆ°è‡ªç”±æ’­æ”¾æ¨¡å¼ (æ’­å®Œå³åœ)";
    } else {
        modeText = "[ æ¨¡å¼: é †åº ]";
        titleMessage = "å·²åˆ‡æ›åˆ°é †åºæ’­æ”¾æ¨¡å¼";
    }
    
    modeButton.textContent = modeText;
    playerTitle.textContent = titleMessage;

    // å„²å­˜æ’­æ”¾æ¨¡å¼åˆ° localStorage
    saveSettings(); 
}


// --- *** ä¸»é¡Œåˆ‡æ›é‚è¼¯ (ä¿æŒä¸è®Š) *** ---
// (æ­¤è™•çœç•¥ä¸»é¡Œåˆ‡æ›å‡½æ•¸ï¼Œä¿æŒèˆ‡æ‚¨æä¾›çš„ç‰ˆæœ¬ä¸€è‡´)
const THEME_STORAGE_KEY = 'userThemePreference';
const LIGHT_THEME = 'light'; 
const DARK_THEME = 'dark';   
const GREY_THEME = 'grey';   
const BLUE_THEME = 'blue';
const GREEN_THEME = 'green';
const PURPLE_THEME = 'purple';
const PINK_THEME = 'pink';
const RED_THEME = 'red';
    
/**
 * è¨­ç½®ä¸»é¡Œé¡åä¸¦æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
 */
function applyTheme(desiredTheme, isManual = false) {
    const body = document.body;
    let displayName = '';
    
    // 1. æ¸…é™¤æ‰€æœ‰ä¸»é¡Œé¡å (ç¢ºä¿åªæ‡‰ç”¨ä¸€å€‹ä¸»é¡Œ)
    body.classList.remove(
        DARK_THEME + '-theme', 
        GREY_THEME + '-theme',
        BLUE_THEME + '-theme',
        GREEN_THEME + '-theme',
        PURPLE_THEME + '-theme', 
        PINK_THEME + '-theme',   
        RED_THEME + '-theme'     
    );

    let themeToApply = desiredTheme;
    let modeText = '(æ‰‹å‹•)'; 

    // 2. è™•ç†å„²å­˜/è‡ªå‹•æ¨¡å¼ (ä¿æŒä¸è®Š)
    if (isManual) {
        localStorage.setItem(THEME_STORAGE_KEY, desiredTheme);
    } 
    else if (desiredTheme === LIGHT_THEME) {
        themeToApply = getSystemThemeBasedOnTime();
        modeText = '(è‡ªå‹•)';
    }

    // 3. æ ¹æ“šæœ€çµ‚ç¢ºå®šçš„ä¸»é¡Œ themeToApply æ‡‰ç”¨é¡å
    if (themeToApply === DARK_THEME) {
        body.classList.add(DARK_THEME + '-theme');
        displayName = 'é»‘è‰²';
    } else if (themeToApply === GREY_THEME) {
        body.classList.add(GREY_THEME + '-theme');
        displayName = 'ç°è‰²';
    } else if (themeToApply === BLUE_THEME) {
        body.classList.add(BLUE_THEME + '-theme');
        displayName = 'è—è‰²';
    } else if (themeToApply === GREEN_THEME) {
        body.classList.add(GREEN_THEME + '-theme');
        displayName = 'ç¶ è‰²';
    } else if (themeToApply === PURPLE_THEME) { 
        body.classList.add(PURPLE_THEME + '-theme');
        displayName = 'ç´«è‰²';
    } else if (themeToApply === PINK_THEME) { 
        body.classList.add(PINK_THEME + '-theme');
        displayName = 'ç²‰è‰²';
    } else if (themeToApply === RED_THEME) { 
        body.classList.add(RED_THEME + '-theme');
        displayName = 'ç´…è‰²';
    } else { 
        displayName = 'ç™½è‰²';
    }
    
    // 4. æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
    currentThemeName.textContent = `${displayName} ${modeText}`;
}


/**
 * æ ¹æ“šç•¶åœ°æ™‚é–“åˆ¤æ–·æ‡‰è©²ä½¿ç”¨æ·ºè‰²é‚„æ˜¯æ·±è‰²
 */
function getSystemThemeBasedOnTime() {
    const hour = new Date().getHours();
    return (hour >= 19 || hour < 7) ? DARK_THEME : LIGHT_THEME;
}

/**
 * åˆå§‹åŒ–ä¸»é¡Œï¼šå¾ localStorage è®€å–æˆ–æ ¹æ“šæ™‚é–“è‡ªå‹•åˆ¤æ–·
 */
function initializeTheme() {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme) {
        if (storedTheme === LIGHT_THEME) {
             applyTheme(LIGHT_THEME, false); 
        } else {
             applyTheme(storedTheme, true); 
        }
    } else {
        applyTheme(LIGHT_THEME, false);
    }
}

// --- ä¸»é¡Œ/å®šæ™‚å™¨äº‹ä»¶ç›£è½å™¨ (ä¿æŒä¸è®Š) ---

themeToggleBtn.addEventListener('click', (event) => {
    event.stopPropagation(); 
    themeMenu.classList.toggle('hidden-menu');
});

themeOptions.forEach(option => {
    option.addEventListener('click', (e) => {
        const selectedTheme = e.target.getAttribute('data-theme');
        applyTheme(selectedTheme, true); 
        themeMenu.classList.add('hidden-menu'); 
    });
});

document.addEventListener('click', (e) => {
    if (!themeMenu.contains(e.target) && !themeToggleBtn.contains(e.target)) {
        themeMenu.classList.add('hidden-menu');
    }
    if (!timerMenu.contains(e.target) && !timerToggleButton.contains(e.target)) {
        if (!timerMenu.classList.contains('hidden-menu')) {
            timerMenu.classList.add('hidden-menu');
        }
    }
});

setInterval(() => {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    if (storedTheme === LIGHT_THEME) {
        applyTheme(LIGHT_THEME, false); 
    }
}, 1000 * 60 * 60); 
    
// --- å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ (ä¿æŒä¸è®Š) ---

function toggleTimerMenu() {
    timerMenu.classList.toggle('hidden-menu');
}

function setSleepTimer(minutes) {
    clearSleepTimer();
    toggleTimerMenu(); 

    const delayMilliseconds = minutes * 60 * 1000;
    
    sleepTime = minutes * 60;
    endTime = Date.now() + delayMilliseconds;

    sleepTimerId = setTimeout(() => {
        audio.pause(); 
        playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾ (${minutes} åˆ†é˜)`;
        clearSleepTimer(); 
    }, delayMilliseconds);
    
    countdownIntervalId = setInterval(updateTimerCountdown, 1000);

    timerToggleButton.textContent = `å®šæ™‚ (${minutes} åˆ†é˜)`;
    playerTitle.textContent = `å®šæ™‚å™¨å·²è¨­ç½®ï¼š${minutes} åˆ†é˜å¾Œè‡ªå‹•é—œé–‰`;

    if (audio.paused) {
        audio.play();
    }
}

function clearSleepTimer() {
    if (sleepTimerId !== null) {
        clearTimeout(sleepTimerId);
        sleepTimerId = null;
    }
    if (countdownIntervalId !== null) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
    }
    
    sleepTime = 0;
    endTime = 0;
    timerToggleButton.textContent = "å®šæ™‚ (æœªè¨­å®š)";
    remainingTimerSpan.textContent = "--:--";
    playerTitle.textContent = "å·²å–æ¶ˆå®šæ™‚å™¨";
}

function updateTimerCountdown() {
    if (endTime > 0) {
        const remainingMs = endTime - Date.now();
        const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
        
        const minutes = Math.floor(remainingS / 60);
        const seconds = remainingS % 60;
        
        remainingTimerSpan.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        if (remainingS === 0) {
            clearSleepTimer(); 
            if (!audio.paused) {
                 audio.pause();
                 playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾`;
            }
        }
    }
}


audio.addEventListener('play', () => {
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
});

audio.addEventListener('pause', () => {
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
});

function updateTotalListenTime() {
    totalListenSeconds++;
    if (totalListenSeconds >= 60) {
        totalListenMinutes++;
        totalListenSeconds = 0;
    }
    
    totalListenTimeSpan.textContent = 
        `${totalListenMinutes} åˆ†é˜ ${totalListenSeconds} ç§’`;
}

// ã€æ–°å¢ã€‘æ’­æ”¾æ¬¡æ•¸è¿½è¹¤å‡½æ•¸
function incrementPlayCount() {
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        const track = currentPlaylist[currentTrackIndex];
        const key = track.originalIndex; // ä½¿ç”¨åŸå§‹ç´¢å¼•ä½œç‚ºå”¯ä¸€éµ
        
        // å¢åŠ è¨ˆæ•¸
        trackPlayCounts[key] = (trackPlayCounts[key] || 0) + 1; 
        
        // å„²å­˜åˆ° LocalStorage
        try {
            localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
        } catch (e) {
            console.warn('ç„¡æ³•å„²å­˜æ’­æ”¾æ¬¡æ•¸åˆ° LocalStorage.', e);
        }
    }
}

// --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ä¾†è‡ªåˆ—è¡¨é»æ“Š) ---

/**
 * ç•¶ç”¨æˆ¶é»æ“Šæ’­æ”¾åˆ—è¡¨æ™‚è¼‰å…¥æ­Œæ›²
 * @param {number} originalIndex - æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
 */
function loadTrack(originalIndex) { 
    // 1. åˆ‡æ›åˆ°è‡ªç”±æ¨¡å¼
    if (playMode !== 3) {
        playMode = 3;
        modeButton.textContent = "[ æ¨¡å¼: è‡ªç”± ]";
        saveSettings(); 
    }
    
    // 2. æŸ¥æ‰¾æ­Œæ›²åœ¨ç•¶å‰æ’­æ”¾åˆ—è¡¨ä¸­çš„ç´¢å¼•
    const newIndex = currentPlaylist.findIndex(track => track.originalIndex === originalIndex);

    if (newIndex !== -1) {
        // æƒ…æ³ A: æ­Œæ›²åœ¨ç¯©é¸å¾Œçš„æ­Œå–®ä¸­ï¼Œç›´æ¥æ’­æ”¾è©²æ­Œå–®ä¸­çš„ç´¢å¼•
        playTrack(newIndex);
    } else {
        // æƒ…æ³ B: æ­Œæ›²ä¸åœ¨ç¯©é¸å¾Œçš„æ­Œå–®ä¸­ (ä½¿ç”¨è€…é»æ“Šäº†è¢«éš±è—çš„é …ç›®)
        
        // é€™è£¡æˆ‘å€‘å¿…é ˆå…ˆå°‡æ­Œå–®é‡è¨­å› Master List (å› ç‚ºç”¨æˆ¶æ˜ç¢ºé»æ“Šäº†æŸé¦–æ­Œ)
        resetCurrentPlaylist();
        
        // ç”±æ–¼ currentPlaylist ç¾åœ¨èˆ‡ Master List ç›¸åŒï¼ŒåŸå§‹ç´¢å¼• (originalIndex) å³æ˜¯ç•¶å‰ç´¢å¼•
        playerTitle.textContent = "å·²æ¸…é™¤ç¯©é¸ï¼Œä¸¦æ’­æ”¾æ‚¨é»é¸çš„æ­Œæ›²";
        playTrack(originalIndex); 
    }
}


// ã€æ–°å¢ã€‘æ’­æ”¾æ¬¡æ•¸è¿½è¹¤å‡½æ•¸
function incrementPlayCount() {
    if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
        const track = currentPlaylist[currentTrackIndex];
        const key = track.originalIndex; // ä½¿ç”¨åŸå§‹ç´¢å¼•ä½œç‚ºå”¯ä¸€éµ
        
        // å¢åŠ è¨ˆæ•¸
        trackPlayCounts[key] = (trackPlayCounts[key] || 0) + 1; 
        
        // å„²å­˜åˆ° LocalStorage
        try {
            localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
        } catch (e) {
            console.warn('ç„¡æ³•å„²å­˜æ’­æ”¾æ¬¡æ•¸åˆ° LocalStorage.', e);
        }
    }
}


// --- *** æœå°‹/ç¯©é¸é‚è¼¯ (é‡æ§‹ç‚ºå‹•æ…‹æ­Œå–®) *** ---
/**
 * æ ¹æ“šæœå°‹æ¡†çš„è¼¸å…¥å…§å®¹ï¼Œç¯©é¸ä¸¦é¡¯ç¤º/éš±è—æ’­æ”¾åˆ—è¡¨é …ç›®ï¼ŒåŒæ™‚é‡å»º currentPlaylist
 */
function filterPlaylist() {
    const searchText = playlistSearchInput.value.toLowerCase().trim(); 
    
    // 1. ç¯©é¸ Master Listï¼Œé‡å»º currentPlaylist
    if (searchText.length > 0) {
        currentPlaylist = MASTER_TRACK_LIST.filter(track => { 
            const itemText = (track.title + ' ' + track.artist).toLowerCase(); 
            return itemText.includes(searchText);
        });
        
        // --- æ ¸å¿ƒ Bug ä¿®å¾©é‚è¼¯ (çµ±ä¸€åœæ­¢è¨ˆæ™‚) ---
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId); 
            listenIntervalId = null;
        }
        // ----------------------------------------

        if (currentPlaylist.length === 0) {
            playerTitle.textContent = `æœªæ‰¾åˆ°èˆ‡ "${searchText}" ç›¸é—œçš„æ­Œæ›²ã€‚`;
            audio.pause(); 
            currentTrackIndex = -1;
            
        } else {
             playerTitle.textContent = `å·²æ ¹æ“šç¯©é¸å»ºç«‹æ–°æ­Œå–® (${currentPlaylist.length} é¦–)ã€‚è«‹é»æ“Šæ’­æ”¾ã€‚`;
             currentTrackIndex = 0; 
             const track = currentPlaylist[currentTrackIndex]; 
             audio.src = track.url; // åªè¼‰å…¥ï¼Œä¸æ’­æ”¾
             audio.pause(); // ç¢ºä¿åœæ­¢æ­£åœ¨æ’­æ”¾çš„æ­Œæ›²
        }

    } else {
        // æœå°‹æ¡†ç‚ºç©ºï¼Œé‡è¨­ç‚ºå®Œæ•´æ­Œå–®
        resetCurrentPlaylist(); 
        playerTitle.textContent = "æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨";
        
        // --- æ ¸å¿ƒ Bug ä¿®å¾©é‚è¼¯ (çµ±ä¸€åœæ­¢è¨ˆæ™‚) ---
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId); 
            listenIntervalId = null;
        }
        // ----------------------------------------
        
        // ç•¶æ¸…é™¤æœå°‹æ™‚ï¼Œå¦‚æœæ’­æ”¾å™¨è™•æ–¼æš«åœç‹€æ…‹ï¼Œå‰‡ç¹¼çºŒæš«åœï¼Œä¸¦è¼‰å…¥ç¬¬ä¸€é¦–
        currentTrackIndex = 0; 
        const track = currentPlaylist[currentTrackIndex]; 
        audio.src = track.url;
        audio.pause(); // ä¿æŒæš«åœç‹€æ…‹
    }

    // 2. æ›´æ–° HTML åˆ—è¡¨çš„é¡¯ç¤º/éš±è—ç‹€æ…‹
    playlistItems.forEach(item => {
        // å¾ li å…ƒç´ çš„å…§å®¹ä¸­æå–æ–‡æœ¬
        const itemText = item.textContent.toLowerCase(); 
        if (itemText.includes(searchText) || searchText.length === 0) {
            item.style.display = ''; 
        } else {
            item.style.display = 'none';
        }
    });

    // 3. ç¢ºä¿é«˜äº®ç‹€æ…‹æ­£ç¢º (å› ç‚º currentPlaylist å·²è®Šï¼Œå¿…é ˆæ›´æ–°)
    updatePlaylistHighlight(); 
}


// --- æ’­æ”¾åˆ—è¡¨é¡¯ç¤ºèˆ‡æ’åºé‚è¼¯ ---

/**
 * æ›´æ–°æ’­æ”¾åˆ—è¡¨ï¼Œé¡¯ç¤ºæ¯é¦–æ­Œçš„æ’­æ”¾æ¬¡æ•¸
 */
function updatePlaylistDisplay() {
    // é‡æ–°è®€å– DOM åˆ—è¡¨ï¼Œå› ç‚ºæ’åºå¯èƒ½æœƒæ”¹è®Šé †åº
    const currentListItems = document.querySelectorAll('#playlist li'); 
    
    currentListItems.forEach(item => {
        // å¾ li å…ƒç´ çš„ onclick å±¬æ€§ä¸­æå– originalIndex
        const onclickAttr = item.getAttribute('onclick');
        const match = onclickAttr.match(/loadTrack\((\d+)\)/);
        const index = match ? parseInt(match[1]) : -1;
        
        if (index === -1) return;
        
        const track = MASTER_TRACK_LIST[index];
        const originalText = track.title + ' - ' + track.artist;
        const playCount = trackPlayCounts[index] || 0;
        
        // æ¸…é™¤èˆŠçš„å…§å®¹ (ç¢ºä¿ä¸é‡è¤‡æ·»åŠ æ¬¡æ•¸)
        item.innerHTML = '';
        
        // å‰µå»ºä¸»é«”æ–‡å­— (æ­Œå - æ­Œæ‰‹)
        const mainSpan = document.createElement('span');
        mainSpan.textContent = originalText;
        item.appendChild(mainSpan);
        
        // å‰µå»ºæ’­æ”¾æ¬¡æ•¸å°å­—
        if (playCount > 0) {
            const countSpan = document.createElement('small');
            countSpan.textContent = ` (${playCount} æ¬¡æ’­æ”¾)`;
            
            // å…§è¯æ¨£å¼å¯¦ç¾å°å­—ã€ç°è‰²ï¼Œä¸ä½”ç”¨å¤ªå¤šç©ºé–“
            countSpan.style.fontSize = '0.8em'; 
            countSpan.style.color = '#888'; 
            countSpan.style.marginLeft = '10px';
            
            item.appendChild(countSpan);
        }
    });
}

/**
 * æ ¹æ“šæ’­æ”¾æ¬¡æ•¸å°æ’­æ”¾åˆ—è¡¨é€²è¡Œæ’åº (äººæ°£æ¦œ)
 */
function sortPlaylistByPlayCount() {
    // 1. å»ºç«‹ä¸€å€‹åŒ…å«æ’­æ”¾æ¬¡æ•¸ä¿¡æ¯çš„åˆ—è¡¨å‰¯æœ¬
    const sortableList = [...MASTER_TRACK_LIST].map(track => {
        const count = trackPlayCounts[track.originalIndex] || 0;
        return { ...track, playCount: count };
    });

    // 2. æ’åºï¼šæ’­æ”¾æ¬¡æ•¸é«˜çš„åœ¨å‰ (é™åº)ï¼Œæ¬¡æ•¸ç›¸åŒçš„æŒ‰ç…§åŸå§‹ç´¢å¼• (å‡åº)
    sortableList.sort((a, b) => {
        if (b.playCount !== a.playCount) {
            return b.playCount - a.playCount;
        }
        return a.originalIndex - b.originalIndex; // æ¬¡æ•¸ç›¸åŒæ™‚ä¿æŒåŸå§‹é †åº
    });

    // 3. ç²å– HTML åˆ—è¡¨å…ƒç´ å’ŒåŸå§‹çš„ li å…ƒç´ é›†åˆ
    const playlistUl = document.getElementById('playlist');
    const originalLiElements = Array.from(playlistUl.querySelectorAll('li'));

    // 4. æ¸…ç©ºç¾æœ‰åˆ—è¡¨
    playlistUl.innerHTML = '';

    // 5. æ ¹æ“šæ’åºå¾Œçš„é †åºé‡æ–°é™„åŠ åˆ—è¡¨é …
    sortableList.forEach(track => {
        // æ‰¾åˆ°å°æ‡‰åŸå§‹ç´¢å¼•çš„ HTML å…ƒç´ 
        const originalIndex = track.originalIndex;
        const liElement = originalLiElements.find(item => {
            const onclickAttr = item.getAttribute('onclick');
            const match = onclickAttr.match(/loadTrack\((\d+)\)/);
            return match && parseInt(match[1]) === originalIndex;
        });

        if (liElement) {
            playlistUl.appendChild(liElement);
        }
    });
    
    // 6. é‡æ–°ç²å– playlistItems å¼•ç”¨ï¼Œç¢ºä¿å®ƒå€‘æŒ‡å‘æ–°çš„ DOM é †åº
    playlistItems = document.querySelectorAll('#playlist li'); 

    // 7. é‡æ–°æ¸²æŸ“æ’­æ”¾æ¬¡æ•¸å’Œé«˜äº®ç‹€æ…‹
    updatePlaylistDisplay();
    updatePlaylistHighlight();
}


// --- *** LocalStorage é‚è¼¯ (æŒä¹…åŒ–ï¼šæ¨¡å¼/ä¸»é¡Œ/éŸ³é‡/éœéŸ³/é€²åº¦/æ’­æ”¾æ¬¡æ•¸) *** ---

const CURRENT_TRACK_INDEX_KEY = 'audioPlayerIndex';
const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

function saveSettings() {
    try {
        localStorage.setItem('audioPlayerVolume', audio.volume);
        localStorage.setItem('audioPlayerMuted', audio.muted);
        localStorage.setItem('audioPlayerMode', playMode);

        if (currentTrackIndex >= 0) {
            localStorage.setItem(CURRENT_TRACK_INDEX_KEY, currentTrackIndex);
        } else {
            localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
        }

        if (audio.currentTime > 0) {
             localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
        } else {
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
        }
        
    } catch (e) {
        console.warn('LocalStorage is not available or blocked.', e);
    }
}

function loadSavedSettings() {
    try {
        const savedVolume = localStorage.getItem('audioPlayerVolume');
        if (savedVolume !== null) {
            audio.volume = Math.max(0, Math.min(1, parseFloat(savedVolume)));
        }
        const savedMuted = localStorage.getItem('audioPlayerMuted');
        if (savedMuted !== null) {
            audio.muted = (savedMuted === 'true');
        }

        const savedMode = localStorage.getItem('audioPlayerMode');
        if (savedMode !== null) {
            const mode = parseInt(savedMode);
            if (mode >= 0 && mode <= 3) {
                playMode = mode;
                updateModeUI(); 
            }
        }
        
        const savedIndex = localStorage.getItem(CURRENT_TRACK_INDEX_KEY);
        if (savedIndex !== null) {
            const index = parseInt(savedIndex);
            if (index >= 0 && index < MASTER_TRACK_LIST.length) { 
                currentTrackIndex = index;
                const track = MASTER_TRACK_LIST[index]; 
                audio.src = track.url;
                playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
            }
        }

        const savedTime = localStorage.getItem(CURRENT_TRACK_TIME_KEY);
        if (savedTime !== null && currentTrackIndex >= 0) { 
             const time = parseFloat(savedTime);
             if (!isNaN(time) && time > 0) {
                 audio.currentTime = time;
             }
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY); 
        }
        
        // è¼‰å…¥æ’­æ”¾æ¬¡æ•¸æ•¸æ“š
        const savedCounts = localStorage.getItem(PLAY_COUNT_STORAGE_KEY);
        if (savedCounts) {
            trackPlayCounts = JSON.parse(savedCounts);
        }
        
    } catch (e) {
        console.warn('Failed to load settings from LocalStorage.', e);
    }
}

function updateModeUI() {
    let modeText;
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å¾ªç’° ]";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
    } else {
        modeText = "[ æ¨¡å¼: é †åº ]";
    }
    modeButton.textContent = modeText;
}


// --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---

audio.addEventListener('volumechange', saveSettings);
audio.addEventListener('ratechange', saveSettings); 
audio.addEventListener('loadedmetadata', saveSettings); 

audio.addEventListener('timeupdate', () => {
    if (!audio.paused && audio.currentTime % 5 < 1) {
         saveSettings();
    }
});

audio.addEventListener('play', saveSettings);
audio.addEventListener('pause', saveSettings);
audio.addEventListener('ended', saveSettings);

// âœ… ä¿®æ­£ï¼šä½¿ç”¨é˜²æŠ–ç‰ˆæœ¬ä¾†ç›£è½è¼¸å…¥äº‹ä»¶ï¼Œé˜²æ­¢åœ¨æ‰“å­—æ™‚æ­Œæ›²è‡ªå‹•æ’­æ”¾
playlistSearchInput.addEventListener('input', debounce(filterPlaylist, 300));


// --- åˆå§‹åŒ– ---

// é—œéµï¼šåœ¨è¼‰å…¥ä»»ä½•æ±è¥¿ä¹‹å‰ï¼Œå…ˆå»ºç«‹ä¸»æ­Œå–®
resetCurrentPlaylist(); 

// 1. è¼‰å…¥å„²å­˜çš„è¨­å®šï¼ˆåŒ…æ‹¬æ’­æ”¾æ¬¡æ•¸ï¼‰
loadSavedSettings();

// 2. åŸ·è¡Œæ’åºå’Œé¡¯ç¤ºæ’­æ”¾æ¬¡æ•¸
sortPlaylistByPlayCount(); // å–ä»£èˆŠçš„ updatePlaylistHighlight()

// 3. åˆå§‹åŒ–ä¸»é¡Œè¨­å®š (è‡ªå‹•æˆ–æ‰‹å‹•)
initializeTheme();
</script>
