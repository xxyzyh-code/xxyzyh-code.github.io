<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
    <div id="player-controls" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
        
        <div id="nav-main-group" style="display: flex; justify-content: center; align-items: center; gap: 15px;">
            <span id="prev-button" onclick="playPreviousTrack()" style="cursor: pointer; font-size: 1.2em;">
                âª ä¸Šä¸€æ›²
            </span>
            <span id="mode-button" onclick="togglePlayMode()" style="cursor: pointer;">
                [ æ¨¡å¼: é †åº ]
            </span>
            <span id="next-button" onclick="playNextTrack()" style="cursor: pointer; font-size: 1.2em;">
                ä¸‹ä¸€æ›² â©
            </span>
        </div>
        
        <div id="mode-switcher-group" style="display: flex; justify-content: center; margin-top: 5px;">
            <div id="data-mode-switcher">
                <button id="data-mode-toggle-btn" onclick="toggleDataMode()" style="cursor: pointer;">
                    æ•¸æ“šæ¨¡å¼: <span id="current-data-mode">[æœ¬åœ°çµ±è¨ˆ]</span>
                </button>
            </div>
        </div>

        <div id="aux-controls-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
            
            <div id="theme-switcher" style="position: relative;">
                <button id="theme-toggle-btn" style="cursor: pointer;">
                    ä¸»é¡Œï¼š<span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>
                </button>
                <div id="theme-menu" class="hidden-menu" style="position: absolute; z-index: 10; left: 0;">
                    <span class="theme-option" data-theme="light">ç™½è‰²</span>
                    <span class="theme-option" data-theme="dark">é»‘è‰²</span>
                    <span class="theme-option" data-theme="grey">ç°è‰²</span>
                    <span class="theme-option" data-theme="blue">è—è‰²</span>
                    <span class="theme-option" data-theme="green">ç¶ è‰²</span>
                    <span class="theme-option" data-theme="purple">ç´«è‰²</span>
                    <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
                    <span class="theme-option" data-theme="yellow">é»„è‰²</span>
                    <span class="theme-option" data-theme="red">ç´…è‰²</span>
                </div>
            </div>
            
            <div id="sleep-timer-area" style="position: relative;">
                <button id="timer-toggle-btn" onclick="toggleTimerMenu()" style="cursor: pointer;">
                    å®šæ™‚ (æœªè¨­å®š)
                </button>
                
                <div id="timer-menu" class="hidden-menu" style="position: absolute; z-index: 10; right: 0;">
                    <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
                    <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
                    <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
                    <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
                </div>
            </div>
        </div>
        
    </div> 
    <div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>
<ul id="playlist">
    </ul>
</div>
<script>
    // â­ï¸ é—œéµä¿®æ­£ 1: ä½¿ç”¨ Liquid å°‡æ•¸æ“šå‚³éçµ¦ JavaScript
    const trackDataArray = {{ site.data.music | jsonify }}; 
    
    // ------------------------------------
    // â­ï¸ é—œéµï¼šSupabase API é…ç½® (ä½¿ç”¨æ‚¨æä¾›çš„ Key)
    // ------------------------------------
    const SUPABASE_URL = 'https://dpflzangmwahuwyevegp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwZmx6YW5nbXdhaHV3eWV2ZWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0Mjc0NDYsImV4cCI6MjA3ODAwMzQ0Nn0.bydLBJIGqHcEKDhmw4E7zEqxFxymieS7GlLjL9Zyr90';
    const GLOBAL_STATS_TABLE = 'play_logs'; // æ‚¨çš„è¡¨å

    // ------------------------------------
    // ç²å– DOM å…ƒç´ 
    // ------------------------------------
    const audio = document.getElementById('main-audio');
    const playerTitle = document.querySelector('#custom-audio-player h3');
    const modeButton = document.getElementById('mode-button'); 
    const timerToggleButton = document.getElementById('timer-toggle-btn');
    const timerMenu = document.getElementById('timer-menu');
    const totalListenTimeSpan = document.getElementById('total-listen-time');
    const remainingTimerSpan = document.getElementById('remaining-timer');
    const playlistSearchInput = document.getElementById('playlist-search'); 
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const themeMenu = document.getElementById('theme-menu');
    const currentThemeName = document.getElementById('current-theme-name');
    const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
        
        
    // ------------------------------------
    // 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
    // ------------------------------------
    const MASTER_TRACK_LIST = (function() {
        if (typeof trackDataArray === 'undefined' || trackDataArray.length === 0) {
            console.error("éŒ¯èª¤: trackDataArray (site.data.music) æ•¸æ“šæœªæ‰¾åˆ°æˆ–ç‚ºç©ºã€‚");
            return [];
        }
        return trackDataArray.map((track, index) => ({
            id: track.id || `s${index}`, 
            title: track.title,
            artist: track.artist,
            url: track.url,
            originalIndex: index 
        }));
    })(); 

    let currentPlaylist = []; 
    let currentTrackIndex = 0; 
    let playMode = 0; 
    let sleepTimerId = null; 
    let sleepTime = 0; 
    let endTime = 0; 
    let countdownIntervalId = null; 
    let totalListenMinutes = 0;
    let totalListenSeconds = 0;
    let listenIntervalId = null; 
    let scoreTimerIntervalId = null; 
    let scoreAccumulatorSeconds = 0; 

    const PLAY_COUNT_STORAGE_KEY = 'audioTrackPlayCounts'; 
    let trackPlayCounts = {}; 
    let dataMode = 'local';
    const DATA_MODE_STORAGE_KEY = 'audioPlayerDataMode';
    let globalTrackPlayCounts = {}; 

    // --- *** Supabase/API ç›¸é—œå‡½æ•¸ (ä¿æŒä¸è®Š) *** ---
    function getUserId() {
      let id = localStorage.getItem('anon_user_id');
      if (!id) {
        id = crypto.randomUUID(); 
        localStorage.setItem('anon_user_id', id);
      }
      return id;
    }

    function trackPlayToDatabase(song_id) {
        if (typeof song_id === 'undefined' || song_id === null) {
            console.warn("trackPlayToDatabase: Song ID ç„¡æ•ˆï¼Œè·³éæ•¸æ“šåº«è¨˜éŒ„ã€‚");
            return;
        }
        
        const user_id = getUserId(); 
        const currentTrack = currentPlaylist[currentTrackIndex];
        const song_title = currentTrack ? currentTrack.title : 'æœªçŸ¥æ­Œæ›²'; 
        
        fetch('/api/track', { 
            method: 'POST',
            body: JSON.stringify({
                user_id: user_id,
                song_id: song_id,
                title: song_title 
            }),
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) {
                console.error(`æ’­æ”¾è¨˜éŒ„ç™¼é€å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .catch(error => {
            console.error('æ’­æ”¾è¨˜éŒ„ç™¼é€å¤±æ•—:', error);
        });
    }

    async function fetchGlobalPlayCounts() {
        document.getElementById('current-data-mode').textContent = '[è¼‰å…¥ä¸­...]';

        const BASE_URL = window.location.origin;
        const apiEndpoint = `${BASE_URL}/api/stats`;
        
        try {
            const response = await fetch(apiEndpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json' 
                }
            });
            
            if (!response.ok) {
                let errorMessage = `API éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}.`;
                try {
                    const errorBody = await response.json();
                    if (errorBody && errorBody.message) {
                        errorMessage += ` è©³æƒ…: ${errorBody.message}`;
                    } else if (errorBody.error) {
                        errorMessage += ` è©³æƒ…: ${errorBody.error}`;
                    }
                } catch (e) {
                    errorMessage += ` å¾Œç«¯éŸ¿æ‡‰æ ¼å¼éŒ¯èª¤æˆ–ç‚ºéœæ…‹é é¢ã€‚`;
                }
                throw new Error(errorMessage);
            }
            
            const globalStats = await response.json();
            return globalStats;
            
        } catch (error) {
            console.error('ç²å–å…¨çƒæ’­æ”¾æ¬¡æ•¸å¤±æ•—:', error);
            
            alert(`ç„¡æ³•è¼‰å…¥å…¨çƒçµ±è¨ˆæ•¸æ“šã€‚éŒ¯èª¤: ${error.message}ã€‚å·²è‡ªå‹•åˆ‡æ›åˆ°æœ¬åœ°æ¨¡å¼ã€‚`);
            
            dataMode = 'local';
            updateDataModeUI(); 
            saveSettings();
            
            return {}; 
        }
    }

    // --- *** é˜²æŠ–è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š) *** ---
    function debounce(func, delay) {
        let timeoutId;
        return function(...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    // --- *** æ­Œå–®é‡ç½®èˆ‡åˆå§‹åŒ– (ä¿æŒä¸è®Š) *** ---
    function resetCurrentPlaylist() {
        currentPlaylist = [...MASTER_TRACK_LIST]; 
    }

    // --- è¼”åŠ©å‡½æ•¸ ---
    function playTrack(index) {
        if (index >= 0 && index < currentPlaylist.length) { 
            currentTrackIndex = index;
            const track = currentPlaylist[index]; 
            audio.src = track.url;
            playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
            audio.play().catch(error => {
                console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
            });
            updatePlaylistHighlight();
            
            // â­ï¸ ä¿®æ­£ï¼šä½¿ç”¨ track.originalIndex ä¾†è¨­å®š hash
            window.location.hash = `song-index-${track.originalIndex}`; 
        } else if (index === currentPlaylist.length) { 
            audio.pause(); 
            playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
            currentTrackIndex = -1; 
            updatePlaylistHighlight();
            window.location.hash = '';
        }
    }
    
    function getNextRandomIndex() {
        let newIndex;
        do {
            newIndex = Math.floor(Math.random() * currentPlaylist.length); 
        } while (newIndex === currentTrackIndex && currentPlaylist.length > 1);
        
        return newIndex;
    }
    function playNextTrack() {
        if (currentPlaylist.length === 0) return;
        
        let nextIndex;
        
        if (playMode === 1) { 
            nextIndex = currentTrackIndex; 
        } else if (playMode === 2) { 
            nextIndex = getNextRandomIndex();
        } else { 
            if (currentTrackIndex < currentPlaylist.length - 1) {
                nextIndex = currentTrackIndex + 1;
            } else if (playMode === 4) { 
                nextIndex = 0; 
            } else { 
                audio.pause();
                playerTitle.textContent = "å·²åˆ°é”åˆ—è¡¨æœ«å°¾ã€‚";
                currentTrackIndex = currentPlaylist.length; 
                updatePlaylistHighlight();
                window.location.hash = '';
                return;
            }
        }
        
        playTrack(nextIndex);
    }
    function playPreviousTrack() {
        if (currentPlaylist.length === 0) return;
        let prevIndex;
        
        if (playMode === 1) { 
            prevIndex = currentTrackIndex; 
        } else if (playMode === 2) { 
            prevIndex = getNextRandomIndex();
        } else { 
            if (currentTrackIndex > 0) {
                prevIndex = currentTrackIndex - 1;
            } else if (playMode === 4) { 
                prevIndex = currentPlaylist.length - 1; 
            } else { 
                audio.pause();
                playerTitle.textContent = "å·²åˆ°é”åˆ—è¡¨é–‹é ­ã€‚";
                currentTrackIndex = -1;
                updatePlaylistHighlight();
                window.location.hash = '';
                return;
            }
        }
        
        playTrack(prevIndex);
    }
    
    // â­ï¸ æ ¸å¿ƒï¼šä½¿ç”¨ data-index åŒ¹é… currentTrackIndex
    function updatePlaylistHighlight(manualScroll = false) {
        const listItems = document.querySelectorAll('#playlist li');
        
        listItems.forEach(item => {
            item.classList.remove('playing');
        });
        
        if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
            const playingItem = Array.from(listItems).find(item => {
                const dataIndex = item.getAttribute('data-index');
                return dataIndex && parseInt(dataIndex) === currentTrackIndex;
            });
            
            if (playingItem) {
                playingItem.classList.add('playing');
                
                if (!manualScroll) {
                     playingItem.scrollIntoView({
                        behavior: 'smooth', 
                        block: 'nearest'    
                    });
                }
            }
        }
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± (ä¿æŒä¸è®Š) ---
    audio.addEventListener('ended', () => {
        incrementPlayCount(); 
        sortPlaylistByPlayCount(); // æ’åºä¸¦æ¸²æŸ“
        saveSettings(); 
        
        let nextIndex; 
        if (playMode === 1) { 
            audio.currentTime = 0; 
            audio.play();
            updatePlaylistHighlight(); 
            return; 
        } 
        
        if (playMode === 3) { 
            audio.pause();
            playerTitle.textContent = "è‡ªç”±æ¨¡å¼ä¸‹ï¼Œæ­Œæ›²æ’­æ”¾å®Œç•¢ã€‚";
            currentTrackIndex = -1; 
            updatePlaylistHighlight(); 
            window.location.hash = ''; 
            return; 
        } 
        
        if (playMode === 2) { 
            nextIndex = getNextRandomIndex();
        } else if (playMode === 4) { 
            nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
        } else { 
            if (currentTrackIndex < currentPlaylist.length - 1) { 
                nextIndex = currentTrackIndex + 1;
            } else {
                audio.pause();
                playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
                currentTrackIndex = -1; 
                updatePlaylistHighlight(); 
                window.location.hash = ''; 
                return; 
            }
        }
        if (nextIndex !== undefined && nextIndex !== -1) {
            playTrack(nextIndex);
        }
    });

    function togglePlayMode() {
        playMode = (playMode + 1) % 5; 
        
        updateModeUI();
        
        playerTitle.textContent = `å·²åˆ‡æ›åˆ° ${modeButton.textContent.replace('[ æ¨¡å¼: ', '').replace(' ]', '')}`;
        saveSettings(); 
    }
    
    async function toggleDataMode() {
        dataMode = (dataMode === 'local') ? 'global' : 'local';
        
        updateDataModeUI();
        saveSettings(); 
        
        playerTitle.textContent = `æ•¸æ“šæ¨¡å¼å·²åˆ‡æ›ç‚ºï¼š${(dataMode === 'global' ? 'å…¨çƒçµ±è¨ˆ' : 'æœ¬åœ°çµ±è¨ˆ')}`;
        
        // â­ï¸ ä¿®æ­£ï¼šåˆ‡æ›æ•¸æ“šæ¨¡å¼å¾Œï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–ï¼Œä»¥ä¾¿æ­£ç¢ºè¼‰å…¥æ•¸æ“šå’Œç‹€æ…‹
        await initializePlayer(true); 
    }
    
    function updateDataModeUI() {
        const modeSpan = document.getElementById('current-data-mode');
        if (dataMode === 'global') {
            modeSpan.textContent = "[å…¨çƒçµ±è¨ˆ]";
            modeSpan.style.color = 'red'; 
        } else {
            modeSpan.textContent = "[æœ¬åœ°çµ±è¨ˆ]";
            modeSpan.style.color = '';
        }
    }
    
    function updateModeUI() {
        let modeText;
        
        if (playMode === 1) {
            modeText = "[ æ¨¡å¼: å–®æ›²å¾ªç’° ]";
        } else if (playMode === 2) {
            modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
        } else if (playMode === 3) {
            modeText = "[ æ¨¡å¼: è‡ªç”± ]";
        } else if (playMode === 4) {
            modeText = "[ æ¨¡å¼: é †åºå¾ªç’° ]"; 
        } else {
            modeText = "[ æ¨¡å¼: é †åºåœæ­¢ ]"; 
        }
        
        modeButton.textContent = modeText;
    }

    // --- *** ä¸»é¡Œåˆ‡æ›/å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ (ä¿æŒä¸è®Š) *** ---
    const THEME_STORAGE_KEY = 'userThemePreference';
    const LIGHT_THEME = 'light'; 
    const DARK_THEME = 'dark';   
    const GREY_THEME = 'grey';   
    const BLUE_THEME = 'blue';
    const GREEN_THEME = 'green';
    const PURPLE_THEME = 'purple';
    const PINK_THEME = 'pink';
    const YELLOW_THEME = 'yellow';
    const RED_THEME = 'red';
        
    function applyTheme(desiredTheme, isManual = false) {
        const body = document.body;
        let displayName = '';
        
        body.classList.remove(
            DARK_THEME + '-theme', 
            GREY_THEME + '-theme',
            BLUE_THEME + '-theme',
            GREEN_THEME + '-theme',
            PURPLE_THEME + '-theme', 
            PINK_THEME + '-theme',  
            YELLOW_THEME + '-theme',
            RED_THEME + '-theme'     
        );
        let themeToApply = desiredTheme;
        let modeText = 'ã€æ‰‹å‹•ã€‘';
        if (isManual) {
            localStorage.setItem(THEME_STORAGE_KEY, desiredTheme);
        } 
        else if (desiredTheme === LIGHT_THEME) {
            themeToApply = getSystemThemeBasedOnTime();
            modeText = 'ã€è‡ªå‹•ã€‘';
        }
        if (themeToApply === DARK_THEME) {
            body.classList.add(DARK_THEME + '-theme');
            displayName = 'é»‘è‰²';
        } else if (themeToApply === GREY_THEME) {
            body.classList.add(GREY_THEME + '-theme');
            displayName = 'ç°è‰²';
        } else if (themeToApply === BLUE_THEME) {
            body.classList.add(BLUE_THEME + '-theme');
            displayName = 'è—è‰²';
        } else if (themeToApply === GREEN_THEME) {
            body.classList.add(GREEN_THEME + '-theme');
            displayName = 'ç¶ è‰²';
        } else if (themeToApply === PURPLE_THEME) { 
            body.classList.add(PURPLE_THEME + '-theme');
            displayName = 'ç´«è‰²';
        } else if (themeToApply === PINK_THEME) { 
            body.classList.add(PINK_THEME + '-theme');
            displayName = 'ç²‰è‰²';
        } else if (themeToApply === YELLOW_THEME) { 
            body.classList.add(YELLOW_THEME + '-theme');
            displayName = 'é»ƒè‰²';
        } else if (themeToApply === RED_THEME) { 
            body.classList.add(RED_THEME + '-theme');
            displayName = 'ç´…è‰²';
        } else { 
            displayName = 'ç™½è‰²';
        }
        
        currentThemeName.textContent = `${displayName} ${modeText}`;
    }
    function getSystemThemeBasedOnTime() {
        const hour = new Date().getHours();
        return (hour >= 19 || hour < 7) ? DARK_THEME : LIGHT_THEME;
    }
    function initializeTheme() {
        const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        
        if (storedTheme) {
            if (storedTheme === LIGHT_THEME) {
                 applyTheme(LIGHT_THEME, false); 
            } else {
                 applyTheme(storedTheme, true); 
            }
        } else {
            applyTheme(LIGHT_THEME, false);
        }
    }
    
    themeToggleBtn.addEventListener('click', () => {
        themeMenu.classList.toggle('hidden-menu');
        
        if (!timerMenu.classList.contains('hidden-menu')) {
            timerMenu.classList.add('hidden-menu');
        }
    });
    themeOptions.forEach(option => {
        option.addEventListener('click', (e) => {
            const selectedTheme = e.target.getAttribute('data-theme');
            applyTheme(selectedTheme, true); 
            themeMenu.classList.add('hidden-menu'); 
        });
    });
    
    document.addEventListener('click', (e) => {
        const target = e.target;

        if (!themeMenu.contains(target) && !themeToggleBtn.contains(target)) {
            themeMenu.classList.add('hidden-menu');
        }

        if (!timerMenu.contains(target) && !timerToggleButton.contains(target)) {
            timerMenu.classList.add('hidden-menu');
        }
    });
    setInterval(() => {
        const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        
        if (storedTheme === LIGHT_THEME) {
            applyTheme(LIGHT_THEME, false); 
        }
    }, 1000 * 60 * 60); 
        
    function toggleTimerMenu() {
        timerMenu.classList.toggle('hidden-menu');
        
        if (!themeMenu.classList.contains('hidden-menu')) {
            themeMenu.classList.add('hidden-menu');
        }
    }
    
    function setSleepTimer(minutes) {
        clearSleepTimer();
        toggleTimerMenu(); 
        
        const delayMilliseconds = minutes * 60 * 1000;
        
        sleepTime = minutes * 60;
        endTime = Date.now() + delayMilliseconds;
        
        sleepTimerId = setTimeout(() => {
            audio.pause(); 
            playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾ (${minutes} åˆ†é˜)`;
        }, delayMilliseconds);
        
        countdownIntervalId = setInterval(updateTimerCountdown, 1000);
        timerToggleButton.textContent = `å®šæ™‚ (${minutes} åˆ†é˜)`;
        playerTitle.textContent = `å®šæ™‚å™¨å·²è¨­ç½®ï¼š${minutes} åˆ†é˜å¾Œè‡ªå‹•é—œé–‰`;
        if (audio.paused) {
            audio.play();
        }
    }

    function clearSleepTimer() {
        if (sleepTimerId !== null) {
            clearTimeout(sleepTimerId);
            sleepTimerId = null;
        }
        if (countdownIntervalId !== null) {
            clearInterval(countdownIntervalId);
            countdownIntervalId = null;
        }
        
        sleepTime = 0;
        endTime = 0;
        timerToggleButton.textContent = "å®šæ™‚ (æœªè¨­å®š)";
        remainingTimerSpan.textContent = "--:--";
        playerTitle.textContent = "å·²å–æ¶ˆå®šæ™‚å™¨";
    }
    
    function updateTimerCountdown() {
        if (endTime > 0) {
            const remainingMs = endTime - Date.now();
            const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
            
            const minutes = Math.floor(remainingS / 60);
            const seconds = remainingS % 60;
            
            remainingTimerSpan.textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
            if (remainingS === 0) {
                clearSleepTimer(); 
                if (!audio.paused) {
                     audio.pause();
                     playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾`;
                }
            }
        }
    }

    audio.addEventListener('play', () => {
        if (listenIntervalId === null) {
            listenIntervalId = setInterval(updateTotalListenTime, 1000);
        }
    });
    audio.addEventListener('pause', () => {
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId);
            listenIntervalId = null;
        }
    });
    function updateTotalListenTime() {
        totalListenSeconds++;
        if (totalListenSeconds >= 60) {
            totalListenMinutes++;
            totalListenSeconds = 0;
        }
        
        totalListenTimeSpan.textContent = 
            `${totalListenMinutes} åˆ†é˜ ${totalListenSeconds} ç§’`;
    }

    function updateMusicScore() {
        if (audio.paused) {
            if (scoreTimerIntervalId !== null) {
                clearInterval(scoreTimerIntervalId);
                scoreTimerIntervalId = null;
                scoreAccumulatorSeconds = 0; 
            }
            return;
        }
        
        scoreAccumulatorSeconds++;
        
        if (scoreAccumulatorSeconds >= 60) {
            if (typeof window.addMusicScore === 'function') {
                window.addMusicScore(); 
                console.log("éŠæˆ²åŒ–ï¼šéŸ³æ¨‚è¨ˆæ™‚å™¨è§¸ç™¼ï¼Œå¢åŠ  1 åˆ†é˜éŸ³æ¨‚æ™‚é•·å’Œç©åˆ†ã€‚");
            } else {
                 console.error("éŒ¯èª¤ï¼šwindow.addMusicScore å‡½æ•¸æœªæ‰¾åˆ°ã€‚è«‹æª¢æŸ¥ music.md ä¸­çš„ <script type=module> å°å…¥ã€‚");
            }
            
            scoreAccumulatorSeconds = 0; 
        }
    }
    function incrementPlayCount() {
        if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
            const track = currentPlaylist[currentTrackIndex];
            const key = track.originalIndex; 
            
            trackPlayCounts[key] = (trackPlayCounts[key] || 0) + 1; 
            
            try {
                localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
            } catch (e) {
                console.warn('ç„¡æ³•å„²å­˜æ’­æ”¾æ¬¡æ•¸åˆ° LocalStorage.', e);
            }
            
            if (typeof gtag === 'function') {
                gtag('event', 'song_played', {
                    'song_index': key,           
                    'song_title': track.title    
                });
                console.log(`GA4 äº‹ä»¶ç™¼é€æˆåŠŸ: song_played, æ­Œæ›²ID: ${key}, æ¨™é¡Œ: ${track.title}`);
            } 
        }
    }
        
    // --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ç¾åœ¨ä¸»è¦ç‚º URL éŒ¨é»æœå‹™) ---
    /**
     * @param {number} originalIndex - æ­Œæ›²åœ¨ Master List ä¸­çš„åŸå§‹ç´¢å¼•
     */
    function loadTrack(originalIndex) { 
        
        // 1. å¦‚æœæœç´¢æ¡†æœ‰å…§å®¹ï¼Œæ¸…ç©ºå®ƒä¸¦é‡ç½®æ­Œå–® (é€€å‡ºç¯©é¸)
        const isFiltered = playlistSearchInput.value.trim().length > 0;
        if (isFiltered) {
            playlistSearchInput.value = ''; 
            filterPlaylist(); // é‡ç½® currentPlaylist, æ’åº, ä¸¦æ¸²æŸ“
        }
        
        // 2. åœ¨ç•¶å‰åˆ—è¡¨ (å·²æ’åºæˆ–é‡ç½®) ä¸­æŸ¥æ‰¾æ­Œæ›²
        const newIndex = currentPlaylist.findIndex(track => track.originalIndex === originalIndex);
        
        if (newIndex !== -1) {
            // 3. æ’­æ”¾ä¸¦æ›´æ–°æ¨¡å¼ç‚ºè‡ªç”±æ¨¡å¼
            if (playMode !== 3) {
                playMode = 3; 
                updateModeUI();
                saveSettings(); 
            }
            playTrack(newIndex);
        } else {
            console.error(`loadTrack éŒ¯èª¤: æ­Œæ›² (åŸå§‹ç´¢å¼•: ${originalIndex}) åœ¨ç•¶å‰æ­Œå–®ä¸­æ‰¾ä¸åˆ°ã€‚`);
            playerTitle.textContent = `éŒ¯èª¤ï¼šæ­Œæ›²æ‰¾ä¸åˆ°ã€‚è«‹æ‰‹å‹•é»æ“Šæ­Œå–®ä¸­çš„å…¶ä»–æ­Œæ›²ã€‚`;
        }
    }


    // --- *** æœå°‹/ç¯©é¸é‚è¼¯ *** ---
    function filterPlaylist() {
        const searchText = playlistSearchInput.value.toLowerCase().trim(); 
        
        if (searchText.length > 0) {
            currentPlaylist = MASTER_TRACK_LIST.filter(track => { 
                const itemText = (track.title + ' ' + track.artist).toLowerCase(); 
                return itemText.includes(searchText);
            });
            
            if (listenIntervalId !== null) {
                clearInterval(listenIntervalId); 
                listenIntervalId = null;
            }
            if (currentPlaylist.length === 0) {
                playerTitle.textContent = `æœªæ‰¾åˆ°èˆ‡ "${searchText}" ç›¸é—œçš„æ­Œæ›²ã€‚`;
                audio.pause(); 
                currentTrackIndex = -1;
                
            } else {
                 playerTitle.textContent = `å·²æ ¹æ“šç¯©é¸å»ºç«‹æ–°æ­Œå–® (${currentPlaylist.length} é¦–)ã€‚è«‹é»æ“Šæ’­æ”¾ã€‚`;
                 currentTrackIndex = 0; 
                 
                 const track = currentPlaylist[0]; 
                 audio.src = track.url; 
                 audio.pause(); 
            }
        } else {
            resetCurrentPlaylist(); 
            playerTitle.textContent = "æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨";
            
            if (listenIntervalId !== null) {
                clearInterval(listenIntervalId); 
                listenIntervalId = null;
            }
            
            if (currentTrackIndex === -1 || currentPlaylist.length === 0) {
                currentTrackIndex = 0; 
            }
            
            if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
                const track = currentPlaylist[currentTrackIndex]; 
                audio.src = track.url;
            } else {
                currentTrackIndex = -1;
            }

            audio.pause(); 
        }
        
        // â­ï¸ é—œéµï¼šç„¡è«–ç¯©é¸é‚„æ˜¯æ¸…ç©ºï¼Œéƒ½èª¿ç”¨ sortPlaylistByPlayCount (å®ƒç¾åœ¨è² è²¬æ¸²æŸ“)
        sortPlaylistByPlayCount(); 
    }
    
    // --- æ’­æ”¾åˆ—è¡¨é¡¯ç¤ºèˆ‡æ’åºé‚è¼¯ (æ ¸å¿ƒé‡æ§‹å€) ---

    /**
     * ç²å–å–®å€‹ Track çš„æ’­æ”¾æ¬¡æ•¸å’Œé¡¯ç¤ºè³‡è¨Š
     */
    function getTrackDisplayInfo(track) {
        const originalIndex = track.originalIndex;
        const originalText = track.title + ' - ' + track.artist;
        
        let playCount = 0;
        if (dataMode === 'global') {
            playCount = globalTrackPlayCounts[track.id] || 0; 
        } else {
            playCount = trackPlayCounts[originalIndex] || 0; 
        }
        
        return { originalText, playCount };
    }

    /**
     * â­ï¸ æ ¸å¿ƒé‡æ§‹ï¼šçµ±ä¸€æ¸²æŸ“/é‡æ’åˆ—è¡¨çš„ DOM å‡½æ•¸
     */
    function renderPlaylist() {
        const playlistUl = document.getElementById('playlist');
        playlistUl.innerHTML = ''; 
        
        const fragment = document.createDocumentFragment();

        // æ ¹æ“šç•¶å‰ internal currentPlaylist æ•¸çµ„æ¸²æŸ“ DOM
        currentPlaylist.forEach((track, index) => {
            const li = document.createElement('li');
            li.setAttribute('data-index', index); // å„²å­˜å®ƒåœ¨ç•¶å‰åˆ—è¡¨ä¸­çš„ç´¢å¼• (å³ currentPlaylist çš„ç´¢å¼•)
            const { originalText, playCount } = getTrackDisplayInfo(track);
            
            li.textContent = originalText;
            
            if (playCount > 0) {
                const countSpan = document.createElement('small');
                countSpan.className = 'play-stats'; 
                countSpan.textContent = ` (${playCount} æ¬¡æ’­æ”¾)`;
                countSpan.style.fontSize = '0.8em'; 
                countSpan.style.color = '#888'; 
                countSpan.style.marginLeft = '10px';
                li.appendChild(countSpan);
            }
            
            // â­ï¸ é—œéµä¿®æ­£ï¼šä½¿ç”¨äº‹ä»¶ç›£è½å™¨ï¼Œç¢ºä¿é»æ“Šæ™‚å‚³å…¥çš„æ˜¯ç•¶å‰åˆ—è¡¨ä¸­çš„ç´¢å¼• (index)
            li.addEventListener('click', () => {
                // é»æ“Šå¾Œç›´æ¥æ’­æ”¾å®ƒåœ¨ currentPlaylist ä¸­çš„ç´¢å¼•
                playTrack(index);
                
                // é»æ“Šåˆ—è¡¨æ‡‰é€²å…¥è‡ªç”±æ¨¡å¼
                if (playMode !== 3) {
                     playMode = 3; 
                     updateModeUI();
                     saveSettings();
                }
            });
            
            fragment.appendChild(li);
        });
        
        playlistUl.appendChild(fragment);
        
        // ç¢ºä¿æ›´æ–°é«˜äº®é¡¯ç¤º (å› ç‚º DOM å·²ç¶“é‡æ§‹)
        updatePlaylistHighlight(true);
    }


    /**
     * â­ï¸ æœ€çµ‚ä¿®æ­£ï¼šsortPlaylistByPlayCount å‡½æ•¸ (åªæ’åºè³‡æ–™ï¼Œç„¶å¾Œèª¿ç”¨æ¸²æŸ“)
     */
    function sortPlaylistByPlayCount() {
        
        // ç¯©é¸ç‹€æ…‹ä¸‹ï¼Œåªæ¸²æŸ“ï¼Œä¸æ’åº
        if (currentPlaylist.length !== MASTER_TRACK_LIST.length) {
             renderPlaylist(); 
             return;
        }
        
        // 1. æº–å‚™ç”¨æ–¼æ’åºçš„å¢å¼·åˆ—è¡¨
        const sortableList = [...MASTER_TRACK_LIST].map(track => {
            const { playCount } = getTrackDisplayInfo(track);
            return { ...track, playCount: playCount };
        });
        
        // 2. åŸ·è¡Œæ’åº
        sortableList.sort((a, b) => {
            if (b.playCount !== a.playCount) {
                return b.playCount - a.playCount;
            }
            return a.originalIndex - b.originalIndex; 
        });
        
        // 3. å„²å­˜ç•¶å‰æ’­æ”¾æ­Œæ›²çš„åŸå§‹ç´¢å¼• (åœ¨æ’åºå‰ç²å–)
        const currentlyPlayingOriginalIndex = currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length
            ? currentPlaylist[currentTrackIndex].originalIndex 
            : -1; 
            
        // 4. æ›´æ–°å…§éƒ¨æ’­æ”¾åˆ—è¡¨ currentPlaylist
        currentPlaylist = sortableList; 
        
        // 5. é‡æ–°å®šä½ç•¶å‰æ­Œæ›²åœ¨æ–°åˆ—è¡¨ä¸­çš„ç´¢å¼• (å¦‚æœæœ‰æ­Œæ›²åœ¨æ’­æ”¾)
        if (currentlyPlayingOriginalIndex !== -1) {
            const newIndex = currentPlaylist.findIndex(track => track.originalIndex === currentlyPlayingOriginalIndex);
            currentTrackIndex = newIndex !== -1 ? newIndex : 0; 
        } else {
            currentTrackIndex = 0;
        }

        // 6. æ ¸å¿ƒï¼šèª¿ç”¨æ¸²æŸ“å‡½æ•¸ä¾†é‡ç¹ª DOM
        renderPlaylist();
        
        // 7. ç¢ºä¿éŸ³æºå’Œæ¨™é¡Œæ­£ç¢º (åœ¨åˆå§‹åŒ–ä¸­æœƒè¦†è“‹ï¼Œä½†åœ¨åˆ‡æ›æ•¸æ“šæ¨¡å¼æ™‚éœ€è¦)
        if (currentTrackIndex !== -1 && currentTrackIndex < currentPlaylist.length) {
            const track = currentPlaylist[currentTrackIndex];
            audio.src = track.url; 
            if (!audio.paused) {
                playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title} (æ­Œå–®å·²æ’åº)`;
            } else if (!playlistSearchInput.value.trim()){ // åƒ…åœ¨éç¯©é¸ç‹€æ…‹ä¸‹æ›´æ–°æ¨™é¡Œ
                playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title} (æ­Œå–®å·²æ’åº)`;
            }
        }
    }


    // --- *** LocalStorage é‚è¼¯ *** ---
    const CURRENT_TRACK_INDEX_KEY = 'audioPlayerOriginalIndex';
    const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

    function saveSettings() {
        try {
            localStorage.setItem('audioPlayerVolume', audio.volume);
            localStorage.setItem('audioPlayerMuted', audio.muted);
            localStorage.setItem('audioPlayerMode', playMode);
            localStorage.setItem(DATA_MODE_STORAGE_KEY, dataMode);  
            
            if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
                const track = currentPlaylist[currentTrackIndex];
                // â­ï¸ å„²å­˜åŸå§‹ç´¢å¼•ï¼Œèˆ‡åˆ—è¡¨çš„æ’åºç„¡é—œ
                localStorage.setItem(CURRENT_TRACK_INDEX_KEY, track.originalIndex); 
            } else {
                localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
            }
            
            if (audio.currentTime > 0) {
                 localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
            } else {
                 localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
            }
            
        } catch (e) {
            console.warn('LocalStorage is not available or blocked.', e);
        }
    }

    // â­ï¸ ä¿®æ­£å¾Œçš„ loadSavedSettings å‡½æ•¸ (åªè®€å–æ•¸æ“šï¼Œä¸è¨­å®šæ’­æ”¾å™¨ç‹€æ…‹)
    function loadSavedSettings() {
        try {
            const savedVolume = localStorage.getItem('audioPlayerVolume');
            if (savedVolume !== null) {
                audio.volume = Math.max(0, Math.min(1, parseFloat(savedVolume)));
            }
            const savedMuted = localStorage.getItem('audioPlayerMuted');
            if (savedMuted !== null) {
                audio.muted = (savedMuted === 'true');
            }
            
            const savedMode = localStorage.getItem('audioPlayerMode');
            if (savedMode !== null) {
                const mode = parseInt(savedMode);
                if (mode >= 0 && mode <= 4) { 
                    playMode = mode; 
                } else {
                    playMode = 0; 
                }
            } else {
                playMode = 0; 
            }
            updateModeUI(); 

            
            const savedCounts = localStorage.getItem(PLAY_COUNT_STORAGE_KEY);
            if (savedCounts) {
                trackPlayCounts = JSON.parse(savedCounts);
            }
            
            const savedDataMode = localStorage.getItem(DATA_MODE_STORAGE_KEY);
            if (savedDataMode && (savedDataMode === 'local' || savedDataMode === 'global')) {
                dataMode = savedDataMode;
            }
            updateDataModeUI(); 

            
            const savedOriginalIndex = localStorage.getItem(CURRENT_TRACK_INDEX_KEY);
            
            // ğŸš¨ é—œéµä¿®æ­£ï¼šåªå„²å­˜ä¸Šæ¬¡æ’­æ”¾çš„åŸå§‹ç´¢å¼•ï¼Œä¸åœ¨æ­¤è™•è¨­å®š currentTrackIndex æˆ– audio.src
            if (savedOriginalIndex !== null) {
                const originalIndex = parseInt(savedOriginalIndex);
                
                if (originalIndex >= 0 && originalIndex < MASTER_TRACK_LIST.length) { 
                    window.__LAST_PLAYED_ORIGINAL_INDEX = originalIndex;
                } else {
                     // æ¸…ç†ç„¡æ•ˆçš„ç´¢å¼•
                     localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); 
                }
            } else {
                 window.__LAST_PLAYED_ORIGINAL_INDEX = -1;
            }
            
            // å‚™è¨»ï¼šsavedTime ä¹Ÿåœ¨ initializePlayer çµæŸæ™‚çµ±ä¸€è™•ç†ï¼Œä¿æŒåŸæ¨£
            
            // æ¸…ç†ä¸å†å­˜åœ¨çš„æ­Œæ›²è¨ˆæ•¸
            const currentKeys = MASTER_TRACK_LIST.map(t => t.originalIndex.toString());
            let keysToDelete = [];
            for (const key in trackPlayCounts) {
                if (!currentKeys.includes(key)) {
                    keysToDelete.push(key);
                }
            }
            keysToDelete.forEach(key => delete trackPlayCounts[key]);
            
            localStorage.setItem(PLAY_COUNT_STORAGE_KEY, JSON.stringify(trackPlayCounts));
            
        } catch (e) {
            console.warn('Failed to load settings from LocalStorage.', e);
        }
    }

    // --- *** URL éŒ¨é»è™•ç†é‚è¼¯ (ä¿æŒä¸è®Š) *** ---
    function handleUrlAnchor(isInitialLoad = false) {
        const hash = window.location.hash;
        
        if (hash.startsWith('#song-index-')) {
            const parts = hash.split('-');
            const originalIndex = parseInt(parts[parts.length - 1]);
            
            if (!isNaN(originalIndex) && originalIndex >= 0 && originalIndex < MASTER_TRACK_LIST.length) {
                
                const trackTitle = MASTER_TRACK_LIST[originalIndex].title;
                
                loadTrack(originalIndex); 
                
                if (isInitialLoad) {
                    playMode = 0; // é †åºåœæ­¢
                    updateModeUI();
                    saveSettings();
                }
                
                playerTitle.textContent = `å¾åˆ†äº«é€£çµè¼‰å…¥ï¼š${trackTitle} (æ­£åœ¨ç·©è¡...)`;
                const handlePlaying = () => {
                     if (playerTitle.textContent.includes(trackTitle)) { 
                         playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${trackTitle}`;
                         audio.removeEventListener('playing', handlePlaying);
                     }
                };
                audio.addEventListener('playing', handlePlaying);
                
                audio.play().catch(error => {
                     playerTitle.textContent = `å¾åˆ†äº«è¼‰å…¥ï¼š${trackTitle} (éœ€é»æ“Šæ’­æ”¾)`;
                });
            }
        }
    }
    // ------------------------------------
    // --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---
    audio.addEventListener('volumechange', saveSettings);
    audio.addEventListener('ratechange', saveSettings); 
    audio.addEventListener('loadedmetadata', saveSettings); 
    audio.addEventListener('timeupdate', () => {
        if (!audio.paused && audio.currentTime % 5 < 1) {
             saveSettings();
        }
    });
    audio.addEventListener('play', () => {
        if (listenIntervalId === null) {
            listenIntervalId = setInterval(updateTotalListenTime, 1000);
        }
        
        if (scoreTimerIntervalId === null) {
            scoreTimerIntervalId = setInterval(updateMusicScore, 1000); 
        }
        
        if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
            const currentSongId = currentPlaylist[currentTrackIndex].id; 
            trackPlayToDatabase(currentSongId); 
        }
        
        saveSettings(); 
    });
    audio.addEventListener('pause', () => {
        if (listenIntervalId !== null) {
            clearInterval(listenIntervalId);
            listenIntervalId = null;
        }
        
        if (scoreTimerIntervalId !== null) {
            clearInterval(scoreTimerIntervalId);
            scoreTimerIntervalId = null;
        }
        
        saveSettings();
    });

    audio.addEventListener('ended', saveSettings);
    playlistSearchInput.addEventListener('input', debounce(filterPlaylist, 300));

    // --- *** ç•°æ­¥åˆå§‹åŒ–å‡½æ•¸ *** ---

    async function initializePlayer(isManualToggle = false) {
        
        // 1. è¼‰å…¥æœ¬åœ°è¨­ç½® (åªè®€å–æ•¸æ“šå’Œæ¨¡å¼)
        loadSavedSettings(); 
        
        // 2. åªæœ‰åœ¨æ¨¡å¼è¨­å®šç‚º 'global' æ™‚æ‰ç™¼èµ· API è«‹æ±‚
        if (dataMode === 'global') {
             document.getElementById('current-data-mode').textContent = '[è¼‰å…¥ä¸­...]'; 
             const counts = await fetchGlobalPlayCounts();
             globalTrackPlayCounts = counts; 
             document.getElementById('current-data-mode').textContent = '[å…¨çƒçµ±è¨ˆ]'; 
        } else {
             globalTrackPlayCounts = {}; 
             document.getElementById('current-data-mode').textContent = '[æœ¬åœ°çµ±è¨ˆ]';
        }

        // 3. æª¢æŸ¥æ˜¯å¦åœ¨ç¯©é¸ç‹€æ…‹ï¼Œä¸¦é‡ç½® currentPlaylist 
        if (playlistSearchInput.value.trim().length > 0) {
            filterPlaylist(); // æ­¤å‡½æ•¸æœƒèª¿ç”¨ sortPlaylistByPlayCount
        } else {
            resetCurrentPlaylist(); 
            sortPlaylistByPlayCount(); // æ’åºä¸¦æ¸²æŸ“ (ä¸¦åœ¨å…§éƒ¨é‡æ–°å®šä½ currentTrackIndex)
        }
        
        // 4. æ ¹æ“šå„²å­˜çš„ originalIndex æœ€çµ‚ç¢ºå®š currentTrackIndex å’Œæ’­æ”¾å™¨ç‹€æ…‹
        const lastPlayedOriginalIndex = window.__LAST_PLAYED_ORIGINAL_INDEX;
        
        if (lastPlayedOriginalIndex !== -1) {
            
            // ğŸš¨ é—œéµï¼šåœ¨æ’åºå¾Œçš„ currentPlaylist ä¸­æŸ¥æ‰¾æ­Œæ›²
            const newIndex = currentPlaylist.findIndex(track => track.originalIndex === lastPlayedOriginalIndex);
            
            if (newIndex !== -1) {
                currentTrackIndex = newIndex; // è¨­ç½®æ­£ç¢ºçš„ç´¢å¼•ï¼
            } else {
                 // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±ä¿æŒ sortPlaylistByPlayCount è¨­å®šçš„ 0
                 currentTrackIndex = 0; 
            }
        } else {
             // å¦‚æœæ²’æœ‰ä¸Šæ¬¡æ’­æ”¾è¨˜éŒ„ï¼Œå°±ä¿æŒ sortPlaylistByPlayCount è¨­å®šçš„ 0
             currentTrackIndex = 0;
        }
        
        delete window.__LAST_PLAYED_ORIGINAL_INDEX; 

        // 5. æœ€çµ‚è¨­ç½®æ’­æ”¾å™¨ç‹€æ…‹
        if (currentTrackIndex >= 0 && currentTrackIndex < currentPlaylist.length) {
            const track = currentPlaylist[currentTrackIndex];
            audio.src = track.url; 
            playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
            
            // è™•ç†ä¸Šæ¬¡æ’­æ”¾çš„æ™‚é–“é»
            const savedTime = localStorage.getItem(CURRENT_TRACK_TIME_KEY);
            if (savedTime !== null) { 
                const time = parseFloat(savedTime);
                if (!isNaN(time) && time > 0) {
                    audio.currentTime = time;
                    localStorage.removeItem(CURRENT_TRACK_TIME_KEY); 
                }
            }
            
            updatePlaylistHighlight();
        } else {
             currentTrackIndex = -1; // æ²’æœ‰æ­Œæ›²
             playerTitle.textContent = "æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨ (ç„¡æ­Œæ›²)";
        }
        
        initializeTheme();
    }

    // â­ï¸ é—œéµä¿®æ­£ 2: ä¿®æ­£ DOMContentLoaded é–‰åˆ 
    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. å•Ÿå‹•æ’­æ”¾å™¨ (è¼‰å…¥è¨­ç½®ã€æ•¸æ“šã€æ’åºã€æ¸²æŸ“ã€è¨­å®šç‹€æ…‹)
        initializePlayer(); 
        
        // 2. è™•ç† URL éŒ¨é» (åªåœ¨é¦–æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œæ¨¡å¼é‡ç½®)
        handleUrlAnchor(true);
    });
</script>
<script>
    // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Service Worker
    if ("serviceWorker" in navigator) {
        // è¨»å†Š Service Workerã€‚å¦‚æœæ‚¨çš„ service-worker.js åœ¨æ ¹ç›®éŒ„ï¼Œè«‹ä½¿ç”¨ /service-worker.js
        navigator.serviceWorker.register("/service-worker.js")
            .then(reg => console.log("SW è¨»å†ŠæˆåŠŸ", reg))
            .catch(err => console.error("SW è¨»å†Šå¤±æ•—", err));
    }
</script>
