# .github/workflows/cpanel_deploy.yml
# å°ˆé–€ç”¨æ–¼æ§‹å»º Jekyll ä¸¦é€é FTP éƒ¨ç½²åˆ° cPanel ä¼ºæœå™¨

name: Deploy to cPanel via FTP

on:
  # ç•¶ push åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼è‡ªå‹•éƒ¨ç½²
  push:
    branches: ["main"]
  # ä¹Ÿå…è¨±æ‰‹å‹•å¾ GitHub ä»‹é¢è§¸ç™¼
  workflow_dispatch:

permissions:
  contents: read

jobs:
  cpanel_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # ç¢ºä¿ä½¿ç”¨èˆ‡æ‚¨ Jekyll å°ˆæ¡ˆç›¸ç¬¦çš„ Ruby ç‰ˆæœ¬ (æ‚¨ä¹‹å‰ä½¿ç”¨çš„æ˜¯ 3.2)
      - name: Setup Ruby (Required for Jekyll Build)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true  # å®‰è£ Gemfile.lock ä¸­çš„ä¾è³´

      - name: Build Jekyll Site
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production
      
      - name: ğŸš€ Deploy built files to cPanel /public_html (via Password SFTP)
        # ğŸš¨ å†æ¬¡æ›´æ› Actionï¼ä½¿ç”¨æ”¯æ´å¯†ç¢¼çš„ SFTP Action
        uses: w9jds/action-sftp-with-password@v3 
        with:
          # é€£æ¥è³‡è¨Šï¼Œé€™å€‹ Action çš„åƒæ•¸åç¨±æ˜¯æ˜ç¢ºä¸”æ”¯æ´å¯†ç¢¼çš„
          host: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 22 # æ¨™æº– SFTP ç«¯å£
          
          # ä¸Šå‚³ Jekyll çš„è¼¸å‡ºç›®éŒ„
          localPath: ./_site/
          # æ‚¨çš„ç¶²ç«™æ ¹ç›®éŒ„
          remotePath: /home/xxyzyh/public_html/
          
          # åƒæ•¸ï¼šå°‡æœ¬åœ°æ‰€æœ‰æ–‡ä»¶è¤‡è£½åˆ°é ç«¯
          args: "-r" 
          
          # é€™å€‹ Action ä¸æ”¯æ´è‡ªå‹•åˆªé™¤ï¼Œå®ƒåªè² è²¬è¤‡è£½ã€‚
          # å¦‚æœéœ€è¦åˆªé™¤èˆŠæª”æ¡ˆï¼Œæˆ‘å€‘å¿…é ˆåœ¨éƒ¨ç½²å‰æ‰‹å‹•åŸ·è¡Œä¸€å€‹SSHå‘½ä»¤ï¼Œ
          # ä½†æˆ‘å€‘æ²’æœ‰è¨­å®šSSHé‡‘é‘°ã€‚æˆ‘å€‘åªèƒ½æ¥å—å®ƒåªæœƒè¦†è“‹æª”æ¡ˆã€‚
