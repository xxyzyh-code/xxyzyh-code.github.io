name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”‘ Set up SSH Key and Known Hosts
        # ä½¿ç”¨ webfactory/ssh-agent@v0.9.1 å°å…¥ç§å¯†é‡‘é‘°
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}
          # ğŸš¨ é—œéµæ”¹è®Šï¼šé€™è£¡è¨­ç½®ç‚ºæ‰‹å‹•é…ç½® Known Hosts
          known-hosts-path: /dev/null

      - name: ğŸ“ Add GitLab Host Key to Known Hosts
        # é€™æ˜¯ç‚ºäº†é¿å… "Host key verification failed." éŒ¯èª¤
        run: |
          # ç²å– GitLab.com çš„æŒ‡ç´‹ä¸¦å¯«å…¥ known_hostsï¼Œè®“ SSH è‡ªå‹•ä¿¡ä»»å®ƒ
          mkdir -p ~/.ssh
          echo "gitlab.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQIzbBv2sB...[ä¸­é–“çœç•¥ï¼Œé€™æ˜¯å®˜æ–¹æŒ‡ç´‹]" >> ~/.ssh/known_hosts
          echo "gitlab.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAfuIDUo...[ä¸­é–“çœç•¥ï¼Œé€™æ˜¯å®˜æ–¹æŒ‡ç´‹]" >> ~/.ssh/known_hosts
          
          # ç‚ºäº†ç°¡åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ ssh-keyscan (æ›´è‡ªå‹•ï¼Œä½†æœ‰æ™‚åœ¨ CI ä¸­è¢«ç¦ç”¨)
          # ssh-keyscan -t rsa,ed25519 gitlab.com >> ~/.ssh/known_hosts
          
          # è¨­ç½®æ­£ç¢ºçš„æ¬Šé™
          chmod 600 ~/.ssh/known_hosts

      - name: ğŸ”„ Deploy to GitLab via SSH
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ä½¿ç”¨ SSH URL é€²è¡Œæ¨é€
          GITLAB_REPO_SSH="git@gitlab.com:xxyzyh/my-blog.git"
          
          git remote add gitlab "$GITLAB_REPO_SSH"
          echo "ğŸš€ Pushing entire GitHub repository to GitLab via SSH..."
          
          # å˜—è©¦æ¨é€
          git push --force gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete! SSH push successful."
          else
            echo "âŒ Synchronization FAILED. Check permissions or SSH Key."
            exit 1
          fi
