name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        # æ‹‰å–æ•´å€‹å€‰åº«ï¼Œfetch-depth: 0 å°æ–¼åŒæ­¥å¾ˆé‡è¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”„ Deploy to GitLab
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ é—œéµè§£æ±ºæ–¹æ¡ˆï¼šä½¿ç”¨ tr -d æ¸…ç† Secret ä¸­çš„æ‰€æœ‰æ§åˆ¶å­—å…ƒï¼ˆåŒ…æ‹¬å›è»Šå’Œæ›è¡Œï¼‰
          # é€™æœƒç¢ºä¿ Token å€¼æ˜¯ä¸€å€‹ç´”æ·¨çš„å­—ä¸²ï¼Œä¸æœƒç ´å£ Bash å‘½ä»¤çµæ§‹
          CLEAN_TOKEN=$(echo -n "${{ secrets.GITLAB_TOKEN }}" | tr -d '[:cntrl:]')
          
          # 1. å°æ¸…æ´—å¾Œçš„ Token é€²è¡Œ URL ç·¨ç¢¼
          # é€™æ˜¯ç‚ºäº†ç¢ºä¿ Token ä¸­çš„æ‰€æœ‰ç‰¹æ®Šå­—å…ƒéƒ½èƒ½è¢« Git æ­£ç¢ºè§£æ
          GITLAB_TOKEN_ENCODED=$(echo -n "$CLEAN_TOKEN" | xxd -p | sed 's/\(..\)/%\1/g')
          
          # 2. æ§‹å»ºæœ€çµ‚ URL (å‹™å¿…æ›¿æ› YOUR_GITLAB_USERNAME)
          # æ³¨æ„ï¼šæˆ‘å€‘ä½¿ç”¨å–®å¼•è™Ÿ ('...') ä¾†åŒ…åœè®Šæ•¸è³¦å€¼ï¼Œç¢ºä¿ $GITLAB_REPO è®Šæ•¸çš„çµæ§‹å®Œæ•´
          GITLAB_REPO="https://xxyzyh:$GITLAB_TOKEN_ENCODED@gitlab.com/xxyzyh/my-blog.git"
          
          # 3. æ·»åŠ é ç¨‹å€‰åº«ä¸¦æ¨é€
          git remote add gitlab "$GITLAB_REPO" # ğŸš¨ æ³¨æ„ï¼šé€™è£¡ä¹Ÿçµ¦ $GITLAB_REPO åŠ ä¸Šäº†é›™å¼•è™Ÿ
          echo "ğŸš€ Pushing code to GitLab repository..."
          
          # å˜—è©¦æ¨é€
          git push --force --quiet gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete!"
          else
            echo "âŒ Synchronization FAILED. Token or Protected Branch Issue."
            exit 1
          fi
          
