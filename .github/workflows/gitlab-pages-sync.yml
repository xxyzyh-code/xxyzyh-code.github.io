name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”‘ Set up SSH Key and Known Hosts
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}
          # ğŸš¨ é—œéµæ”¹è®Šï¼šä¸ä½¿ç”¨ known-hosts-path åƒæ•¸ï¼Œè®“ä¸‹ä¸€æ­¥æ‰‹å‹•é…ç½®
          
      - name: ğŸ“ Add GitLab Host Key to Known Hosts
        run: |
          # å‰µå»º .ssh ç›®éŒ„
          mkdir -p ~/.ssh
          # ğŸš¨ ç²å– GitLab ä¼ºæœå™¨çš„æŒ‡ç´‹ä¸¦æ·»åŠ åˆ° known_hosts
          ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
          # è¨­ç½®æ­£ç¢ºçš„æ¬Šé™
          chmod 600 ~/.ssh/known_hosts
          
      - name: ğŸ”„ Deploy to GitLab via SSH
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ä½¿ç”¨ SSH URL é€²è¡Œæ¨é€
          GITLAB_REPO_SSH="git@gitlab.com:xxyzyh/my-blog.git"
          
          git remote add gitlab "$GITLAB_REPO_SSH"
          echo "ğŸš€ Pushing entire GitHub repository to GitLab via SSH..."
          
          # å˜—è©¦æ¨é€
          git push --force gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete! SSH push successful."
          else
            echo "âŒ Synchronization FAILED. Final check of Private Key and GitLab Deploy Key Write Access."
            exit 1
          fi
