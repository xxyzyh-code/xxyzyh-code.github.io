name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        # æ‹‰å–æ•´å€‹å€‰åº«ï¼Œfetch-depth: 0 å°æ–¼åŒæ­¥å¾ˆé‡è¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”„ Deploy to GitLab
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ æœ€çµ‚æ¸…ç†ï¼šç²¾ç¢ºæ¸…ç†æ›è¡Œç¬¦å’Œç©ºæ ¼ï¼Œç¢ºä¿ Token æ˜¯ä¸€å€‹ç´”æ·¨å­—ä¸²
          # é€™æ˜¯ç‚ºäº†è§£æ±ºä½ å¤šæ¬¡é‡åˆ°çš„ "newline in its password component" è­¦å‘Šã€‚
          CLEAN_TOKEN=$(echo -n "${{ secrets.GITLAB_TOKEN }}" | tr -d '\n\r ')
          
          # 1. å°æ¸…æ´—å¾Œçš„ Token é€²è¡Œ URL ç·¨ç¢¼
          # ç¢ºä¿ Token ä¸­çš„ç‰¹æ®Šå­—å…ƒèƒ½è¢« Git æ­£ç¢ºè§£æ
          GITLAB_TOKEN_ENCODED=$(echo -n "$CLEAN_TOKEN" | xxd -p | sed 's/\(..\)/%\1/g')
          
          # 2. æ§‹å»ºæœ€çµ‚ URL (å‹™å¿…æ›¿æ› YOUR_GITLAB_USERNAME)
          GITLAB_REPO="https://xxyzyh:$GITLAB_TOKEN_ENCODED@gitlab.com/xxyzyh/my-blog.git"
          
          # 3. æ·»åŠ é ç¨‹å€‰åº«ä¸¦æ¨é€
          # Git æœƒå°‡ç•¶å‰å·¥ä½œç›®éŒ„ (ä½ çš„æ•´å€‹ GitHub å€‰åº«) æ¨é€ä¸Šå»
          git remote add gitlab "$GITLAB_REPO"
          echo "ğŸš€ Pushing entire GitHub repository to GitLab..."
          
          # å˜—è©¦æ¨é€ï¼Œ--force ç¢ºä¿è¦†è“‹ GitLab ä¸Šåªæœ‰ .gitlab-ci.yml çš„ç‹€æ…‹
          git push --force --quiet gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete! Check GitLab CI/CD for Jekyll build pipeline."
          else
            echo "âŒ Synchronization FAILED. Check Secret value in GitHub."
            exit 1
          fi
