name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        # æ‹‰å–æ•´å€‹å€‰åº«ï¼Œfetch-depth: 0 å°æ–¼åŒæ­¥å¾ˆé‡è¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”„ Deploy to GitLab
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ é—œéµè§£æ±ºæ–¹æ¡ˆï¼šç²¾ç¢ºæ¸…ç†æ›è¡Œç¬¦ï¼Œä¸¦å»é™¤æ‰€æœ‰ç©ºæ ¼
          # -n ç¢ºä¿æ²’æœ‰å°¾éš¨æ›è¡Œï¼Œtr -d '\n\r ' ç¢ºä¿å»é™¤æ‰€æœ‰æ›è¡Œå’Œç©ºæ ¼
          CLEAN_TOKEN=$(echo -n "${{ secrets.GITLAB_TOKEN }}" | tr -d '\n\r ')
          
          # 1. å°æ¸…æ´—å¾Œçš„ Token é€²è¡Œ URL ç·¨ç¢¼
          # é€™æ˜¯ç‚ºäº†ç¢ºä¿ Token ä¸­çš„æ‰€æœ‰ç‰¹æ®Šå­—å…ƒéƒ½èƒ½è¢« Git æ­£ç¢ºè§£æ
          GITLAB_TOKEN_ENCODED=$(echo -n "$CLEAN_TOKEN" | xxd -p | sed 's/\(..\)/%\1/g')
          
          # 2. æ§‹å»ºæœ€çµ‚ URL (å‹™å¿…æ›¿æ› YOUR_GITLAB_USERNAME)
          # æ³¨æ„ï¼šæˆ‘å€‘ç¾åœ¨å¯ä»¥ç›¸ä¿¡è®Šæ•¸æ˜¯ä¹¾æ·¨çš„ï¼Œä½†ä»ä½¿ç”¨é›™å¼•è™Ÿ
          GITLAB_REPO="https://xxyzyh:$GITLAB_TOKEN_ENCODED@gitlab.com/xxyzyh/my-blog.git"
          
          # 3. æ·»åŠ é ç¨‹å€‰åº«ä¸¦æ¨é€
          # åœ¨é€™è£¡ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ git remote add çœ‹ä¸åˆ°ä»»ä½•æ›è¡Œç¬¦
          git remote add gitlab "$GITLAB_REPO"
          echo "ğŸš€ Pushing code to GitLab repository..."
          
          # å˜—è©¦æ¨é€
          git push --force --quiet gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete!"
          else
            echo "âŒ Synchronization FAILED. Token Cleanup/Permission Issue."
            exit 1
          fi
