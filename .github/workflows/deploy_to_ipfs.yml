# .github/workflows/deploy_to_ipfs.yml
name: Jekyll Build & Deploy to IPFS (via NFT.Storage)

on:
  push:
    branches:
      - main

jobs:
  deploy_ipfs:
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢æŸ¥ç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # ç¢ºä¿æœ‰æ¬Šé™æ¨é€ CID æ–‡ä»¶

      # --- ğŸš€ Jekyll æ§‹å»ºæµç¨‹ (ä¿æŒä¸è®Š) ---
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2' 
          bundler-cache: true 

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      - name: Build Jekyll site
        run: |
          echo "ğŸ’¡ Starting Jekyll build..."
          JEKYLL_ENV=production bundle exec jekyll build --config _config.yml
          echo "âœ… Jekyll build complete. Files are in _site/."
      
      # --- Jekyll æ§‹å»ºæµç¨‹çµæŸ ---


      # 2. ã€æœ€çµ‚ä¿®æ­£ï¼šä½¿ç”¨ clouddrove/ipfs-upload-actionã€‘
      - name: Upload to IPFS via NFT.Storage
        id: ipfs_deploy
        # æ›¿æ›ç‚ºå¯ç”¨çš„ Action é€£çµ
        uses: clouddrove/ipfs-upload-action@v1 
        with:
          path: ./_site/ 
          # è©² Action ä»ç„¶ä½¿ç”¨ NFT_STORAGE_TOKEN é€²è¡Œé©—è­‰
          token: ${{ secrets.NFT_STORAGE_TOKEN }}
          
      # 3. æå– CID ä¸¦æº–å‚™æ›´æ–°æ–‡ä»¶
      - name: Extract CID for Update
        id: extract_cid
        run: |
          # clouddrove Action çš„è¼¸å‡ºè®Šæ•¸ç‚º cid
          NEW_CID="${{ steps.ipfs_deploy.outputs.cid }}" 
          
          if [ -z "$NEW_CID" ]; then
            echo "âŒ IPFS Upload failed: CID is empty."
            exit 1
          fi

          echo "NEW_CID=$NEW_CID" >> $GITHUB_OUTPUT
          # é€™è£¡å›ºå®šä½¿ç”¨ dweb.link ä½œç‚ºå…¬å…±ç¶²é—œé€£çµ
          echo "GATEWAY_USED=https://dweb.link" >> $GITHUB_OUTPUT
          echo "âœ… CID extracted: $NEW_CID"

      # 4. æ›´æ–° CID æ­·å²å’Œæœ€æ–°é€£çµæ–‡ä»¶
      - name: Update CID History and Latest Link ğŸ“
        if: success() 
        env:
          NEW_CID: ${{ steps.extract_cid.outputs.NEW_CID }} 
          GATEWAY_USED: ${{ steps.extract_cid.outputs.GATEWAY_USED }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          LATEST_CID_FILE="CID_LATEST.md"
          HISTORY_CID_FILE="CID_HISTORY.md"
          CID_LINK="$GATEWAY_USED/ipfs/$NEW_CID" 
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # æª¢æŸ¥ CID æ˜¯å¦æœ‰è®Šæ›´ (ä¿æŒä¸è®Š)
          OLD_CID=""
          if [ -f $LATEST_CID_FILE ]; then
              OLD_CID=$(grep 'CID:' $LATEST_CID_FILE | head -1 | sed -e 's/.*`\([a-zA-Z0-9]*\)`/\1/')
          fi

          if [ "$NEW_CID" = "$OLD_CID" ]; then
              echo "CID ($NEW_CID) æœªè®Šæ›´ï¼Œç„¡éœ€æ¨é€æ–‡ä»¶ã€‚"
              exit 0 
          fi
          
          echo "ğŸ”‘ CID è®Šæ›´åµæ¸¬åˆ°ã€‚æ­£åœ¨æ›´æ–°æ–‡ä»¶..."

          # æ›´æ–° LATEST CID æ–‡ä»¶ (è¦†è“‹)
          cat > $LATEST_CID_FILE <<EOL
# ğŸŒ æœ€æ–° IPFS éƒ¨ç½²é€£çµ

---
### ğŸš€ æœ€æ–°éƒ¨ç½²
ğŸ“… **æ™‚é–“ (UTC):** \`${TIMESTAMP}\`
ğŸ†” **CID:** \`${NEW_CID}\`
ğŸ”— **è¨ªå•é€£çµ (via $GATEWAY_USED):** [é»æ“Šæ­¤è™•è¨ªå•]($CID_LINK)
EOL

          # æ›´æ–° CID æ­·å²æ–‡ä»¶ (Append ä¸¦æ’åºåˆ°æœ€å‰)
          NEW_ENTRY="---
### ğŸ“¦ éƒ¨ç½²æ–¼ $TIMESTAMP
* **CID:** \`${NEW_CID}\`
* **é€£çµ (via $GATEWAY_USED):** [è¨ªå•]($CID_LINK)"

          if [ ! -f $HISTORY_CID_FILE ]; then
              echo "# ğŸ“œ IPFS éƒ¨ç½²æ­·å²è¨˜éŒ„" > $HISTORY_CID_FILE
              echo "$NEW_ENTRY" >> $HISTORY_CID_FILE
          else
              TEMP_FILE=$(mktemp)
              tail -n +2 $HISTORY_CID_FILE > $TEMP_FILE 
              
              echo "# ğŸ“œ IPFS éƒ¨ç½²æ­·å²è¨˜éŒ„" > $HISTORY_CID_FILE
              echo "$NEW_ENTRY" >> $HISTORY_CID_FILE
              
              cat $TEMP_FILE >> $HISTORY_CID_FILE
              rm $TEMP_FILE
          fi
          
          # æäº¤å’Œæ¨é€æ›´æ”¹
          echo "æ­£åœ¨æäº¤å’Œæ¨é€ CID æ–‡ä»¶..."
          git add $LATEST_CID_FILE $HISTORY_CID_FILE
          git commit -m "ğŸ¤– [CI] Auto-update IPFS CID to $NEW_CID"
          git push

      # 5. é¡¯ç¤ºæœ€çµ‚é€£çµ
      - name: Show final deployed link
        if: success()
        run: echo "ğŸŒ Your site deployed via ${{ steps.extract_cid.outputs.GATEWAY_USED }}/ipfs/${{ steps.extract_cid.outputs.NEW_CID }}"
