name: Jekyll Build & Decentralized Deploy

on:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      # ðŸ§± Step 1. æ‹‰å–æºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v3

      # ðŸ§± Step 2. å®‰è£… Ruby + Jekyll
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      # ðŸ§± Step 3. æž„å»º Jekyll ç½‘ç«™
      - name: Build Jekyll site
        run: |
          bundle exec jekyll build
          echo "âœ… Site built at _site/"

      # ðŸ§± Step 4. åŽ‹ç¼©æ‰“åŒ…
      - name: Compress built site
        run: tar -czf site.tar.gz -C _site .

      # ðŸŒ Step 5. ä¼˜å…ˆå°è¯•ä¸Šä¼  Arweave
      - name: Upload to Arweave
        id: arweave
        run: |
          echo "ðŸš€ Uploading to Arweave..."
          RESPONSE=$(curl -s -X POST -F "file=@site.tar.gz" https://arseeding.dev/api/v1/tx/arweave)
          TX_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d':' -f2 | tr -d '"')
          if [ -n "$TX_ID" ]; then
            echo "âœ… Uploaded to Arweave: https://arweave.net/$TX_ID"
            echo "URL=https://arweave.net/$TX_ID" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Arweave upload failed."
          fi
        continue-on-error: true

      # ðŸŒ Step 6. è‹¥ Arweave å¤±è´¥ï¼Œè½¬ NFT.Storage
      - name: Upload to NFT.Storage
        id: nft
        if: steps.arweave.outcome == 'failure'
        run: |
          echo "ðŸš€ Uploading to NFT.Storage..."
          RESPONSE=$(curl -s -X POST -F "file=@site.tar.gz" https://api.nft.storage/upload)
          CID=$(echo "$RESPONSE" | grep -o '"cid":"[^"]*"' | head -1 | cut -d':' -f2 | tr -d '"')
          if [ -n "$CID" ]; then
            echo "âœ… Uploaded to NFT.Storage: https://ipfs.io/ipfs/$CID"
            echo "URL=https://ipfs.io/ipfs/$CID" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ NFT.Storage upload failed."
          fi
        continue-on-error: true

      # ðŸŒ Step 7. è‹¥å‰ä¸¤è€…éƒ½æŒ‚ï¼Œæœ€åŽå°è¯•æœ¬åœ° IPFS
      - name: Temporary IPFS broadcast
        id: ipfs
        if: steps.arweave.outcome == 'failure' && steps.nft.outcome == 'failure'
        run: |
          echo "ðŸš€ Installing and running IPFS..."
          wget -q https://dist.ipfs.tech/kubo/v0.27.0/kubo_v0.27.0_linux-amd64.tar.gz
          tar -xzf kubo_v0.27.0_kubo_v0.27.0_linux-amd64.tar.gz
          cd kubo
          sudo bash install.sh
          ipfs init
          ipfs daemon &
          sleep 15
          CID=$(ipfs add -r ../site.tar.gz | tail -n1 | awk '{print $2}')
          echo "âœ… Broadcasted CID: $CID"
          echo "URL=https://ipfs.io/ipfs/$CID" >> $GITHUB_OUTPUT

      # ðŸª Step 8. æ›´æ–°åˆ°ä»“åº“æ–‡ä»¶
      - name: Update decentralized link file
        run: |
          URL=${{ steps.arweave.outputs.URL || steps.nft.outputs.URL || steps.ipfs.outputs.URL }}
          echo "# ðŸŒ Latest Decentralized Deployment" > DECENTRALIZED_LINK.md
          echo "" >> DECENTRALIZED_LINK.md
          echo "ðŸ”— **Access your Jekyll site:** [$URL]($URL)" >> DECENTRALIZED_LINK.md

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add DECENTRALIZED_LINK.md
          git commit -m "ðŸ¤– Auto-update decentralized deploy link"
          git push || echo "No changes to commit"

      # âœ… Step 9. è¾“å‡ºç»“æžœ
      - name: Final output
        run: |
          echo "âœ… Deployment complete!"
          cat DECENTRALIZED_LINK.md
