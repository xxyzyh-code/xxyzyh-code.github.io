---
---

<!doctype html>
{% include copyright.html %}
<html lang="{{ site.locale | replace: "_", "-" | default: "en" }}" class="no-js">
  <head>
    {% include head.html %}
    
    {% if page.permalink == '/music/' %}
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/custom_player.css">
    {% endif %}
    {% include head/custom.html %}
  </head>

  <body class="layout--{{ page.layout | default: layout.layout }}{% if page.classes or layout.classes %}{{ page.classes | default: layout.classes | join: ' ' | prepend: ' ' }}{% endif %}" dir="{% if site.rtl %}rtl{% else %}ltr{% endif %}">
    {% include_cached skip-links.html %}
    {% include_cached masthead.html %}

    <div class="initial-content">
      {{ content }}
      {% include after-content.html %}
    </div>

    {% if site.search == true %}
      <div class="search-content">
        {% include_cached search/search_form.html %}
      </div>
    {% endif %}

    <div id="footer" class="page__footer">
      <footer>
        {% include footer/custom.html %}
        {% include_cached footer.html %}
      </footer>
    </div>

    <div id="gamification-dashboard" class="gamification-dashboard">
    <div class="header" onclick="document.getElementById('game-content').classList.toggle('collapsed')">
        <span id="level-display">Level 0</span>
        <span class="daily-score-summary" id="daily-score-display">ä»Šæ—¥ç©åˆ†: 0 åˆ†</span>
        <span class="collapse-icon">â–¼</span>
    </div>
    
    <div id="game-content" class="content">
        
        <div class="score-row">
            <span id="total-score-display">ç¸½ç©åˆ†: 0 åˆ†</span>
        </div>

        <div class="progress-container">
            <div id="level-progress-bar" class="progress-bar"></div>
        </div>
        <div class="progress-text-row">
            <span class="level-label">å‡ç´šé€²åº¦</span>
            <span id="level-progress-text">(0 / 100)</span>
        </div>
        
        <div class="section-title">ğŸ† æˆ‘çš„å¾½ç« </div>
        <div id="achievement-list" class="achievement-list">
            </div>

    </div>
</div>

<div id="game-notification" class="game-notification">
    </div>

    {% include scripts.html %}

    <script type="module">
        import { initializeGamificationModule, addBlogScore } from '/assets/js/gamificationModule.js';
        
        // 1. åˆå§‹åŒ–æ¨¡çµ„ (æœƒè¼‰å…¥ç”¨æˆ¶ç‹€æ…‹ä¸¦æ›´æ–° UI å„€è¡¨æ¿)
        document.addEventListener('DOMContentLoaded', initializeGamificationModule);

        // 2. åŒ¯å‡º addBlogScore åˆ°å…¨å±€ windowï¼Œä¾›å¾ŒçºŒé module è…³æœ¬ä½¿ç”¨
        window.addBlogScore = addBlogScore;

        console.log("ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ–æ¨¡çµ„å·²åœ¨ Base Layout ä¸­å•Ÿå‹•ã€‚");
    </script>


    {% if page.path contains '_posts/' %}
    <script>
    // ===========================================
    // ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ– - é–±è®€è¨ˆåˆ†é‚è¼¯
    // æ¢ä»¶æª¢æŸ¥: é é¢è·¯å¾‘åŒ…å« '_posts/' (æ–‡ç« é é¢)
    // ===========================================

    // ç¾åœ¨ window.addBlogScore å·²ç¶“è¢«ä¸Šé¢çš„ module è…³æœ¬ç¢ºä¿å­˜åœ¨ï¼
    if (typeof window.addBlogScore === 'function') {
        
        // â­ï¸ é—œéµ 1: ç²å–ç•¶å‰æ–‡ç« çš„å”¯ä¸€ ID (ä½¿ç”¨ Liquid ç²å– Jekyll çš„ page.url)
        // ä½¿ç”¨ page.url ä½œç‚ºå”¯ä¸€ key æ˜¯æœ€å¥½çš„åšæ³•
        const currentArticleId = '{{ page.url }}'; 
        const READ_LOG_KEY = 'read_log';
        
        // â­ï¸ é—œéµ 2: è¼‰å…¥ä¸¦æª¢æŸ¥é–±è®€ç´€éŒ„
        let readLog = {};
        try {
            const savedLog = localStorage.getItem(READ_LOG_KEY);
            if (savedLog) {
                readLog = JSON.parse(savedLog);
            }
        } catch (e) {
            console.error("è¼‰å…¥é–±è®€ç´€éŒ„å¤±æ•—:", e);
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºé¦–æ¬¡é–±è®€ï¼ˆæ­¤ Session ä¸­æ˜¯å¦éœ€è¦è§¸ç™¼ blog_count å¢åŠ ï¼‰
        let isFirstReadSession = !readLog[currentArticleId];
        
        // â­ï¸ é—œéµ 3: é–±è®€è¨ˆåˆ†ä¸»é‚è¼¯ (æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡)
        let readTimerInterval = null;
        let secondsAccumulator = 0; // ç´¯ç©å™¨
        
        function trackReadingTime() {
            secondsAccumulator++;
            
            // æ¯ 60 ç§’è¨ˆåˆ†
            if (secondsAccumulator >= 60) {
                
                // å‘¼å« gamificationModule è£¡çš„è¨ˆåˆ†å‡½æ•¸ï¼Œä¸¦å‚³å…¥æ˜¯å¦ç‚ºé¦–æ¬¡é–±è®€çš„ç‹€æ…‹
                const success = window.addBlogScore(isFirstReadSession); // ğŸ‘ˆ ä½¿ç”¨ window ä¸Šçš„å‡½æ•¸
                
                // å°‡ç´¯ç©å™¨æ­¸é›¶ï¼Œæº–å‚™ä¸‹ä¸€æ¬¡è¨ˆåˆ†
                secondsAccumulator = 0;
                
                if (success) {
                    console.log(`é–±è®€è¨ˆåˆ†æˆåŠŸã€‚é¦–æ¬¡é–±è®€ç‹€æ…‹ (æ˜¯å¦å·²è¨ˆå…¥æ–‡ç« æ•¸): ${isFirstReadSession ? 'æ˜¯' : 'å¦'}`);
                    
                    // é¦–æ¬¡è¨ˆåˆ†æˆåŠŸå¾Œï¼Œæ›´æ–°é–±è®€ç´€éŒ„ä¸¦å„²å­˜ï¼Œç¢ºä¿æ–‡ç« ç¯‡æ•¸åªè¨ˆä¸€æ¬¡
                    if (isFirstReadSession) {
                        readLog[currentArticleId] = true;
                        localStorage.setItem(READ_LOG_KEY, JSON.stringify(readLog));
                        // â­ï¸ é—œéµä¿®æ­£ï¼šæœ¬æ¬¡æ–‡ç« çš„ã€Œæ–‡ç« ç¯‡æ•¸ã€å·²è¨ˆå…¥ï¼Œå°‡ç‹€æ…‹è¨­ç‚º false
                        isFirstReadSession = false; 
                    }
                } else {
                    console.log("é–±è®€ç©åˆ†å·²é”åˆ°æ¯æ—¥ä¸Šé™ï¼Œåœæ­¢è¨ˆæ™‚ã€‚");
                    // å¦‚æœé”åˆ°ä¸Šé™ï¼Œåœæ­¢è¨ˆæ™‚å™¨ä»¥ç¯€çœè³‡æº
                    stopTracking();
                }
            }
        }
        
        function startTracking() {
            if (readTimerInterval === null) {
                readTimerInterval = setInterval(trackReadingTime, 1000);
                console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²å•Ÿå‹•ã€‚");
            }
        }

        function stopTracking() {
            if (readTimerInterval !== null) {
                clearInterval(readTimerInterval);
                readTimerInterval = null;
                // æš«åœæ™‚ï¼Œå°‡ç´¯ç©çš„ç§’æ•¸æ¸…é›¶
                secondsAccumulator = 0;
                console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²åœæ­¢ï¼Œç´¯ç©ç§’æ•¸å·²æ¸…é›¶ã€‚");
            }
        }
        
        // ç›£è½ç¶²é å¯è¦‹æ€§
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                startTracking();
            } else {
                stopTracking();
            }
        });

        // é é¢è¼‰å…¥æ™‚å•Ÿå‹•è¨ˆæ™‚å™¨
        startTracking();
        
        // é¡å¤–è™•ç†ï¼šç•¶ç”¨æˆ¶é›¢é–‹é é¢æ™‚ï¼Œæ¸…é™¤è¨ˆæ™‚å™¨
        window.addEventListener('beforeunload', stopTracking);
        
    } else {
        // ç¾åœ¨é€™å€‹è­¦å‘Šæ‡‰è©²ä¸æœƒå†å‡ºç¾äº†ï¼
        console.warn("ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ–æ¨¡çµ„æœªå®Œå…¨è¼‰å…¥ã€‚æ–‡ç« è¨ˆåˆ†æœªå•Ÿå‹•ã€‚");
    }
    </script>
    {% endif %}

  </body>
</html>
