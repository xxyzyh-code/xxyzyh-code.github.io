---
---

<!doctype html>
{% include copyright.html %}
<html lang="{{ site.locale | replace: "_", "-" | default: "en" }}" class="no-js">
  <head>
    {% include head.html %}
    
    {% if page.permalink == '/music/' %}
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/custom_player.css">
    {% endif %}
    {% include head/custom.html %}
  </head>

  <body class="layout--{{ page.layout | default: layout.layout }}{% if page.classes or layout.classes %}{{ page.classes | default: layout.classes | join: ' ' | prepend: ' ' }}{% endif %}" dir="{% if site.rtl %}rtl{% else %}ltr{% endif %}">
    {% include_cached skip-links.html %}
    {% include_cached masthead.html %}

    <div class="initial-content">
      {{ content }}
      {% include after-content.html %}
    </div>

    {% if site.search == true %}
      <div class="search-content">
        {% include_cached search/search_form.html %}
      </div>
    {% endif %}

    <div id="footer" class="page__footer">
      <footer>
        {% include footer/custom.html %}
        {% include_cached footer.html %}
      </footer>
    </div>

    <div id="gamification-dashboard" class="gamification-dashboard">
    <div class="header" onclick="document.getElementById('game-content').classList.toggle('collapsed')">
        <span id="level-display">Level 0</span>
        <span class="daily-score-summary" id="daily-score-display">ä»Šæ—¥ç©åˆ†: 0 åˆ†</span>
        <span class="collapse-icon">â–¼</span>
    </div>
    
    <div id="game-content" class="content">
        
        <div class="score-row">
            <span id="total-score-display">ç¸½ç©åˆ†: 0 åˆ†</span>
        </div>

        <div class="progress-container">
            <div id="level-progress-bar" class="progress-bar"></div>
        </div>
        <div class="progress-text-row">
            <span class="level-label">å‡ç´šé€²åº¦</span>
            <span id="level-progress-text">(0 / 100)</span>
        </div>
        
        <div class="section-title">ğŸ† æˆ‘çš„å¾½ç« </div>
        <div id="achievement-list" class="achievement-list">
            </div>

    </div>
</div>

<div id="game-notification" class="game-notification">
    </div>
    {% include scripts.html %}

    <script type="module">
        import { initializeGamificationModule, addBlogScore } from '/assets/js/gamificationModule.js';
        
        // 1. åˆå§‹åŒ–æ¨¡çµ„ (å¿…é ˆå…ˆåŸ·è¡Œï¼Œæ‰èƒ½æ›´æ–° UI)
        document.addEventListener('DOMContentLoaded', initializeGamificationModule);

        // 2. åŒ¯å‡º addBlogScore åˆ°å…¨å±€ window (å¦‚æœå…¶ä»–åœ°æ–¹éœ€è¦ï¼Œä¿ç•™æ­¤è¡Œ)
        window.addBlogScore = addBlogScore;

        console.log("ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ–æ¨¡çµ„å·²åœ¨ Base Layout ä¸­å•Ÿå‹•ã€‚");

        // ===========================================
        // ç¨‹å¼å¤¥ä¼´: é–±è®€è¨ˆåˆ†é‚è¼¯ (ç¢ºä¿åœ¨æ¨¡çµ„ç’°å¢ƒä¸­å•Ÿå‹•)
        // æ¢ä»¶æª¢æŸ¥å¿…é ˆä½¿ç”¨ Liquid åˆ¤æ–·æ˜¯å¦ç‚ºæ–‡ç« é é¢
        // ===========================================
        
{% if (page.layout == "post" or page.layout == "single") and page.path contains '_posts/' %}
        
            // â­ï¸ ä¿®æ­£: æ‰€æœ‰è®Šæ•¸éƒ½å¿…é ˆåœ¨é ‚å±¤å®šç¾©ï¼Œæ‰èƒ½è¢«å¾ŒçºŒçš„å‡½æ•¸å­˜å– (Scope)
            const progressBar = document.getElementById('read-progress-bar');
            const progressText = document.getElementById('read-progress-text');
            const progressContainer = document.getElementById('read-progress-bar-container');
      
            // Liquid è®Šæ•¸ (åœ¨ç·¨è­¯æ™‚ç¢ºå®š)
            const currentArticleId = '{{ page.url }}'; 
            const READ_LOG_KEY = 'read_log';
            let readLog = {};
            
            try {
                const savedLog = localStorage.getItem(READ_LOG_KEY);
                if (savedLog) {
                    readLog = JSON.parse(savedLog);
                }
            } catch (e) {
                console.error("è¼‰å…¥é–±è®€ç´€éŒ„å¤±æ•—:", e);
            }
            
            // ç‹€æ…‹è®Šæ•¸
            let isFirstReadSession = !readLog[currentArticleId];
            let readTimerInterval = null;
            let secondsAccumulator = 0; 
            const SECONDS_PER_SCORE = 60; // æ¯ 60 ç§’è¨ˆåˆ†
            
            // ===========================================
            // å‡½æ•¸å®šç¾©
            // ===========================================
            
            // â­ï¸ æ›´æ–°é€²åº¦æ¢çš„å‡½æ•¸
            function updateProgressBar() {
                if (!progressBar) return;

                const progressPercent = (secondsAccumulator / SECONDS_PER_SCORE) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                const remainingSeconds = SECONDS_PER_SCORE - secondsAccumulator;
                progressText.textContent = `è·é›¢ä¸‹æ¬¡ç©åˆ†ï¼š${remainingSeconds} ç§’`;
            }
            
            function trackReadingTime() {
                secondsAccumulator++;
                
                // â­ï¸ é—œéµï¼šæ¯ç§’æ›´æ–°é€²åº¦æ¢
                updateProgressBar();

                if (secondsAccumulator >= SECONDS_PER_SCORE) {
                    
                    const success = addBlogScore(isFirstReadSession); 
                    secondsAccumulator = 0; // é‡ç½®è¨ˆæ•¸å™¨
                    
                    if (success) {
                        console.log(`é–±è®€è¨ˆåˆ†æˆåŠŸã€‚é¦–æ¬¡é–±è®€ç‹€æ…‹ (æ˜¯å¦å·²è¨ˆå…¥æ–‡ç« æ•¸): ${isFirstReadSession ? 'æ˜¯' : 'å¦'}`);
                        // â­ï¸ é‡ç½®é€²åº¦æ¢
                        updateProgressBar(); 
                        
                        if (isFirstReadSession) {
                            readLog[currentArticleId] = true;
                            localStorage.setItem(READ_LOG_KEY, JSON.stringify(readLog));
                            isFirstReadSession = false; 
                        }
                    } else {
                        console.log("é–±è®€ç©åˆ†å·²é”åˆ°æ¯æ—¥ä¸Šé™ï¼Œåœæ­¢è¨ˆæ™‚ã€‚");
                        stopTracking();
                        
                        // â­ï¸ é”åˆ°ä¸Šé™æ™‚æ›´æ–° UI ç‹€æ…‹
                        progressBar.style.width = '100%';
                        progressText.textContent = 'ä»Šæ—¥é–±è®€ç©åˆ†å·²é”ä¸Šé™ï¼';
                        progressContainer.classList.add('limit-reached');
                    }
                }
            }
            
            function startTracking() {
                if (readTimerInterval === null) {
                    // â­ï¸ ç¢ºä¿å•Ÿå‹•æ™‚å…ˆå‘¼å«ä¸€æ¬¡ï¼Œä»¥é¡¯ç¤ºåˆå§‹ç‹€æ…‹
                    updateProgressBar(); 
                    readTimerInterval = setInterval(trackReadingTime, 1000);
                    console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²å•Ÿå‹•ã€‚");
                }
            }

            function stopTracking() {
                if (readTimerInterval !== null) {
                    clearInterval(readTimerInterval);
                    readTimerInterval = null;
                    secondsAccumulator = 0;
                    // â­ï¸ æš«åœæ™‚é‡ç½®é€²åº¦æ¢ï¼Œé¿å…åˆ‡æ›æ¨™ç±¤é å›ä¾†æ™‚å¯¬åº¦çªè®Š
                    updateProgressBar(); 
                    console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²åœæ­¢ï¼Œç´¯ç©ç§’æ•¸å·²æ¸…é›¶ã€‚");
                }
            }
            
            // ===========================================
            // å•Ÿå‹•é‚è¼¯
            // ===========================================
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    startTracking();
                } else {
                    stopTracking();
                }
            });

            startTracking();
            window.addEventListener('beforeunload', stopTracking);
            
        {% endif %}

        
    </script>
        
{% if (page.layout == "post" or page.layout == "single") and page.path contains '_posts/' %}
    
    <div id="read-progress-bar-container">
        <div id="read-progress-bar"></div>
        <div id="read-progress-text"></div>
    </div>

    <style>
        /* CSS: é€²åº¦æ¢æ¨£å¼ */
        #read-progress-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px; /* å®¹å™¨é«˜åº¦ */
            background-color: #333; /* èƒŒæ™¯è‰² */
            z-index: 1000; /* ç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        #read-progress-bar {
            height: 100%;
            width: 0%; /* åˆå§‹å¯¬åº¦ç‚º 0 */
            background-color: #4CAF50; /* é€²åº¦æ¢é¡è‰² (ç¶ è‰²) */
            transition: width 1s linear; /* å¹³æ»‘éæ¸¡å‹•ç•« */
        }
        
        #read-progress-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        /* ç•¶é”åˆ°æ¯æ—¥ä¸Šé™æ™‚çš„æ¨£å¼ */
        .limit-reached #read-progress-bar {
            background-color: #e57373 !important; /* è®Šç‚ºç´…è‰² */
        }
    </style>
    {% endif %}

  </body>
</html>
