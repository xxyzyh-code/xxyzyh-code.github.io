---
---

<!doctype html>
{% include copyright.html %}
<html lang="{{ site.locale | replace: "_", "-" | default: "en" }}" class="no-js">
  <head>
    {% include head.html %}

    <link rel="manifest" href="/manifest.json"> 
    <meta name="theme-color" content="#333333">
    <link rel="apple-touch-icon" href="/assets/images/avatar-192.png">

    {% if page.permalink == '/music/' %}
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/custom_player.css">
    {% endif %}
    {% include head/custom.html %}
  </head>

  <body class="layout--{{ page.layout | default: layout.layout }}{% if page.classes or layout.classes %}{{ page.classes | default: layout.classes | join: ' ' | prepend: ' ' }}{% endif %}" dir="{% if site.rtl %}rtl{% else %}ltr{% endif %}">
    {% include_cached skip-links.html %}
    {% include_cached masthead.html %}

    <div class="initial-content">
      {{ content }}
      {% include after-content.html %}
    </div>

    {% if site.search == true %}
      <div class="search-content">
        {% include_cached search/search_form.html %}
      </div>
    {% endif %}

<!-- é¡µè„šå®¹å™¨ä»ä¿ç•™ Liquidï¼Œä½† JS ä¼šåŠ¨æ€ç§»é™¤ -->
<div id="footer" class="page__footer">
  <footer>
    {% include footer/custom.html %}
    {% include_cached footer.html %}
  </footer>
</div>

<!-- åŠ¨æ€ç§»é™¤é¡µè„šå— -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const footerContainer = document.getElementById('footer') || document.querySelector('.site-footer');
    if (footerContainer) {
      footerContainer.remove();

      // æ–°å»ºç©ºå ä½ div
      const placeholder = document.createElement('div');
      placeholder.id = 'footer-placeholder';
      placeholder.style.height = '80px'; // å ä½é«˜åº¦
      placeholder.style.background = 'transparent';
      document.body.appendChild(placeholder);
    }
  });
</script>
    
<div id="gamification-dashboard" class="gamification-dashboard">
    <div class="header" id="game-header-toggle">
        <span id="level-display"></span>  
        <span class="daily-score-summary" id="daily-score-summary-header"></span> 
        <span class="collapse-icon" id="game-collapse-icon">â–¼</span>
    </div>
    
    <div id="game-content" class="content">
        
        <div id="daily-log-display" class="score-row daily-score-log-row">
            </div>

        <div class="score-row">
            <span id="total-score-display"></span> </div>

        <div class="progress-container">
            <div id="level-progress-bar" class="progress-bar"></div>
        </div>
        <div class="progress-text-row">
            <span class="level-label">å‡ç´šé€²åº¦</span>
            <span id="level-progress-text"></span> </div>
        
        <div class="section-title">
            ğŸ† æˆ‘çš„å¾½ç«  
            <span id="achievement-progress-text" style="font-size: 0.9em; font-weight: normal; color: #ff9800;"></span> </div>
        <div id="achievement-list" class="achievement-list">
        </div>
    </div>
</div>
    
<button id="install-btn" style="
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 10px 16px;
  background-color: #ff9800; /* èˆ‡æ‚¨çš„ç°½åˆ°æŒ‰éˆ•é¡è‰²ä¸€è‡´ */
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  z-index: 9999;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
">
  å®‰è£åšå®¢ App
</button>
    
<div id="game-notification" class="game-notification">
    </div>
    {% include scripts.html %}

    <script type="module">
        import { 
            initializeGamificationModule, 
            addBlogScore, 
            getCheckInStatus, 
            addCheckInScore 
        } from '/assets/js/gamificationModule.js';
        
        // 1. åˆå§‹åŒ–æ¨¡çµ„ (ä¿æŒä¸è®Š)
        document.addEventListener('DOMContentLoaded', initializeGamificationModule);

        // 2. åŒ¯å‡º addBlogScore åˆ°å…¨å±€ window (ä¿æŒä¸è®Š)
        window.addBlogScore = addBlogScore;

        console.log("ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ–æ¨¡çµ„å·²åœ¨ Base Layout ä¸­å•Ÿå‹•ã€‚");
        
        //===========================================
        // ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ–å„€è¡¨æ¿å±•é–‹/æ”¶èµ·èˆ‡ç‹€æ…‹ä¿å­˜é‚è¼¯ (START)
        // ===========================================
        document.addEventListener('DOMContentLoaded', () => {
            const headerToggle = document.getElementById('game-header-toggle');
            const content = document.getElementById('game-content');
            const collapseIcon = document.getElementById('game-collapse-icon');
            
            const STATE_KEY = 'gamification_dashboard_state'; // ğŸ¯ æ–°å¢: LocalStorage éµå€¼
            
            if (headerToggle && content && collapseIcon) {
                
                // --- 1. è¼‰å…¥ç‹€æ…‹ (Persistence Check) ---
                const savedState = localStorage.getItem(STATE_KEY);
                
                // å¦‚æœ localStorage è¨˜éŒ„äº† 'collapsed' ç‹€æ…‹ï¼Œå‰‡åœ¨è¼‰å…¥æ™‚æ‡‰ç”¨å®ƒ
                if (savedState === 'collapsed') {
                    content.classList.add('collapsed'); 
                    collapseIcon.classList.add('rotated'); 
                } 
                // å¦å‰‡ï¼Œå®ƒæœƒç¶­æŒé è¨­çš„å±•é–‹ç‹€æ…‹ (ç„¡ class)

                // --- 2. é»æ“Šé‚è¼¯ (Toggle and Save) ---
                headerToggle.addEventListener('click', () => {
                    // 1. åˆ‡æ›å…§å®¹å€å¡Šçš„ 'collapsed' é¡åˆ¥
                    content.classList.toggle('collapsed');
                    
                    // 2. æ ¹æ“šå…§å®¹å€å¡Šçš„æ–°ç‹€æ…‹ï¼Œåˆ‡æ›åœ–ç¤ºçš„ 'rotated' é¡åˆ¥
                    const isCollapsed = content.classList.contains('collapsed');

                    if (isCollapsed) {
                        collapseIcon.classList.add('rotated');
                        // 3. å„²å­˜æ–°ç‹€æ…‹åˆ° LocalStorage
                        localStorage.setItem(STATE_KEY, 'collapsed');
                    } else {
                        collapseIcon.classList.remove('rotated');
                        // 3. å„²å­˜æ–°ç‹€æ…‹åˆ° LocalStorage
                        localStorage.setItem(STATE_KEY, 'expanded');
                    }
                });
            }
        });
      
        function setupCheckInModal() {
            // å»¶é²åŸ·è¡Œç¢ºä¿æ•¸æ“šæ¨¡å‹å·²å¾ LocalStorage è¼‰å…¥
            setTimeout(() => {
                
                const modal = document.getElementById('checkin-modal');
                const closeBtn = document.querySelector('#checkin-modal .close-btn');
                const checkinBtn = document.getElementById('checkin-button');
                const messageEl = document.getElementById('checkin-message');
                const daysDisplayEl = document.getElementById('consecutive-days-display');
                
                // ç²å–ç•¶å‰ç°½åˆ°ç‹€æ…‹
                const status = getCheckInStatus();
                
                daysDisplayEl.textContent = status.consecutiveDays;
                
                if (status.canCheckIn) {
                    // é¡¯ç¤ºç°½åˆ°è¨Šæ¯
                    messageEl.innerHTML = `ä»Šå¤©æ˜¯ä½ é€£çºŒé—œæ³¨æˆ‘çš„åšå®¢ç¶²ç«™çš„ç¬¬ **${status.consecutiveDays}** å¤©ï¼Œ<br>é»æ“ŠæŒ‰éˆ•é ˜å–ä»Šæ—¥çå‹µ **${status.score}** ç©åˆ†ï¼`;
                    checkinBtn.textContent = `é»æ“Šç°½åˆ° (${status.score} ç©åˆ†)`;
                    modal.style.display = 'block'; // é¡¯ç¤ºå½ˆçª—
                } else {
                    // å·²ç¶“ç°½åˆ°ï¼Œä¸é¡¯ç¤º Modal
                    modal.style.display = 'none';
                }
            
                // è™•ç†ç°½åˆ°æŒ‰éˆ•é»æ“Š
                checkinBtn.onclick = () => {
                    const success = addCheckInScore();
                    if (success) {
                        modal.style.display = 'none';
                        // ç¢ºä¿ç°½åˆ°æˆåŠŸå¾Œï¼Œdashboard çš„ç©åˆ†ç«‹åˆ»æ›´æ–°
                        // (é›–ç„¶ addCheckInScore å…§éƒ¨å·²å‘¼å« updateUIï¼Œä½†ä¿éšªèµ·è¦‹ä¿ç•™)
                        // updateUI() - ç„¡éœ€æ‰‹å‹•å‘¼å«ï¼Œå› ç‚ºå®ƒä¸åœ¨é€™å€‹ Module çš„ Scope å…§
                    }
                };
                
                // è™•ç†é—œé–‰æŒ‰éˆ•
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                };

                // é»æ“Š Modal å¤–éƒ¨ä¹Ÿé—œé–‰
                window.onclick = (event) => {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
            }, 500); // å»¶é² 500ms ç¢ºä¿æ•¸æ“šæ¨¡å‹å·²è¼‰å…¥
        }

        // ç¢ºä¿ DOM è¼‰å…¥å¾Œæ‰è¨­ç½® Modal
        document.addEventListener('DOMContentLoaded', setupCheckInModal);
        // ===========================================
        // ç¨‹å¼å¤¥ä¼´: é–±è®€è¨ˆåˆ†é‚è¼¯ (ç¢ºä¿åœ¨æ¨¡çµ„ç’°å¢ƒä¸­å•Ÿå‹•)
        // æ¢ä»¶æª¢æŸ¥å¿…é ˆä½¿ç”¨ Liquid åˆ¤æ–·æ˜¯å¦ç‚ºæ–‡ç« é é¢
        // ===========================================
        
{% if (page.layout == "post" or page.layout == "single") and page.path contains '_posts/' %}
        
            // â­ï¸ ä¿®æ­£: æ‰€æœ‰è®Šæ•¸éƒ½å¿…é ˆåœ¨é ‚å±¤å®šç¾©ï¼Œæ‰èƒ½è¢«å¾ŒçºŒçš„å‡½æ•¸å­˜å– (Scope)
            const progressBar = document.getElementById('read-progress-bar');
            const progressText = document.getElementById('read-progress-text');
            const progressContainer = document.getElementById('read-progress-bar-container');
      
            // Liquid è®Šæ•¸ (åœ¨ç·¨è­¯æ™‚ç¢ºå®š)
            const currentArticleId = '{{ page.url }}'; 
            const READ_LOG_KEY = 'read_log';
            let readLog = {};
            
            try {
                const savedLog = localStorage.getItem(READ_LOG_KEY);
                if (savedLog) {
                    readLog = JSON.parse(savedLog);
                }
            } catch (e) {
                console.error("è¼‰å…¥é–±è®€ç´€éŒ„å¤±æ•—:", e);
            }
            
            // ç‹€æ…‹è®Šæ•¸
            let isFirstReadSession = !readLog[currentArticleId];
            let readTimerInterval = null;
            let secondsAccumulator = 0; 
            const SECONDS_PER_SCORE = 60; // æ¯ 60 ç§’è¨ˆåˆ†
            
            // ===========================================
            // å‡½æ•¸å®šç¾©
            // ===========================================
            
            // â­ï¸ æ›´æ–°é€²åº¦æ¢çš„å‡½æ•¸
            function updateProgressBar() {
                if (!progressBar) return;

                const progressPercent = (secondsAccumulator / SECONDS_PER_SCORE) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                const remainingSeconds = SECONDS_PER_SCORE - secondsAccumulator;
                progressText.textContent = `è·é›¢ä¸‹æ¬¡ç©åˆ†ï¼š${remainingSeconds} ç§’`;
            }
            
            function trackReadingTime() {
                secondsAccumulator++;
                
                // â­ï¸ é—œéµï¼šæ¯ç§’æ›´æ–°é€²åº¦æ¢
                updateProgressBar();

                if (secondsAccumulator >= SECONDS_PER_SCORE) {
                    
                    const success = addBlogScore(isFirstReadSession); 
                    secondsAccumulator = 0; // é‡ç½®è¨ˆæ•¸å™¨
                    
                    if (success) {
                        console.log(`é–±è®€è¨ˆåˆ†æˆåŠŸã€‚é¦–æ¬¡é–±è®€ç‹€æ…‹ (æ˜¯å¦å·²è¨ˆå…¥æ–‡ç« æ•¸): ${isFirstReadSession ? 'æ˜¯' : 'å¦'}`);
                        // â­ï¸ é‡ç½®é€²åº¦æ¢
                        updateProgressBar(); 
                        
                        if (isFirstReadSession) {
                            readLog[currentArticleId] = true;
                            localStorage.setItem(READ_LOG_KEY, JSON.stringify(readLog));
                            isFirstReadSession = false; 
                        }
                    } else {
                        console.log("é–±è®€ç©åˆ†å·²é”åˆ°æ¯æ—¥ä¸Šé™ï¼Œåœæ­¢è¨ˆæ™‚ã€‚");
                        stopTracking();
                        
                        // â­ï¸ é”åˆ°ä¸Šé™æ™‚æ›´æ–° UI ç‹€æ…‹
                        progressBar.style.width = '100%';
                        progressText.textContent = 'ä»Šæ—¥é–±è®€ç©åˆ†å·²é”ä¸Šé™ï¼';
                        progressContainer.classList.add('limit-reached');
                    }
                }
            }
            
            function startTracking() {
                if (readTimerInterval === null) {
                    // â­ï¸ ç¢ºä¿å•Ÿå‹•æ™‚å…ˆå‘¼å«ä¸€æ¬¡ï¼Œä»¥é¡¯ç¤ºåˆå§‹ç‹€æ…‹
                    updateProgressBar(); 
                    readTimerInterval = setInterval(trackReadingTime, 1000);
                    console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²å•Ÿå‹•ã€‚");
                }
            }

            function stopTracking() {
                if (readTimerInterval !== null) {
                    clearInterval(readTimerInterval);
                    readTimerInterval = null;
                    secondsAccumulator = 0;
                    // â­ï¸ æš«åœæ™‚é‡ç½®é€²åº¦æ¢ï¼Œé¿å…åˆ‡æ›æ¨™ç±¤é å›ä¾†æ™‚å¯¬åº¦çªè®Š
                    updateProgressBar(); 
                    console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²åœæ­¢ï¼Œç´¯ç©ç§’æ•¸å·²æ¸…é›¶ã€‚");
                }
            }
            
            // ===========================================
            // å•Ÿå‹•é‚è¼¯
            // ===========================================
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    startTracking();
                } else {
                    stopTracking();
                }
            });

            startTracking();
            window.addEventListener('beforeunload', stopTracking);
            
        {% endif %}

        
    </script>

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => console.log('SW è¨»å†ŠæˆåŠŸ:', reg.scope))
                .catch(err => console.log('SW è¨»å†Šå¤±æ•—:', err));
        });
    }
</script>

    <script>
    // PWA å®‰è£æç¤ºé‚è¼¯
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
        // é˜»æ­¢ Chrome/Edge/Firefox è‡ªå‹•å½ˆå‡ºæç¤º
        e.preventDefault(); 
        
        // å„²å­˜äº‹ä»¶ï¼Œä»¥ä¾¿ç¨å¾Œæ‰‹å‹•è§¸ç™¼å®‰è£
        deferredPrompt = e;
        
        // é¡¯ç¤ºæˆ‘å€‘è‡ªå®šç¾©çš„å®‰è£æŒ‰éˆ•
        if(installBtn) {
            installBtn.style.display = 'block'; 
        }
        console.log("PWA: ç™¼ç¾å¯å®‰è£ç‹€æ…‹ï¼Œé¡¯ç¤ºå®‰è£æŒ‰éˆ•ã€‚");
    });

    if(installBtn) {
        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none'; // éš±è—æŒ‰éˆ•
            
            if (deferredPrompt) {
                deferredPrompt.prompt(); // å½ˆå‡ºç€è¦½å™¨åŸç”Ÿçš„å®‰è£æç¤º

                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('ç”¨æˆ¶æ¥å—å®‰è£ PWA');
                    } else {
                        console.log('ç”¨æˆ¶æ‹’çµ•å®‰è£ PWA');
                    }
                    deferredPrompt = null;
                });
            }
        });
    }
</script>

    
{% if (page.layout == "post" or page.layout == "single") and page.path contains '_posts/' %}
    
    <div id="read-progress-bar-container">
        <div id="read-progress-bar"></div>
        <div id="read-progress-text"></div>
    </div>

    <style>
        /* CSS: é€²åº¦æ¢æ¨£å¼ */
        #read-progress-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 8px; /* å®¹å™¨é«˜åº¦ */
            background-color: #333; /* èƒŒæ™¯è‰² */
            z-index: 1000; /* ç¢ºä¿å®ƒåœ¨æœ€ä¸Šå±¤ */
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        #read-progress-bar {
            height: 100%;
            width: 0%; /* åˆå§‹å¯¬åº¦ç‚º 0 */
            background-color: #4CAF50; /* é€²åº¦æ¢é¡è‰² (ç¶ è‰²) */
            transition: width 1s linear; /* å¹³æ»‘éæ¸¡å‹•ç•« */
        }
        
        #read-progress-text {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }
        
        /* ç•¶é”åˆ°æ¯æ—¥ä¸Šé™æ™‚çš„æ¨£å¼ */
        .limit-reached #read-progress-bar {
            background-color: #e57373 !important; /* è®Šç‚ºç´…è‰² */
        }
    </style>
    {% endif %}

    <div id="checkin-modal" class="checkin-modal">
        <div class="checkin-content">
            <span class="close-btn">&times;</span>
            <h3 id="checkin-title">ğŸ“… æ¯æ—¥ç°½åˆ°çå‹µ</h3>
            <p id="checkin-message"></p>
            <button id="checkin-button" class="checkin-btn">é»æ“Šç°½åˆ°</button>
            <p class="consecutive-info">ğŸ”¥ é€£çºŒç°½åˆ°å¤©æ•¸: <span id="consecutive-days-display">0</span> å¤©</p>
        </div>
    </div>

    <style>
    /* CSS for the Check-in Modal */
    .checkin-modal {
        display: none; /* é è¨­éš±è— */
        position: fixed;
        z-index: 2000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6); /* åŠé€æ˜èƒŒæ™¯ */
    }

    .checkin-content {
        background-color: #fefefe;
        margin: 15% auto; /* ç½®ä¸­ */
        padding: 25px;
        border: 1px solid #888;
        width: 80%; /* å¯¬åº¦ */
        max-width: 400px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        text-align: center;
        line-height: 1.5; /* ç¢ºä¿è¨Šæ¯æ›´æ˜“è®€ */
    }

    .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }

    .checkin-btn {
        background-color: #ff9800; /* æ©™è‰² */
        color: white;
        padding: 10px 20px;
        margin: 10px 0;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    .checkin-btn:hover {
        background-color: #e68900;
    }

    .checkin-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .consecutive-info {
        font-size: 14px;
        color: #666;
    }
          /* ğŸ¯ æ–°å¢/ä¿®æ­£ï¼šéŠæˆ²åŒ–å„€è¡¨æ¿çš„æŠ˜ç–Šåœ–æ¨™æ¨£å¼ */
    .gamification-dashboard .header {
        cursor: pointer; /* è®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é»æ“Š */
        user-select: none;
    }

    .gamification-dashboard .collapse-icon {
        display: inline-block;
        transition: transform 0.2s ease-in-out; /* å¹³æ»‘éæ¸¡ */
        transform: rotate(0deg); /* é è¨­ â–¼ (å‘ä¸‹å±•é–‹) */
    }

    /* ç•¶å…§å®¹æ”¶èµ·æ™‚ï¼Œåœ–æ¨™æ—‹è½‰ 180 åº¦ (è®Šæˆ â–²ï¼ŒæŒ‡å‘ä¸Šæ–¹) */
    .gamification-dashboard .collapse-icon.rotated {
        transform: rotate(180deg); 
    }
    
    /* å…§å®¹å€å¡Šçš„æ”¶èµ·æ¨£å¼ï¼Œç¢ºä¿éš±è— */
    #game-content.collapsed {
        display: none !important; /* ç¢ºä¿æ”¶èµ·æ™‚å…§å®¹æ¶ˆå¤± */
    }

    </style>

  </body>
</html>
